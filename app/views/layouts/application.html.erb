<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Streetwatch" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Streetwatch">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Streetwatch — BMX film archive, rider profiles, and clips hub.">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= javascript_importmap_tags %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%#= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <%# Video.js for video playback %>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

    <style>
      <% theme = user_theme_styles %>
      :root {
        --bg: <%= theme[:bg] %>;
        --panel: <%= theme[:panel] %>;
        --text: <%= theme[:text] %>;
        --muted: <%= theme[:muted] %>;
        --accent: <%= theme[:accent] %>;
        --accent-2: <%= theme[:accent_2] %>;
        --border: <%= theme[:border] %>;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 20% 15%, <%= theme[:body_bg_1] %>, transparent 38%),
          radial-gradient(circle at 80% 10%, <%= theme[:body_bg_2] %>, transparent 32%),
          <%= theme[:body_bg_base] %>;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }
      /* Film dust / scratches overlay */
      body::before {
        content: "";
        pointer-events: none;
        position: fixed;
        inset: 0;
        background:
          radial-gradient(circle, rgba(255,255,255,0.04) 0.5px, transparent 1px) 0 0/8px 8px,
          radial-gradient(circle, rgba(255,255,255,0.03) 0.7px, transparent 1px) 2px 2px/10px 10px,
          linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px) 0 0/140px 100%,
          linear-gradient(180deg, rgba(255,255,255,0.02) 1px, transparent 1px) 0 0/100% 160px;
        mix-blend-mode: screen;
        opacity: 0.22;
      }
      a { color: inherit; text-decoration: none; }
      .shell {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 18px;
      }
      .breadcrumbs {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px 18px 0;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--muted);
      }
      .breadcrumbs a {
        color: var(--muted);
        text-decoration: none;
        transition: color 0.15s ease;
      }
      .breadcrumbs a:hover {
        color: var(--accent);
      }
      .breadcrumbs .separator {
        color: var(--border);
      }
      .breadcrumbs .current {
        color: var(--text);
        font-weight: 600;
      }
      .nav {
        position: sticky;
        top: 0;
        z-index: 200;
        background: <%= theme[:nav_bg] %>;
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
      }
      .nav-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 60px;
        gap: 20px;
      }
      .sidebar-toggle-nav {
        background: none;
        border: none;
        color: var(--text);
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        border-radius: 6px;
        margin-right: 8px;
        position: relative;
        z-index: 200;
      }
      .sidebar-toggle-nav:hover {
        background: rgba(255,255,255,0.08);
      }
      .brand {
        display: flex;
        align-items: center;
        font-weight: 800;
        letter-spacing: 0.08em;
        font-size: 15px;
        margin-left: 6px;
      }
      .brand-logo {
        height: 28px;
        width: auto;
        filter: drop-shadow(0 0 8px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.4))
                drop-shadow(0 0 12px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.2));
        transition: filter 0.3s ease;
      }
      .brand-logo:hover {
        filter: drop-shadow(0 0 12px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.6))
                drop-shadow(0 0 16px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.3));
      }
      .nav-links {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        justify-content: center;
      }
      .nav-link {
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        color: var(--muted);
        transition: all 0.15s ease;
      }
      .nav-link:hover {
        color: var(--text);
        background: rgba(255,255,255,0.06);
      }
      .nav-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }
      .pill-btn {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-weight: 600;
        font-size: 14px;
        transition: all 0.15s ease;
      }
      .pill-btn.primary {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: <%= user_theme_styles[:theme_name] == 'light' ? 'white' : '#0b0b0d' %>;
        border-color: <%= user_theme_styles[:theme_name] == 'light' ? 'transparent' : 'rgba(255,255,255,0.1)' %>;
      }
      .pill-btn:hover { transform: translateY(-1px); }

      .hero {
        text-align: center;
        padding: 72px 0 36px;
        display: grid;
        gap: 10px;
      }
      .hero h1 {
        margin: 0;
        font-size: clamp(32px, 5vw, 44px);
        letter-spacing: 0.01em;
      }
      .hero-logo {
        width: 100%;
        max-width: 450px;
        height: auto;
        margin: 0 auto;
        filter: drop-shadow(0 0 8px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.5))
                drop-shadow(0 0 12px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.3))
                drop-shadow(0 0 18px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.2));
        transition: filter 0.4s ease;
      }
      .hero-logo:hover {
        filter: drop-shadow(0 0 16px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.7))
                drop-shadow(0 0 24px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.4))
                drop-shadow(0 0 36px hsla(<%= theme[:accent_hue] || 145 %>, 70%, 60%, 0.25));
      }
      .hero .sub {
        color: var(--muted);
        margin: 0;
        font-size: 16px;
      }
      .cta-row {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
      }
      .cta-tile:nth-child(1) {
        grid-column: 1 / 3;
      }
      .cta-tile:nth-child(2) {
        grid-column: 3 / 5;
      }
      .cta-tile:nth-child(3) {
        grid-column: 5 / 7;
      }
      .cta-tile:nth-child(4) {
        grid-column: 2 / 4;
      }
      .cta-tile:nth-child(5) {
        grid-column: 4 / 6;
      }
      @media (max-width: 768px) {
        .cta-row {
          grid-template-columns: 1fr;
        }
        .cta-tile:nth-child(1),
        .cta-tile:nth-child(2),
        .cta-tile:nth-child(3),
        .cta-tile:nth-child(4),
        .cta-tile:nth-child(5) {
          grid-column: 1 / -1;
        }
      }
      .cta-tile {
        padding: 16px 32px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        font-weight: 700;
        font-size: 16px;
        letter-spacing: 0.02em;
        transition: all 0.16s ease;
      }
      .cta-tile:hover {
        transform: translateY(-2px);
        border-color: rgba(255,255,255,0.2);
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      }
      .cta-tile:nth-child(1) { background: linear-gradient(135deg, <%= theme[:gradient_1] %>, <%= theme[:gradient_2] %>); }
      .cta-tile:nth-child(2) { background: linear-gradient(135deg, <%= theme[:gradient_2] %>, <%= theme[:gradient_1].sub('0.28', '0.26') %>); }
      .cta-tile:nth-child(3) { background: linear-gradient(135deg, <%= theme[:gradient_1].sub('0.28', '0.22') %>, <%= theme[:gradient_2].sub('0.35', '0.32') %>); }
      .cta-tile:nth-child(4) { background: linear-gradient(135deg, <%= theme[:gradient_1].sub('0.28', '0.22') %>, <%= theme[:gradient_2].sub('0.35', '0.32') %>); }
      .cta-tile:nth-child(5) { background: linear-gradient(135deg, <%= theme[:gradient_2].sub('0.35', '0.30') %>, <%= theme[:gradient_1].sub('0.28', '0.24') %>); }

      .dropdown {
        position: relative;
        display: block;
        margin: 14px auto 0;
        width: 260px;
      }
      .dropdown summary {
        list-style: none;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        font-weight: 600;
        font-size: 14px;
        background: rgba(255,255,255,0.04);
        transition: all 0.15s ease;
        width: 100%;
        text-align: center;
      }
      .dropdown summary::-webkit-details-marker { display: none; }
      .dropdown[open] summary {
        color: var(--text);
        border-color: rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.06);
      }
      .dropdown-menu {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 8px;
        min-width: 220px;
        background: <%= theme[:theme_name] == 'light' ? 'rgba(255,255,255,0.98)' : '#111015' %>;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        padding: 12px;
        display: grid;
        gap: 10px;
        z-index: 20;
      }
      .dropdown a {
        display: block;
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(255,255,255,0.04);
        border: 1px solid var(--border);
        font-weight: 600;
        transition: all 0.12s ease;
      }
      .dropdown a:hover {
        border-color: rgba(255,255,255,0.2);
      }

      .activity-dropdown {
        position: relative;
      }
      .activity-btn {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-weight: 600;
        font-size: 14px;
        transition: all 0.15s ease;
        background: rgba(255,255,255,0.04);
        color: var(--muted);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        position: relative;
      }
      .activity-btn:hover {
        color: var(--text);
        background: rgba(255,255,255,0.08);
        transform: translateY(-1px);
      }
      .activity-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: var(--accent);
        color: #0b0b0d;
        border-radius: 999px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        text-align: center;
      }
      .activity-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 8px);
        min-width: 350px;
        max-width: 400px;
        background: <%= theme[:theme_name] == 'light' ? 'rgba(255,255,255,0.98)' : '#111015' %>;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        padding: 12px;
        display: none;
        z-index: 200;
        max-height: 500px;
        overflow-y: auto;
      }
      .activity-menu.open {
        display: block;
      }
      .activity-header {
        font-weight: 700;
        font-size: 14px;
        color: var(--text);
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .mark-read-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .mark-read-btn:hover {
        background: rgba(255,255,255,0.15);
        border-color: var(--accent);
      }
      .activity-item {
        padding: 12px;
        border-radius: 10px;
        background: rgba(255,255,255,0.04);
        border: 1px solid var(--border);
        margin-bottom: 8px;
        transition: all 0.12s ease;
        display: block;
      }
      .activity-item:last-child {
        margin-bottom: 0;
      }
      .activity-item:hover {
        border-color: rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.06);
      }
      .activity-item-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
        margin-bottom: 4px;
      }
      .activity-item-desc {
        font-size: 13px;
        color: var(--muted);
        line-height: 1.4;
      }
      .activity-item-time {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .activity-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted);
        font-size: 14px;
      }
      .expand-notifications-btn {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .expand-notifications-btn:hover {
        background: rgba(255,255,255,0.1);
        border-color: var(--accent);
      }
      .activity-item.unread {
        background: rgba(var(--accent-rgb), 0.08);
        border-color: rgba(var(--accent-rgb), 0.2);
      }
      .activity-type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
      }
      .activity-type-badge.approval {
        background: rgba(255, 165, 0, 0.2);
        border: 1px solid rgba(255, 165, 0, 0.3);
        color: hsl(39, 100%, 60%);
      }
      .activity-type-badge.notification {
        background: rgba(33, 150, 243, 0.2);
        border: 1px solid rgba(33, 150, 243, 0.3);
        color: hsl(210, 70%, 60%);
      }

      .flash-banner {
        background: rgba(120, 120, 125, 0.75);
        color: #f6f6f6;
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.15);
        font-weight: 600;
        text-align: center;
        min-width: 600px;
        max-width: 90vw;
        margin-top: 3em;
        box-shadow: 0 12px 30px rgba(0,0,0,0.35);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }

      @media (max-width: 640px) {
        .nav-inner {
          height: 60px;
          padding: 0;
          flex-wrap: nowrap;
          align-items: center;
          justify-content: center;
        }
        .brand {
          order: 1;
          margin-left: 0;
          align-self: center;
        }
        .brand-logo {
          height: 24px;
        }
        .nav-links {
          display: none;
        }
        .nav-actions {
          display: flex;
          gap: 8px;
        }
        .nav-actions .activity-dropdown {
          display: flex;
        }
        .nav-actions > *:not(.activity-dropdown) {
          display: none;
        }
        .activity-btn span:not(.activity-badge) {
          display: none;
        }
        .activity-btn {
          padding: 10px;
          min-width: auto;
        }
        .activity-menu {
          right: auto;
          left: 50%;
          transform: translateX(-50%);
          min-width: calc(100vw - 32px);
          max-width: calc(100vw - 32px);
        }
        .hero { padding: 56px 0 40px; }
        .hero-logo {
          max-width: 320px;
        }
      }

      /* Turbo Progress Bar - Hidden (using skeleton loader instead) */
      .turbo-progress-bar {
        display: none !important;
      }

      /* Global Search Bar */
      .global-search-container {
        width: 100%;
        padding: 0 18px 12px;
        position: relative;
        z-index: 10;
      }
      .global-search-wrapper {
        position: relative;
        max-width: 1100px;
        margin: 0 auto;
      }
      .global-search-input {
        width: 100%;
        padding: 12px 16px 12px 42px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s ease;
      }
      .global-search-input::placeholder {
        color: var(--muted);
        opacity: 0.7;
      }
      .global-search-input:focus {
        outline: none;
        border-color: color-mix(in srgb, var(--accent) 50%, transparent);
        background: rgba(255,255,255,0.06);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      .global-search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        pointer-events: none;
        font-size: 16px;
      }
      .global-search-results {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: <%= theme[:theme_name] == 'light' ? 'rgba(255,255,255,0.98)' : '#111015' %>;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        display: none;
        max-height: 500px;
        overflow-y: auto;
        z-index: 200;
      }
      .global-search-results.open {
        display: block;
      }
      .search-results-section {
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }
      .search-results-section:last-child {
        border-bottom: none;
      }
      .search-results-header {
        font-size: 12px;
        font-weight: 700;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
        padding: 0 8px;
      }
      .search-result-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--border);
        margin-bottom: 6px;
        transition: all 0.15s ease;
        cursor: pointer;
        text-decoration: none;
      }
      .search-result-item:last-child {
        margin-bottom: 0;
      }
      .search-result-item:hover {
        background: rgba(255,255,255,0.08);
        border-color: color-mix(in srgb, var(--accent) 50%, transparent);
        transform: translateX(2px);
      }
      .search-result-icon {
        flex-shrink: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        background: rgba(255,255,255,0.06);
        font-size: 16px;
      }
      .search-result-content {
        flex: 1;
        min-width: 0;
      }
      .search-result-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .search-result-meta {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }
      .search-result-badge {
        flex-shrink: 0;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }
      .search-result-badge.film {
        background: rgba(255, 99, 71, 0.2);
        border: 1px solid rgba(255, 99, 71, 0.3);
        color: hsl(9, 100%, 64%);
      }
      .search-result-badge.photo {
        background: rgba(147, 51, 234, 0.2);
        border: 1px solid rgba(147, 51, 234, 0.3);
        color: hsl(271, 81%, 56%);
      }
      .search-result-badge.user {
        background: rgba(34, 197, 94, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: hsl(142, 71%, 45%);
      }
      .search-result-badge.album {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: hsl(221, 91%, 60%);
      }
      .search-empty {
        padding: 40px 20px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }
      .search-loading {
        padding: 20px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }
      @media (max-width: 640px) {
        .global-search-container {
          padding: 0 12px 12px;
        }
        .global-search-results {
          max-height: 400px;
        }
      }
    </style>
  </head>

  <body data-csrf-token="<%= form_authenticity_token %>">
    <%= render 'shared/page_skeleton', type: 'films' %>

    <% if notice.present? || alert.present? %>
      <div id="flash-container" style="position: fixed; top: 12px; left: 0; right: 0; z-index: 1000; display: grid; gap: 8px; justify-content: center; pointer-events: none;">
        <% if notice.present? %>
          <div class="flash-banner"><%= notice %></div>
        <% end %>
        <% if alert.present? %>
          <div class="flash-banner"><%= alert %></div>
        <% end %>
      </div>
      <%# Auto-hide flash %>
      <script>
        const hideFlashes = () => {
          const flashes = document.querySelectorAll(".flash-banner");
          flashes.forEach((el) => {
            setTimeout(() => {
              el.style.opacity = "0";
              el.style.transform = "translateY(-4px)";
              setTimeout(() => {
                const container = document.getElementById("flash-container");
                el.remove();
                if (container && container.children.length === 0) container.remove();
              }, 300);
            }, 2500);
          });
        };
        document.addEventListener("DOMContentLoaded", hideFlashes);
        document.addEventListener("turbo:load", hideFlashes);
        document.addEventListener("turbo:render", hideFlashes);
      </script>
    <% end %>

    <div class="nav">
      <div class="shell nav-inner">
        <button type="button" class="sidebar-toggle-nav" onclick="toggleSidebar()" aria-label="Toggle menu">
          ☰
        </button>
        <a href="/" class="brand">
          <% logo_file = theme[:theme_name] == 'light' ? '/SW-LOGO-2025-BLACK.svg' : '/SW-LOGO-2025-WHITE.svg' %>
          <img src="<%= logo_file %>" alt="STREETWATCH" class="brand-logo">
        </a>
        <div class="nav-links">
          <%= link_to "Films", films_path, class: "nav-link" %>
          <%= link_to "Photos", photos_path, class: "nav-link" %>
          <%= link_to "Articles", articles_path, class: "nav-link" %>
          <%= link_to "Profiles", users_path, class: "nav-link" %>
          <%= link_to "Shop", shop_path, class: "nav-link" %>
        </div>
        <div class="nav-actions">
          <% if user_signed_in? %>
            <%
              pending_approvals_count = current_user.film_approvals.pending.count
              unread_notifications_count = current_user.notifications.where(read_at: nil).count
              total_activity_count = pending_approvals_count + unread_notifications_count
            %>
            <div class="activity-dropdown">
              <button type="button" class="activity-btn" id="activity-btn">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
                  <path d="M8 2C6.34 2 5 3.34 5 5V7.17L3.83 10H12.17L11 7.17V5C11 3.34 9.66 2 8 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9.5 10C9.5 10.83 8.83 11.5 8 11.5C7.17 11.5 6.5 10.83 6.5 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Activity</span>
                <% if total_activity_count > 0 %>
                  <span class="activity-badge"><%= total_activity_count %></span>
                <% end %>
              </button>
              <div class="activity-menu" id="activity-menu">
                <div class="activity-header">
                  <span>Recent Activity</span>
                  <% if unread_notifications_count > 0 %>
                    <button type="button" class="mark-read-btn" id="mark-read-btn" onclick="markNotificationsAsRead()">
                      Mark as Read
                    </button>
                  <% end %>
                </div>
                <%
                  # Fetch notifications for grouping
                  unread_notifications = current_user.notifications.where(read_at: nil).order(created_at: :desc).limit(5)
                  all_notifications = current_user.notifications.order(created_at: :desc).limit(20)
                  unread_grouped = group_notifications(unread_notifications)
                  all_grouped = group_notifications(all_notifications)
                  # Show expand button if there are any read notifications (not just unread)
                  has_more_notifications = current_user.notifications.where.not(read_at: nil).exists? || current_user.notifications.count > 5
                %>

                <div class="activity-content-compact" id="activity-content-compact">
                  <% if total_activity_count > 0 %>
                    <% if pending_approvals_count > 0 %>
                      <% current_user.film_approvals.pending.includes(:film).limit(5).each do |approval| %>
                        <%= link_to film_path(approval.film), class: "activity-item" do %>
                          <div class="activity-type-badge approval">Approval Needed</div>
                          <div class="activity-item-title"><%= approval.film.title %></div>
                          <div class="activity-item-desc">You've been tagged as <%= approval.approval_type.titleize %></div>
                          <div class="activity-item-time"><%= time_ago_in_words(approval.created_at) %> ago</div>
                        <% end %>
                      <% end %>
                    <% end %>
                    <% unread_grouped.each do |group| %>
                      <%= render partial: 'shared/notification_group', locals: { group: group, is_unread: true } %>
                    <% end %>
                  <% else %>
                    <div class="activity-empty">
                      <div style="font-size: 32px; margin-bottom: 8px; opacity: 0.3;">✓</div>
                      <div>No new activity</div>
                    </div>
                  <% end %>

                  <% if has_more_notifications %>
                    <button type="button" class="expand-notifications-btn" id="expand-notifications-btn" onclick="toggleNotificationsExpand()">
                      <span class="expand-text">Show All Notifications</span>
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left: 4px;">
                        <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  <% end %>
                </div>

                <div class="activity-content-expanded" id="activity-content-expanded" style="display: none;">
                  <% all_grouped.each do |group| %>
                    <%= render partial: 'shared/notification_group', locals: { group: group, is_unread: group[:notifications].any? { |n| n.read_at.nil? } } %>
                  <% end %>

                  <button type="button" class="expand-notifications-btn" onclick="toggleNotificationsExpand()">
                    <span class="expand-text">Show Less</span>
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left: 4px; transform: rotate(180deg);">
                      <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <span style="color: var(--muted); font-size: 13px; text-transform: uppercase; letter-spacing: 0.04em;"><%= current_user.username.presence || current_user.email %></span>
            <%= link_to "Profile", user_path(current_user), class: "pill-btn" %>
            <%= button_to "Logout", destroy_user_session_path, method: :delete, class: "pill-btn primary", form: { data: { turbo: false } } %>
          <% else %>
            <%= link_to "Login", new_user_session_path, class: "pill-btn" %>
            <%= link_to "Sign up", new_user_registration_path, class: "pill-btn primary" %>
          <% end %>
        </div>
      </div>
      <!-- Global Search Bar -->
      <div class="global-search-container">
        <div class="global-search-wrapper">
          <span class="global-search-icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="7" cy="7" r="4.5" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10.5 10.5L13.5 13.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </span>
          <input
            type="text"
            id="global-search-input"
            class="global-search-input"
            placeholder="Search the entire archive..."
            autocomplete="off"
          >
          <div id="global-search-results" class="global-search-results"></div>
        </div>
      </div>
    </div>

    <%= render 'shared/sidebar' %>

    <% unless controller_name == "pages" && action_name == "home" %>
      <div class="breadcrumbs">
        <% breadcrumbs.each_with_index do |crumb, index| %>
          <% if crumb[:path] %>
            <%= link_to crumb[:name], crumb[:path] %>
          <% else %>
            <span class="current"><%= crumb[:name] %></span>
          <% end %>
          <% unless index == breadcrumbs.length - 1 %>
            <span class="separator">/</span>
          <% end %>
        <% end %>
      </div>
    <% end %>

    <main class="shell">
      <% if controller_name == "pages" && action_name == "home" %>
        <section class="hero">
          <% logo_file = theme[:theme_name] == 'light' ? '/SW-LOGO-2025-full-BLK.svg' : '/SW-LOGO-2025-full-WHT.svg' %>
          <img src="<%= logo_file %>" alt="STREETWATCH" class="hero-logo">
          <p class="sub">Document. Create. Share. Support.</p>
          <div class="cta-row">
            <%= link_to "Films", films_path, class: "cta-tile" %>
            <%= link_to "Photos", photos_path, class: "cta-tile" %>
            <%= link_to "Articles", articles_path, class: "cta-tile" %>
            <%= link_to "Profiles", users_path, class: "cta-tile" %>
            <%= link_to "Shop", shop_path, class: "cta-tile" %>
          </div>
          <details class="dropdown">
            <summary>Create account</summary>
            <div class="dropdown-menu">
              <%= link_to "Sign up", new_user_registration_path %>
              <%= link_to "Login", new_user_session_path %>
            </div>
          </details>
        </section>
      <% else %>
        <%= yield %>
      <% end %>
    </main>

    <%= render 'shared/footer' %>

    <script>
      // Activity dropdown - using event delegation to avoid duplicate listeners
      (function() {
        let isInitialized = false;

        function initActivityDropdown() {
          // Only initialize once
          if (isInitialized) return;
          isInitialized = true;

          // Use event delegation on document to handle clicks
          document.addEventListener('click', function(e) {
            const activityBtn = document.getElementById('activity-btn');
            const activityMenu = document.getElementById('activity-menu');

            if (!activityBtn || !activityMenu) return;

            // Check if clicked on activity button
            if (activityBtn.contains(e.target)) {
              e.stopPropagation();
              activityMenu.classList.toggle('open');
            }
            // Check if clicked inside the menu
            else if (activityMenu.contains(e.target)) {
              e.stopPropagation();
            }
            // Clicked outside - close the menu
            else {
              activityMenu.classList.remove('open');
            }
          });
        }

        document.addEventListener('DOMContentLoaded', initActivityDropdown);
      })();

      function markNotificationsAsRead() {
        // Count notifications BEFORE removing them
        const notificationItems = Array.from(document.querySelectorAll('.activity-item')).filter(item => {
          return item.querySelector('.activity-type-badge.notification');
        });
        const notificationCount = notificationItems.length;

        if (notificationCount === 0) {
          return; // No notifications to mark as read
        }

        // Get CSRF token from body data attribute (most reliable for Turbo apps)
        let csrfToken = document.body.getAttribute('data-csrf-token');

        if (!csrfToken) {
          // Fallback: Try meta tag in head
          const metaTag = document.head?.querySelector('meta[name="csrf-token"]');
          if (metaTag) {
            csrfToken = metaTag.getAttribute('content');
          }
        }

        if (!csrfToken) {
          console.error('CSRF token not found');
          return;
        }

        fetch('/notifications/mark_as_read', {
          method: 'POST',
          headers: {
            'X-CSRF-Token': csrfToken,
            'Content-Type': 'application/json'
          }
        }).then(response => {
          if (response.ok) {
            // Remove notification items from the dropdown
            notificationItems.forEach(item => {
              item.remove();
            });

            // Hide the "Mark as Read" button
            const markReadBtn = document.getElementById('mark-read-btn');
            if (markReadBtn) {
              markReadBtn.remove();
            }

            // Update the badge count (subtract notification count)
            const badge = document.querySelector('.activity-badge');
            if (badge) {
              const currentCount = parseInt(badge.textContent);
              const newCount = currentCount - notificationCount;

              if (newCount > 0) {
                badge.textContent = newCount;
              } else {
                badge.remove();
              }
            }

            // Check if activity menu is now empty
            const activityMenu = document.querySelector('#activity-menu');
            const remainingItems = activityMenu.querySelectorAll('.activity-item');

            if (remainingItems.length === 0) {
              // Find the content area (after the header) and show empty state
              const header = activityMenu.querySelector('.activity-header');
              if (header && header.nextElementSibling) {
                // Remove everything after the header
                while (header.nextElementSibling) {
                  header.nextElementSibling.remove();
                }
              }
              // Add empty state
              const emptyState = document.createElement('div');
              emptyState.className = 'activity-empty';
              emptyState.innerHTML = '<div style="font-size: 32px; margin-bottom: 8px; opacity: 0.3;">✓</div><div>No new activity</div>';
              activityMenu.appendChild(emptyState);
            }
          }
        }).catch(error => {
          console.error('Error marking notifications as read:', error);
        });
      }

      function toggleNotificationsExpand() {
        const compactView = document.getElementById('activity-content-compact');
        const expandedView = document.getElementById('activity-content-expanded');

        if (compactView.style.display === 'none') {
          // Show compact, hide expanded
          compactView.style.display = 'block';
          expandedView.style.display = 'none';
        } else {
          // Show expanded, hide compact
          compactView.style.display = 'none';
          expandedView.style.display = 'block';
        }
      }
    </script>

    <script>
      // Global Search Autocomplete
      (function() {
        let searchTimeout;
        let currentRequest = null;

        function initGlobalSearch() {
          const searchInput = document.getElementById('global-search-input');
          const resultsContainer = document.getElementById('global-search-results');

          if (!searchInput || !resultsContainer) return;

          // Search on input with debounce
          searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();

            clearTimeout(searchTimeout);

            if (query.length < 2) {
              resultsContainer.classList.remove('open');
              resultsContainer.innerHTML = '';
              return;
            }

            // Show loading state
            resultsContainer.innerHTML = '<div class="search-loading">Searching...</div>';
            resultsContainer.classList.add('open');

            // Debounce search requests
            searchTimeout = setTimeout(() => {
              performSearch(query, resultsContainer);
            }, 300);
          });

          // Close results when clicking outside
          document.addEventListener('click', function(e) {
            if (!resultsContainer.contains(e.target) && e.target !== searchInput) {
              resultsContainer.classList.remove('open');
            }
          });

          // Handle keyboard events
          searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              resultsContainer.classList.remove('open');
              searchInput.blur();
            } else if (e.key === 'Enter') {
              const query = e.target.value.trim();
              if (query.length >= 2) {
                // Redirect to full search results page
                window.location.href = `/search?q=${encodeURIComponent(query)}`;
              }
            }
          });
        }

        function performSearch(query, resultsContainer) {
          // Cancel previous request if still pending
          if (currentRequest) {
            currentRequest.abort();
          }

          currentRequest = new AbortController();

          fetch(`/search?q=${encodeURIComponent(query)}`, {
            signal: currentRequest.signal,
            headers: {
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => response.json())
          .then(data => {
            renderResults(data, resultsContainer);
          })
          .catch(error => {
            if (error.name !== 'AbortError') {
              console.error('Search error:', error);
              resultsContainer.innerHTML = '<div class="search-empty">An error occurred. Please try again.</div>';
            }
          })
          .finally(() => {
            currentRequest = null;
          });
        }

        function renderResults(data, resultsContainer) {
          const hasResults = data.films.length > 0 || data.photos.length > 0 || data.users.length > 0 || data.albums.length > 0;

          if (!hasResults) {
            resultsContainer.innerHTML = '<div class="search-empty">No results found</div>';
            return;
          }

          let html = '';

          // Render Films
          if (data.films.length > 0) {
            html += '<div class="search-results-section">';
            html += '<div class="search-results-header">Films</div>';
            data.films.forEach(film => {
              const filmType = film.film_type ? `<span class="search-result-meta">${film.film_type}</span>` : '';
              const company = film.company ? ` · ${film.company}` : '';
              html += `
                <a href="/films/${film.id}" class="search-result-item" data-turbo-frame="_top">
                  <div class="search-result-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M2 3C2 2.44772 2.44772 2 3 2H13C13.5523 2 14 2.44772 14 3V13C14 13.5523 13.5523 14 13 14H3C2.44772 14 2 13.5523 2 13V3Z" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M2 5.5H14M2 8.5H14M2 11.5H14M5.5 2V14M10.5 2V14" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  </div>
                  <div class="search-result-content">
                    <div class="search-result-title">${escapeHtml(film.title)}</div>
                    ${filmType ? `<div class="search-result-meta">${filmType}${company}</div>` : ''}
                  </div>
                  <span class="search-result-badge film">Film</span>
                </a>
              `;
            });
            html += '</div>';
          }

          // Render Photos
          if (data.photos.length > 0) {
            html += '<div class="search-results-section">';
            html += '<div class="search-results-header">Photos</div>';
            data.photos.forEach(photo => {
              html += `
                <a href="/photos/${photo.id}" class="search-result-item" data-turbo-frame="_top">
                  <div class="search-result-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="2" y="3" width="12" height="10" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
                      <circle cx="5.5" cy="6.5" r="1.5" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M14 10L11.5 7.5L8.5 10.5L6.5 8.5L2 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="search-result-content">
                    <div class="search-result-title">${escapeHtml(photo.title)}</div>
                  </div>
                  <span class="search-result-badge photo">Photo</span>
                </a>
              `;
            });
            html += '</div>';
          }

          // Render Users
          if (data.users.length > 0) {
            html += '<div class="search-results-section">';
            html += '<div class="search-results-header">Profiles</div>';
            data.users.forEach(user => {
              const name = user.name ? `<span class="search-result-meta">${user.name}</span>` : '';
              const profileType = user.profile_type ? ` · ${user.profile_type}` : '';
              html += `
                <a href="/users/${user.id}" class="search-result-item" data-turbo-frame="_top">
                  <div class="search-result-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="8" cy="5" r="2.5" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M3 13C3 10.7909 5.23858 9 8 9C10.7614 9 13 10.7909 13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="search-result-content">
                    <div class="search-result-title">@${escapeHtml(user.username)}</div>
                    ${name ? `<div class="search-result-meta">${name}${profileType}</div>` : ''}
                  </div>
                  <span class="search-result-badge user">User</span>
                </a>
              `;
            });
            html += '</div>';
          }

          // Render Albums
          if (data.albums.length > 0) {
            html += '<div class="search-results-section">';
            html += '<div class="search-results-header">Albums</div>';
            data.albums.forEach(album => {
              html += `
                <a href="/albums/${album.id}" class="search-result-item" data-turbo-frame="_top">
                  <div class="search-result-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 4.5C3 3.67157 3.67157 3 4.5 3H11.5C12.3284 3 13 3.67157 13 4.5V12.5C13 13.3284 12.3284 14 11.5 14H4.5C3.67157 14 3 13.3284 3 12.5V4.5Z" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M3 6H13" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M6 3V6" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M10 3V6" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  </div>
                  <div class="search-result-content">
                    <div class="search-result-title">${escapeHtml(album.title)}</div>
                  </div>
                  <span class="search-result-badge album">Album</span>
                </a>
              `;
            });
            html += '</div>';
          }

          resultsContainer.innerHTML = html;
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', initGlobalSearch);
        document.addEventListener('turbo:load', initGlobalSearch);
      })();
    </script>

    <script>
      // Skeleton loader for page transitions
      (function() {
        let navigationInProgress = false;

        // Show skeleton immediately when a link is clicked
        document.addEventListener('turbo:click', (event) => {
          navigationInProgress = true;

          // Check if we're on a page with a profile loading overlay
          const profileLoadingOverlay = document.getElementById('profile-loading-overlay');

          // Only show skeleton if we don't have a profile loading overlay
          if (!profileLoadingOverlay) {
            let skeleton = document.getElementById('page-skeleton');
            if (skeleton) {
              skeleton.style.display = 'block';
            }
          }
        });

        // Hide skeleton as soon as Turbo starts loading the page
        // This allows users to see content immediately while images lazy load
        document.addEventListener('turbo:load', () => {
          navigationInProgress = false;
          const skeleton = document.getElementById('page-skeleton');
          if (skeleton) {
            skeleton.style.display = 'none';
          }
        });

        // Clean up on errors
        document.addEventListener('turbo:fetch-request-error', () => {
          navigationInProgress = false;
          const skeleton = document.getElementById('page-skeleton');
          if (skeleton) {
            skeleton.style.display = 'none';
          }
        });
      })();
    </script>
  </body>
</html>
