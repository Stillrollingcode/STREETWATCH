<% content_for :head do %>
  <style>
    .profile-shell {
      max-width: 1100px;
      margin: 28px auto 60px;
      padding: 0 18px 40px;
      color: var(--text);
    }
    .profile-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px;
      display: grid;
      gap: 12px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
    }
    .avatar {
      width: 84px;
      height: 84px;
      border-radius: 50%;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 50%, transparent), color-mix(in srgb, var(--accent-2) 50%, transparent));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 28px;
      color: #0c0c0f;
      border: 2px solid rgba(255,255,255,0.08);
      overflow: hidden;
    }
    .profile-meta h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.01em;
    }
    .profile-meta .username {
      color: var(--muted);
      font-size: 14px;
      margin-top: 4px;
    }
    .profile-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.12s ease;
    }
    .settings-btn svg { width: 18px; height: 18px; }
    .settings-btn:hover { border-color: rgba(255,255,255,0.2); }
    .profile-stats {
      display: flex;
      gap: 24px;
      color: var(--muted);
      font-size: 14px;
      flex-wrap: wrap;
    }
    .profile-stats strong { color: var(--text); font-size: 16px; }
    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }
    .tab-btn {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      transition: all 0.12s ease;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 40%, transparent), color-mix(in srgb, var(--accent-2) 40%, transparent));
      border-color: rgba(255,255,255,0.15);
    }
    .tab-panels {
      margin-top: 14px;
    }
    .panel {
      display: none;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      padding: 14px;
      min-height: 180px;
    }
    .panel.active { display: block; }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    .mini-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      display: grid;
      gap: 6px;
      min-height: 120px;
    }
    .mini-card .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
    .mini-card .title { font-weight: 700; }
    .film-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.15s ease;
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .film-card:hover {
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .film-thumbnail {
      width: 100%;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 20%, transparent), color-mix(in srgb, var(--accent-2) 20%, transparent));
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .film-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .film-thumbnail .placeholder {
      font-size: 36px;
      opacity: 0.3;
    }
    .film-info {
      padding: 10px 12px;
    }
    .film-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
      line-height: 1.3;
    }
    .role-badges {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .role-badge {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 700;
    }
    <% theme = user_theme_styles %>
    .role-badge.filmer {
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.15') %>;
      border: 1px solid <%= theme[:primary_rgba].sub('ALPHA', '0.3') %>;
      color: var(--accent);
    }
    .role-badge.editor {
      background: <%= theme[:secondary_rgba].sub('ALPHA', '0.15') %>;
      border: 1px solid <%= theme[:secondary_rgba].sub('ALPHA', '0.3') %>;
      color: var(--accent);
    }
    .role-badge.rider {
      background: <%= theme[:light_rgba].sub('ALPHA', '0.12') %>;
      border: 1px solid <%= theme[:light_rgba].sub('ALPHA', '0.25') %>;
      color: var(--accent);
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    /* Settings modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 18px;
    }
    .modal-backdrop.open { display: flex; }
    .settings-drawer {
      width: min(640px, 100%);
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #111015;
      padding: 18px;
      display: grid;
      gap: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
    }
    .settings-drawer label {
      color: var(--muted);
      font-size: 14px;
      display: block;
      margin-bottom: 6px;
      margin-top: 0;
    }
    .settings-drawer input,
    .settings-drawer textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #2f2f33;
      background: #0d0d0f;
      color: #f5f5f7;
      font-size: 15px;
      margin-bottom: 0;
    }
    .settings-drawer textarea { min-height: 90px; resize: vertical; }
    .settings-drawer .muted-note {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
      margin-bottom: 4px;
    }
    .settings-drawer > div {
      margin-bottom: 8px;
      padding-bottom: 0;
      margin-top: 0;
    }
    .settings-drawer > div:not(:first-of-type) {
      padding-top: 28px;
    }
    .settings-drawer > div:first-of-type {
      padding-top: 0;
    }
    .avatar-preview-container {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
    }
    .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 50%, transparent), color-mix(in srgb, var(--accent-2) 50%, transparent));
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.1);
    }
    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .avatar-controls-wrapper {
      display: none;
      margin-top: 12px;
    }
    .avatar-controls-wrapper.active {
      display: block;
    }
    .avatar-controls-toggle {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.12s ease;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .avatar-controls-toggle:hover {
      background: rgba(255,255,255,0.1);
    }
    .avatar-controls-toggle-icon {
      transition: transform 0.2s ease;
      font-size: 10px;
    }
    .avatar-controls-toggle.open .avatar-controls-toggle-icon {
      transform: rotate(180deg);
    }
    .avatar-controls {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .avatar-controls.open {
      display: flex;
    }
    .avatar-controls-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .avatar-controls-section-title {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .avatar-controls-row {
      display: flex;
      gap: 6px;
    }
    .avatar-controls button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.12s ease;
      white-space: nowrap;
    }
    .avatar-controls button:hover {
      background: rgba(255,255,255,0.1);
    }
    .direction-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      max-width: 120px;
    }
    .direction-btn {
      padding: 8px !important;
      font-size: 14px !important;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .direction-btn.center {
      opacity: 0.3;
      cursor: default;
      pointer-events: none;
    }
    .settings-actions { margin-top: 6px; }
    .profile-bio { margin-top: 6px; color: var(--muted); max-width: 520px; line-height: 1.5; }
    .settings-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
    }
    .danger-btn {
      background: transparent;
      color: #ff8f8f;
      border: 1px solid rgba(255,143,143,0.4);
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.12s ease;
    }
    .danger-btn:hover { background: rgba(255,143,143,0.1); }
  </style>
<% end %>

<div class="profile-shell">
    <div class="profile-card">
      <div class="profile-header">
        <div class="avatar">
          <% if resource.avatar.attached? %>
            <%= image_tag resource.avatar, style: "width: 100%; height: 100%; object-fit: cover; display: block;" %>
          <% else %>
            <%= (resource.username || resource.email).first&.upcase %>
          <% end %>
        </div>
      <div class="profile-meta">
        <h1><%= resource.name.presence || "Rider Name" %></h1>
        <div class="username">@<%= resource.username.presence || "username" %></div>
        <% if resource.bio.present? %>
          <div class="profile-bio"><%= resource.bio %></div>
        <% end %>
      </div>
        <div class="profile-actions">
          <button type="button" class="settings-btn" id="toggle-settings" aria-label="Open settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6 1.65 1.65 0 0 0 10 3.09V3a2 2 0 1 1 4 0v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c.71 0 1.32.44 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"></path>
            </svg>
          </button>
        </div>
      </div>

    <div class="profile-stats">
      <div><strong><%= resource.all_films.count %></strong> Films</div>
      <div><strong>132</strong> Followers</div>
      <div><strong>87</strong> Following</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-panel="films">Films</button>
      <button class="tab-btn" data-panel="photos">Photos</button>
      <button class="tab-btn" data-panel="articles">Articles</button>
    </div>

    <div class="tab-panels">
      <div class="panel active" id="panel-films">
        <% if resource.all_films.any? %>
          <div class="card-grid">
            <% resource.all_films.each do |film| %>
              <%= link_to film, class: "film-card" do %>
                <div class="film-thumbnail" style="aspect-ratio: <%= film.aspect_ratio_css %>;">
                  <% if film.thumbnail.attached? %>
                    <%= image_tag film.thumbnail %>
                  <% elsif film.youtube_thumbnail_url %>
                    <%= image_tag film.youtube_thumbnail_url, alt: film.title %>
                  <% else %>
                    <div class="placeholder">üé¨</div>
                  <% end %>
                </div>
                <div class="film-info">
                  <div class="film-title"><%= film.title %></div>
                  <div class="role-badges">
                    <% resource.film_roles(film).each do |role| %>
                      <span class="role-badge <%= role.downcase %>"><%= role %></span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <div class="empty-state">
            <div>No films yet</div>
          </div>
        <% end %>
      </div>
      <div class="panel" id="panel-photos">
        <div class="card-grid">
          <div class="mini-card">
            <div class="label">Photo</div>
            <div class="title">Wallride</div>
            <div class="label">by Crew</div>
          </div>
        </div>
      </div>
      <div class="panel" id="panel-articles">
        <div class="card-grid">
          <div class="mini-card">
            <div class="label">Article</div>
            <div class="title">Spot guide: DTLA</div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="settings-backdrop">
      <div class="settings-drawer" id="settings-drawer">
        <button class="modal-close" id="close-settings" aria-label="Close settings">√ó</button>
        <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, multipart: true }) do |f| %>
          <%= render "devise/shared/error_messages", resource: resource %>

          <div>
            <%= f.label :avatar, "Profile picture" %>
            <%= f.file_field :avatar, direct_upload: true, id: "avatar-upload", accept: "image/*" %>
            <div class="avatar-preview-container">
              <div class="avatar-preview" id="avatar-preview">
                <% if resource.avatar.attached? %>
                  <img src="<%= url_for(resource.avatar) %>" alt="Avatar preview" id="avatar-img">
                <% else %>
                  <span id="avatar-placeholder"><%= (resource.username || resource.email).first&.upcase %></span>
                <% end %>
              </div>
            </div>
            <div class="avatar-controls-wrapper" id="avatar-controls-wrapper">
              <button type="button" class="avatar-controls-toggle" id="avatar-controls-toggle">
                <span>Edit Position & Zoom</span>
                <span class="avatar-controls-toggle-icon">‚ñº</span>
              </button>
              <div class="avatar-controls" id="avatar-controls">
                <div class="avatar-controls-section">
                  <div class="avatar-controls-section-title">Zoom</div>
                  <div class="avatar-controls-row">
                    <button type="button" id="zoom-in">Zoom In</button>
                    <button type="button" id="zoom-out">Zoom Out</button>
                  </div>
                </div>
                <div class="avatar-controls-section">
                  <div class="avatar-controls-section-title">Position</div>
                  <div class="direction-grid">
                    <button type="button" class="direction-btn" id="move-up-left">‚Üñ</button>
                    <button type="button" class="direction-btn" id="move-up">‚Üë</button>
                    <button type="button" class="direction-btn" id="move-up-right">‚Üó</button>
                    <button type="button" class="direction-btn" id="move-left">‚Üê</button>
                    <button type="button" class="direction-btn center">‚Ä¢</button>
                    <button type="button" class="direction-btn" id="move-right">‚Üí</button>
                    <button type="button" class="direction-btn" id="move-down-left">‚Üô</button>
                    <button type="button" class="direction-btn" id="move-down">‚Üì</button>
                    <button type="button" class="direction-btn" id="move-down-right">‚Üò</button>
                  </div>
                </div>
                <button type="button" id="reset-zoom" style="width: 100%;">Reset All</button>
              </div>
            </div>
            <div class="muted-note">Upload a profile picture. You can zoom and position it after selecting.</div>
          </div>

          <div>
            <%= f.label :name %>
            <%= f.text_field :name, autocomplete: "name" %>
          </div>

          <div>
            <%= f.label :username %>
            <%= f.text_field :username, autocomplete: "username" %>
          </div>

          <div>
            <%= f.label :bio %>
            <%= f.text_area :bio, placeholder: "Short rider bio, sponsors, crew..." %>
          </div>

          <div>
            <%= f.label :email %>
            <%= f.email_field :email, autocomplete: "email" %>
          </div>

          <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
            <div class="muted-note">Waiting confirmation for: <%= resource.unconfirmed_email %></div>
          <% end %>

          <div>
            <%= f.label :password %>
            <%= f.password_field :password, autocomplete: "new-password" %>
            <% if @minimum_password_length %>
              <div class="muted-note"><%= @minimum_password_length %> characters minimum</div>
            <% end %>
          </div>

          <div>
            <%= f.label :password_confirmation %>
            <%= f.password_field :password_confirmation, autocomplete: "new-password" %>
          </div>

          <div>
            <%= f.label :current_password %>
            <%= f.password_field :current_password, autocomplete: "current-password" %>
            <div class="muted-note">Needed to confirm changes</div>
          </div>

          <div>
            <label>Sponsors (pending links)</label>
            <%= f.text_area :sponsor_requests, placeholder: "Add sponsor usernames/brands. Links appear after they approve.", rows: 2 %>
            <div class="muted-note"><em>Sponsors will show on your profile once approved by the company.<em></div>
            <div class="muted-note"><em>Current sponsors: <strong>(pending approval)</strong><em></div>
          </div>

          <div class="settings-actions">
            <%= f.submit "Save changes", class: "pill-btn primary" %>
          </div>
        <% end %>

        <div class="settings-actions">
          <%= button_to "Cancel my account", registration_path(resource_name), method: :delete,
                data: { confirm: "Are you sure?", turbo_confirm: "Are you sure?" },
                class: "danger-btn" %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", profileInit);
  document.addEventListener("DOMContentLoaded", profileInit);
  function profileInit() {
    const tabs = document.querySelectorAll(".tab-btn");
    const panels = document.querySelectorAll(".panel");
    tabs.forEach((tab) => {
      tab.onclick = () => {
        tabs.forEach(t => t.classList.remove("active"));
        panels.forEach(p => p.classList.remove("active"));
        tab.classList.add("active");
        const target = document.getElementById(`panel-${tab.dataset.panel}`);
        if (target) target.classList.add("active");
      };
    });
    const toggle = document.getElementById("toggle-settings");
    const backdrop = document.getElementById("settings-backdrop");
    const closeBtn = document.getElementById("close-settings");
    if (toggle && backdrop) {
      toggle.onclick = () => backdrop.classList.add("open");
    }
    if (closeBtn && backdrop) {
      closeBtn.onclick = () => backdrop.classList.remove("open");
    }
    if (backdrop) {
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) backdrop.classList.remove("open");
      });
    }

    // Avatar upload preview and zoom controls
    const avatarUpload = document.getElementById("avatar-upload");
    const avatarPreview = document.getElementById("avatar-preview");
    const avatarImg = document.getElementById("avatar-img");
    const avatarPlaceholder = document.getElementById("avatar-placeholder");
    const avatarControlsWrapper = document.getElementById("avatar-controls-wrapper");
    const avatarControlsToggle = document.getElementById("avatar-controls-toggle");
    const avatarControls = document.getElementById("avatar-controls");
    const zoomInBtn = document.getElementById("zoom-in");
    const zoomOutBtn = document.getElementById("zoom-out");
    const resetBtn = document.getElementById("reset-zoom");

    let currentZoom = 1;
    let currentX = 0;
    let currentY = 0;
    let isDragging = false;
    let startX, startY;

    if (avatarUpload) {
      avatarUpload.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = (event) => {
            // Create or update img element
            let img = avatarImg;
            if (!img) {
              img = document.createElement("img");
              img.id = "avatar-img";
              img.alt = "Avatar preview";
              avatarPreview.innerHTML = "";
              avatarPreview.appendChild(img);
            }
            img.src = event.target.result;

            // Reset zoom and position
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            updateImageTransform();

            // Show controls wrapper
            avatarControlsWrapper.classList.add("active");
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Toggle controls dropdown
    if (avatarControlsToggle) {
      avatarControlsToggle.addEventListener("click", (e) => {
        e.preventDefault();
        avatarControlsToggle.classList.toggle("open");
        avatarControls.classList.toggle("open");
      });
    }

    function updateImageTransform() {
      const img = document.getElementById("avatar-img");
      if (img) {
        img.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentZoom})`;
      }
    }

    if (zoomInBtn) {
      zoomInBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentZoom = Math.min(currentZoom + 0.1, 3);
        updateImageTransform();
      });
    }

    if (zoomOutBtn) {
      zoomOutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentZoom = Math.max(currentZoom - 0.1, 0.5);
        updateImageTransform();
      });
    }

    if (resetBtn) {
      resetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentZoom = 1;
        currentX = 0;
        currentY = 0;
        updateImageTransform();
      });
    }

    // Directional movement controls
    const moveStep = 10; // pixels to move per click

    const moveUpBtn = document.getElementById("move-up");
    const moveDownBtn = document.getElementById("move-down");
    const moveLeftBtn = document.getElementById("move-left");
    const moveRightBtn = document.getElementById("move-right");
    const moveUpLeftBtn = document.getElementById("move-up-left");
    const moveUpRightBtn = document.getElementById("move-up-right");
    const moveDownLeftBtn = document.getElementById("move-down-left");
    const moveDownRightBtn = document.getElementById("move-down-right");

    if (moveUpBtn) {
      moveUpBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentY -= moveStep;
        updateImageTransform();
      });
    }

    if (moveDownBtn) {
      moveDownBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentY += moveStep;
        updateImageTransform();
      });
    }

    if (moveLeftBtn) {
      moveLeftBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentX -= moveStep;
        updateImageTransform();
      });
    }

    if (moveRightBtn) {
      moveRightBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentX += moveStep;
        updateImageTransform();
      });
    }

    if (moveUpLeftBtn) {
      moveUpLeftBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentX -= moveStep;
        currentY -= moveStep;
        updateImageTransform();
      });
    }

    if (moveUpRightBtn) {
      moveUpRightBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentX += moveStep;
        currentY -= moveStep;
        updateImageTransform();
      });
    }

    if (moveDownLeftBtn) {
      moveDownLeftBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentX -= moveStep;
        currentY += moveStep;
        updateImageTransform();
      });
    }

    if (moveDownRightBtn) {
      moveDownRightBtn.addEventListener("click", (e) => {
        e.preventDefault();
        currentX += moveStep;
        currentY += moveStep;
        updateImageTransform();
      });
    }

    // Drag to reposition
    if (avatarPreview) {
      avatarPreview.addEventListener("mousedown", (e) => {
        const img = document.getElementById("avatar-img");
        if (img && currentZoom > 1) {
          isDragging = true;
          startX = e.clientX - currentX;
          startY = e.clientY - currentY;
          avatarPreview.style.cursor = "grabbing";
        }
      });

      document.addEventListener("mousemove", (e) => {
        if (isDragging) {
          currentX = e.clientX - startX;
          currentY = e.clientY - startY;
          updateImageTransform();
        }
      });

      document.addEventListener("mouseup", () => {
        if (isDragging) {
          isDragging = false;
          avatarPreview.style.cursor = "grab";
        }
      });
    }

    // Show controls wrapper if avatar already exists
    if (avatarImg) {
      avatarControlsWrapper.classList.add("active");
      avatarPreview.style.cursor = "grab";
    }
  }
</script>
