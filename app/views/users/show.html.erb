<% theme = user_theme_styles %>
<% content_for :head do %>
<style>
  .breadcrumbs {
    max-width: 900px;
    margin: 0 auto;
    padding: 16px 18px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--muted);
  }
  .breadcrumbs a {
    color: var(--muted);
    text-decoration: none;
    transition: color 0.15s ease;
  }
  .breadcrumbs a:hover {
    color: var(--accent);
  }
  .breadcrumbs .separator {
    color: var(--border);
  }
  .breadcrumbs .current {
    color: var(--text);
    font-weight: 600;
  }
  .profile-shell {
    max-width: 900px;
    margin: 12px auto 60px;
    padding: 0 18px 40px;
    color: var(--text);
  }
  .profile-card {
    background: rgba(255,255,255,0.04);
    border: 2px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
  }
  .profile-card h1 {
    margin: 0 0 24px;
    font-size: 28px;
  }
  .profile-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }
  .profile-title-section {
    flex: 1;
  }
  .settings-btn {
    padding: 10px 20px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .settings-btn:hover {
    background: rgba(255,255,255,0.08);
    border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    transform: translateY(-1px);
  }
  .follow-btn {
    padding: 10px 20px;
    background: linear-gradient(120deg, var(--accent), var(--accent-2));
    border: none;
    border-radius: 10px;
    color: #0b0b0d;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .follow-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  .claim-btn {
    padding: 10px 20px;
    background: linear-gradient(120deg, hsl(210, 70%, 50%), hsl(210, 70%, 40%));
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .claim-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
  }
  .claim-banner {
    background: linear-gradient(120deg, rgba(33, 150, 243, 0.2), rgba(25, 118, 210, 0.2));
    border: 1px solid rgba(33, 150, 243, 0.3);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }
  .claim-banner-text {
    flex: 1;
  }
  .claim-banner-text h3 {
    margin: 0 0 4px 0;
    color: hsl(210, 70%, 60%);
    font-size: 16px;
  }
  .claim-banner-text p {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
  }
  .claim-info-banner {
    background: linear-gradient(120deg, rgba(76, 175, 80, 0.2), rgba(56, 142, 60, 0.2));
    border: 1px solid rgba(76, 175, 80, 0.3);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 24px;
  }
  .claim-info-text h3 {
    margin: 0 0 8px 0;
    color: hsl(122, 39%, 60%);
    font-size: 16px;
  }
  .claim-info-text p {
    margin: 0;
    color: var(--text);
    font-size: 14px;
    line-height: 1.5;
  }
  .unfollow-btn {
    padding: 10px 20px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .unfollow-btn:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,100,100,0.5);
    color: rgba(255,100,100,1);
    transform: translateY(-1px);
  }
  .notification-btn {
    padding: 10px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
  }
  .notification-btn:hover {
    background: rgba(255,255,255,0.08);
    border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    color: var(--text);
    transform: translateY(-1px);
  }
  .notification-btn.active {
    background: color-mix(in srgb, var(--accent) 20%, transparent);
    border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    color: var(--accent);
  }
  .notification-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
  }
  .profile-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .profile-section {
    margin-bottom: 32px;
  }
  .profile-section:last-child {
    margin-bottom: 0;
  }
  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin: 0 0 16px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .avatar-section {
    display: flex;
    align-items: center;
    gap: 18px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .avatar {
    width: 84px;
    height: 84px;
    border-radius: 50%;
    background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 50%, transparent), color-mix(in srgb, var(--accent-2) 50%, transparent));
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 28px;
    color: #0c0c0f;
    border: 2px solid rgba(255,255,255,0.08);
    overflow: hidden;
  }
  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .profile-meta-info {
    flex: 1;
  }
  .profile-meta-info h2 {
    margin: 0 0 8px;
    font-size: 24px;
    letter-spacing: 0.01em;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .company-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted);
  }
  @media (max-width: 768px) {
    .company-badge {
      width: 100%;
      justify-content: center;
      margin-top: 4px;
    }
  }
  .profile-meta-info .username {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 4px;
  }
  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }
  .info-item {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
  }
  .info-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }
  .info-value {
    font-size: 14px;
    color: var(--text);
    font-weight: 600;
  }
  .profile-stats {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    color: var(--muted);
    font-size: 14px;
  }
  .profile-stats .stat {
    display: flex;
    gap: 6px;
    align-items: baseline;
  }
  .profile-stats strong {
    color: var(--text);
    font-size: 16px;
    font-weight: 700;
  }
  .profile-stats .stat-link {
    display: flex;
    gap: 6px;
    align-items: baseline;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.15s ease;
  }
  .profile-stats .stat-link:hover {
    color: var(--accent);
  }
  .profile-stats .stat-link strong {
    transition: color 0.15s ease;
  }
  .profile-stats .stat-link:hover strong {
    color: var(--accent);
  }
  .content-tabs {
    display: flex;
    gap: 8px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }
  .content-tab {
    flex: 1;
    padding: 12px 16px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }
  .content-tab:hover {
    background: rgba(255,255,255,0.08);
    border-color: color-mix(in srgb, var(--accent) 50%, transparent);
  }
  .content-tab.active {
    background: color-mix(in srgb, var(--accent) 20%, transparent);
    border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    color: var(--accent);
  }
  .content-section {
    display: none;
    margin-top: 24px;
  }
  .content-section.active {
    display: block;
  }
  .bio-content {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    color: var(--text);
    line-height: 1.6;
    min-height: 80px;
  }
  .bio-content p {
    margin: 0;
  }
  .bio-content.empty {
    color: var(--muted);
    font-style: italic;
  }
  .sponsors-content {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    color: var(--text);
    line-height: 1.6;
  }
  .sponsors-content p {
    margin: 0;
  }
  .films-list-section {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }
  .film-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
  }
  .film-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.15s ease;
    text-decoration: none;
    color: inherit;
    display: block;
  }
  .film-card:hover {
    border-color: rgba(255,255,255,0.2);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  }
  .film-thumbnail {
    width: 100%;
    background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 20%, transparent), color-mix(in srgb, var(--accent-2) 20%, transparent));
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }
  .film-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .film-thumbnail .placeholder {
    font-size: 36px;
    opacity: 0.3;
  }
  .film-info { padding: 10px 12px; }
  .film-title { font-weight: 700; font-size: 14px; margin-bottom: 6px; line-height: 1.3; }
  .role-badges { display: flex; gap: 4px; flex-wrap: wrap; }
  .role-badge {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: 700;
  }
  .role-badge.filmer {
    background: <%= theme[:primary_rgba].sub('ALPHA', '0.15') %>;
    border: 1px solid <%= theme[:primary_rgba].sub('ALPHA', '0.3') %>;
    color: var(--accent);
  }
  .role-badge.editor {
    background: <%= theme[:secondary_rgba].sub('ALPHA', '0.15') %>;
    border: 1px solid <%= theme[:secondary_rgba].sub('ALPHA', '0.3') %>;
    color: var(--accent);
  }
  .role-badge.rider {
    background: <%= theme[:light_rgba].sub('ALPHA', '0.12') %>;
    border: 1px solid <%= theme[:light_rgba].sub('ALPHA', '0.25') %>;
    color: var(--accent);
  }
  .role-badge.company {
    background: rgba(156, 39, 176, 0.15);
    border: 1px solid rgba(156, 39, 176, 0.3);
    color: hsl(291, 64%, 60%);
  }
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
    font-style: italic;
  }
  .approval-notification-banner {
    background: linear-gradient(120deg, rgba(255, 165, 0, 0.2), rgba(255, 140, 0, 0.2));
    border: 1px solid rgba(255, 165, 0, 0.3);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }
  .approval-notification-text {
    flex: 1;
  }
  .approval-notification-text h3 {
    margin: 0 0 4px;
    font-size: 16px;
    color: hsl(39, 100%, 60%);
  }
  .approval-notification-text p {
    margin: 0;
    color: var(--text);
    font-size: 14px;
  }
  .approval-notification-btn {
    padding: 10px 20px;
    background: linear-gradient(120deg, hsl(39, 100%, 50%), hsl(39, 100%, 40%));
    border: none;
    border-radius: 10px;
    color: #0b0b0d;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }
  .approval-notification-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(255, 165, 0, 0.4);
  }
</style>
<% end %>

<div class="profile-shell">
  <div class="profile-card">
    <div class="profile-header">
      <div class="avatar-section" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; flex: 1;">
        <div class="avatar">
          <% if @user.avatar.attached? %>
            <%= image_tag @user.avatar %>
          <% else %>
            <%= (@user.username || @user.email).first&.upcase %>
          <% end %>
        </div>
        <div class="profile-meta-info">
          <h2>
            <span><%= @user.username.presence || @user.email %></span>
            <% if @user.company? %>
              <span class="company-badge">
                <span>Company</span>
              </span>
            <% end %>
          </h2>
          <% if @user.email_visible? %>
            <div class="username"><%= @user.email %></div>
          <% end %>
          <% if @user.name.present? %>
            <div class="username"><%= @user.name %></div>
          <% end %>
        </div>
      </div>
      <% if user_signed_in? %>
        <% if current_user.id == @user.id %>
          <%= link_to settings_path, class: "settings-btn" do %>
            <span>‚öôÔ∏è</span>
            <span>Settings</span>
          <% end %>
        <% else %>
          <div class="profile-actions">
            <% if current_user.following?(@user) %>
              <%= button_to unfollow_user_path(@user), method: :delete, class: "unfollow-btn", form: { style: "display: inline;" } do %>
                <span>‚úì</span>
                <span>Following</span>
              <% end %>
            <% else %>
              <%= button_to follow_user_path(@user), method: :post, class: "follow-btn", form: { style: "display: inline;" } do %>
                <span>+</span>
                <span>Follow</span>
              <% end %>
            <% end %>
            <%
              notification_setting = current_user.profile_notification_settings.find_by(target_user: @user)
              has_notifications = notification_setting&.any_notifications_enabled?
            %>
            <%= link_to user_notification_setting_path(@user), class: "notification-btn #{has_notifications ? 'active' : ''}", title: "Notification Settings" do %>
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C11.172 2 10.5 2.672 10.5 3.5V4.1C8.53 4.56 7 6.275 7 8.5V14L5 16V17H19V16L17 14V8.5C17 6.275 15.47 4.56 13.5 4.1V3.5C13.5 2.672 12.828 2 12 2ZM10 18C10 19.1 10.9 20 12 20C13.1 20 14 19.1 14 18H10Z"/>
              </svg>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>

    <% if @user.claimable? %>
      <div class="claim-banner" id="claim-banner">
        <div class="claim-banner-text">
          <h3>Is this you?</h3>
          <p>Claim your Streetwatch profile and take control of your content.</p>
        </div>
        <button type="button" class="claim-btn" id="claim-btn">
          <span>Claim Profile</span>
        </button>
      </div>
      <div class="claim-info-banner" id="claim-info-banner" style="display: none;">
        <div class="claim-info-text">
          <h3>Ready to claim your profile?</h3>
          <p>Please contact us at <a href="mailto:streetwatchmov@gmail.com" style="color: hsl(210, 70%, 60%); text-decoration: underline;">streetwatchmov@gmail.com</a> to confirm ownership and gain access to your profile.</p>
        </div>
      </div>
    <% end %>

    <% if user_signed_in? && current_user.id == @user.id && current_user.film_approvals.pending.any? %>
      <div class="approval-notification-banner">
        <div class="approval-notification-text">
          <h3>‚è≥ Content Awaiting Your Approval</h3>
          <p>You have <%= pluralize(current_user.film_approvals.pending.count, 'film') %> waiting for your approval.</p>
        </div>
        <%= link_to film_approvals_path, class: "approval-notification-btn" do %>
          <span>Review Now</span>
        <% end %>
      </div>
    <% end %>

    <!-- Profile Stats and Bio -->
    <div class="profile-section">

      <!-- Profile Stats -->
      <div class="profile-stats">
        <div class="stat">Supporters<strong><%= @user.followers.count %></strong></div>
        <div class="stat">
          <%= link_to following_user_path(@user), class: "stat-link" do %>
            Supporter of <strong><%= @user.following.count %></strong>
          <% end %>
        </div>
      </div>

      <!-- Bio Section -->
      <% if @user.bio.present? || @user.sponsor_requests.present? %>
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
          <% if @user.bio.present? %>
            <div class="bio-content" style="border: none; background: none; padding: 0; min-height: auto; margin-bottom: 12px;">
              <%= simple_format(@user.bio) %>
            </div>
          <% end %>
          <% if @user.sponsor_requests.present? %>
            <div style="color: var(--muted); font-size: 13px;">
              <strong style="color: var(--text);">Sponsors:</strong> <%= @user.sponsor_requests %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Content Tabs -->
      <div class="content-tabs">
        <a href="#" class="content-tab active" data-tab="films">Films</a>
        <a href="#" class="content-tab" data-tab="photos">Photos</a>
        <a href="#" class="content-tab" data-tab="articles">Articles</a>
      </div>
    </div>

    <!-- Films Content Section -->
    <div class="content-section active" id="films-section">
      <% films = @user.all_films %>
      <% if films.any? %>
        <div class="film-grid">
          <% films.each do |film| %>
            <%= link_to film_path(film), class: "film-card" do %>
              <div class="film-thumbnail">
                <% if film.display_thumbnail.present? %>
                  <% if film.display_thumbnail.respond_to?(:attachment) %>
                    <%= image_tag film.display_thumbnail, alt: film.title %>
                  <% else %>
                    <img src="<%= film.display_thumbnail %>" alt="<%= film.title %>">
                  <% end %>
                <% else %>
                  <div class="placeholder">üé¨</div>
                <% end %>
              </div>
              <div class="film-info">
                <div class="film-title"><%= film.title %></div>
                <div class="role-badges">
                  <% roles = @user.film_roles(film) %>
                  <% roles.each do |role| %>
                    <span class="role-badge <%= role.downcase %>"><%= role %></span>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state">No films yet.</div>
      <% end %>
    </div>

    <!-- Photos Content Section -->
    <div class="content-section" id="photos-section">
      <div class="empty-state">
        <h3 style="margin: 0 0 10px; color: var(--text);">Photos Coming Soon</h3>
        <p>Photo uploads will be available in a future update.</p>
      </div>
    </div>

    <!-- Articles Content Section -->
    <div class="content-section" id="articles-section">
      <div class="empty-state">
        <h3 style="margin: 0 0 10px; color: var(--text);">Articles Coming Soon</h3>
        <p>Article publishing will be available in a future update.</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Content tab switching
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('.content-tab');
    const sections = document.querySelectorAll('.content-section');

    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const targetTab = tab.dataset.tab;

        // Remove active class from all tabs and sections
        tabs.forEach(t => t.classList.remove('active'));
        sections.forEach(s => s.classList.remove('active'));

        // Add active class to clicked tab and corresponding section
        tab.classList.add('active');
        document.getElementById(`${targetTab}-section`).classList.add('active');
      });
    });

    // Handle claim profile button click
    const claimBtn = document.getElementById('claim-btn');
    const claimBanner = document.getElementById('claim-banner');
    const claimInfoBanner = document.getElementById('claim-info-banner');

    if (claimBtn && claimBanner && claimInfoBanner) {
      claimBtn.addEventListener('click', () => {
        claimBanner.style.display = 'none';
        claimInfoBanner.style.display = 'block';
      });
    }
  });

  // Also handle Turbo navigation
  document.addEventListener('turbo:load', () => {
    const tabs = document.querySelectorAll('.content-tab');
    const sections = document.querySelectorAll('.content-section');

    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const targetTab = tab.dataset.tab;

        tabs.forEach(t => t.classList.remove('active'));
        sections.forEach(s => s.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(`${targetTab}-section`).classList.add('active');
      });
    });

    // Handle claim profile button click
    const claimBtn = document.getElementById('claim-btn');
    const claimBanner = document.getElementById('claim-banner');
    const claimInfoBanner = document.getElementById('claim-info-banner');

    if (claimBtn && claimBanner && claimInfoBanner) {
      claimBtn.addEventListener('click', () => {
        claimBanner.style.display = 'none';
        claimInfoBanner.style.display = 'block';
      });
    }
  });
</script>
