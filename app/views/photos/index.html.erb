<% content_for :head do %>
  <link rel="stylesheet" href="<%= asset_path('list_views.css') %>">
  <link rel="stylesheet" href="<%= asset_path('cards.css') %>">
  <style>
    /* Page-specific styles */
    .add-photo-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid <%= user_theme_styles[:theme_name] == 'light' ? 'transparent' : 'rgba(255,255,255,0.1)' %>;
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: <%= user_theme_styles[:theme_name] == 'light' ? 'white' : '#0b0b0d' %>;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.15s ease;
      font-size: 14px;
      white-space: nowrap;
      display: inline-block;
    }
    .add-photo-btn:hover {
      transform: translateY(-1px);
    }
  </style>
<% end %>

<div class="list-shell">
  <div class="list-header">
    <h1>Photos</h1>
  </div>

  <div class="group-by-buttons">
    <%= link_to "All Photos", photos_path, class: "group-btn #{'active' unless params[:group_by].present?}" %>
    <%= link_to "By Photographer", photos_path(group_by: 'photographer'), class: "group-btn #{'active' if params[:group_by] == 'photographer'}" %>
    <%= link_to "Albums", photos_path(group_by: 'albums'), class: "group-btn #{'active' if params[:group_by] == 'albums'}" %>
  </div>

  <div class="filters-bar">
    <div class="search-box">
      <%= form_with url: photos_path, method: :get, local: true do |f| %>
        <span class="search-icon">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7" cy="7" r="4.5" stroke="currentColor" stroke-width="1.5"/>
            <path d="M10.5 10.5L13.5 13.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </span>
        <%= f.text_field :search, placeholder: "Search photos...", value: params[:search] %>
        <%= f.hidden_field :group_by, value: params[:group_by] if params[:group_by] %>
        <%= f.hidden_field :sort, value: params[:sort] if params[:sort] %>
      <% end %>
    </div>

    <div class="sort-controls">
      <%= form_with url: photos_path, method: :get, local: true do |f| %>
        <%= f.select :sort,
          [['Newest', 'newest'], ['Oldest', 'oldest'], ['Alphabetical', 'alphabetical'], ['By Date', 'by_date']],
          { selected: params[:sort] || 'newest' },
          { class: 'sort-select', onchange: 'this.form.submit()' }
        %>
        <%= f.hidden_field :search, value: params[:search] if params[:search] %>
        <%= f.hidden_field :group_by, value: params[:group_by] if params[:group_by] %>
      <% end %>
      <% if user_signed_in? %>
        <%= link_to "Add Photos", batch_upload_photos_path, class: "add-photo-btn" %>
      <% end %>
    </div>
  </div>

  <% if @albums %>
    <div class="content-grid">
      <% @albums.each do |album| %>
        <%= link_to album_path(album), class: "card", style: "text-decoration: none;" do %>
          <% if album.photos.any? && album.photos.first.image.attached? %>
            <%= image_tag url_for(album.photos.first.image),
              class: 'card-thumbnail',
              alt: album.title,
              loading: 'lazy' %>
          <% else %>
            <div class="card-thumbnail-empty">
              No Photos
            </div>
          <% end %>
          <div class="card-info">
            <h3 class="card-title"><%= album.title %></h3>
            <p class="card-subtitle"><%= pluralize(album.photos.count, 'photo') %> â€¢ <%= album.user.username %></p>
          </div>
        <% end %>
      <% end %>
    </div>
  <% elsif @grouped_photos %>
    <% @grouped_photos.each do |photographer_name, photos| %>
      <div class="content-group">
        <h2><%= photographer_name %></h2>
        <div class="content-grid">
          <% photos.each do |photo| %>
            <%= link_to photo_path(photo), class: "card", style: "text-decoration: none;" do %>
              <% if photo.image.attached? %>
                <%= image_tag url_for(photo.image),
                  class: 'card-thumbnail',
                  alt: photo.title,
                  loading: 'lazy' %>
              <% else %>
                <div class="card-thumbnail-empty">
                  No Image
                </div>
              <% end %>
              <div class="card-info">
                <h3 class="card-title"><%= photo.title %></h3>
                <p class="card-subtitle"><%= photo.photographer_name %></p>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% else %>
    <div data-controller="lazy-load"
         data-lazy-load-url-value="<%= photos_path(format: :html) %>"
         data-lazy-load-has-more-value="<%= @has_more %>"
         data-lazy-load-page-value="<%= @photos.current_page + 1 %>">
      <div class="content-grid" data-lazy-load-target="container">
        <%= render partial: 'photo_cards', locals: { photos: @photos } %>
      </div>

      <div data-lazy-load-target="loader" style="display: none; text-align: center; padding: 20px;">
        <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      </div>

      <% if @has_more %>
        <div style="text-align: center; margin: 32px 0;">
          <button data-action="click->lazy-load#loadMore"
                  data-lazy-load-target="loadButton"
                  style="padding: 12px 32px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s ease;">
            Load More Photos
          </button>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Reset to page 1 when searching
    const searchForm = document.querySelector('.search-box form');
    if (searchForm) {
      searchForm.addEventListener('submit', (e) => {
        const pageInput = searchForm.querySelector('input[name="page"]');
        if (pageInput) {
          pageInput.remove();
        }
      });
    }

    // Reset to page 1 when changing sort
    const sortForm = document.querySelector('.sort-controls form');
    if (sortForm) {
      const sortSelect = sortForm.querySelector('.sort-select');
      if (sortSelect) {
        sortSelect.addEventListener('change', () => {
          const pageInput = sortForm.querySelector('input[name="page"]');
          if (pageInput) {
            pageInput.remove();
          }
        });
      }
    }

    // Reset to page 1 when changing group by
    const groupByLinks = document.querySelectorAll('.group-by-buttons a');
    groupByLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const url = new URL(link.href);
        url.searchParams.delete('page');
        link.href = url.toString();
      });
    });
  });
</script>
