<% content_for :head do %>
  <style>
    .films-shell {
      max-width: 1200px;
      margin: 28px auto 60px;
      padding: 0 18px 40px;
      color: var(--text);
    }
    .films-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .films-header h1 {
      margin: 0 0 16px;
      font-size: 32px;
      letter-spacing: 0.01em;
    }
    .group-by-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .group-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
      display: inline-block;
    }
    .group-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .group-btn.active {
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
      color: var(--accent);
    }
    .filters-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    .search-box input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }
    .search-box input:focus {
      outline: none;
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .search-box input::placeholder {
      color: var(--muted);
    }
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }
    .sort-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .sort-select {
      padding: 10px 32px 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23999' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    .sort-select:focus {
      outline: none;
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .add-film-btn {
      white-space: nowrap;
    }
    .grouped-section {
      margin-bottom: 40px;
    }
    .group-header {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    .films-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .film-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
    }
    .film-card:hover {
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
    }
    .film-thumbnail {
      width: 100%;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 20%, transparent), color-mix(in srgb, var(--accent-2) 20%, transparent));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .film-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .film-thumbnail .placeholder {
      font-size: 48px;
      opacity: 0.3;
    }
    .film-info {
      padding: 14px;
      display: grid;
      gap: 8px;
    }
    .film-title {
      font-weight: 700;
      font-size: 18px;
      margin: 0;
    }
    .film-meta {
      color: var(--muted);
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .film-meta-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .film-company {
      color: var(--accent);
      font-weight: 600;
    }
    .film-riders {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .rider-tag {
      background: rgba(255,255,255,0.08);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-state h2 {
      margin: 0 0 10px;
      color: var(--text);
    }
  </style>
<% end %>

<div class="films-shell">
  <div class="films-header">
    <h1>Films</h1>
  </div>

  <!-- Group By Buttons -->
  <div class="group-by-buttons">
    <%= link_to "All Films", films_path, class: "group-btn #{params[:group_by].blank? ? 'active' : ''}" %>
    <%= link_to "Group by Company", films_path(group_by: 'company', sort: params[:sort], q: params[:q], film_type: params[:film_type]), class: "group-btn #{params[:group_by] == 'company' ? 'active' : ''}" %>
    <%= link_to "Group by Filmer", films_path(group_by: 'filmer', sort: params[:sort], q: params[:q], film_type: params[:film_type]), class: "group-btn #{params[:group_by] == 'filmer' ? 'active' : ''}" %>
    <%= link_to "Group by Editor", films_path(group_by: 'editor', sort: params[:sort], q: params[:q], film_type: params[:film_type]), class: "group-btn #{params[:group_by] == 'editor' ? 'active' : ''}" %>
  </div>

  <!-- Filter By Film Type -->
  <div class="group-by-buttons" style="margin-top: 12px;">
    <%= link_to "All Types", films_path(group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type].blank? ? 'active' : ''}" %>
    <%= link_to "Full Length", films_path(film_type: 'full_length', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'full_length' ? 'active' : ''}" %>
    <%= link_to "Video Part", films_path(film_type: 'video_part', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'video_part' ? 'active' : ''}" %>
    <%= link_to "Mixtape", films_path(film_type: 'mixtape', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'mixtape' ? 'active' : ''}" %>
    <%= link_to "Series", films_path(film_type: 'series', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'series' ? 'active' : ''}" %>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="film-search" placeholder="Search films..." value="<%= params[:q] %>">
    </div>
    <div class="sort-controls">
      <select id="sort-select" class="sort-select">
        <% if params[:group_by].present? %>
          <option value="alpha_asc" <%= 'selected' if params[:sort] == 'alpha_asc' || params[:sort].blank? %>>A-Z</option>
          <option value="alpha_desc" <%= 'selected' if params[:sort] == 'alpha_desc' %>>Z-A</option>
        <% else %>
          <option value="date_desc" <%= 'selected' if params[:sort] == 'date_desc' || params[:sort].blank? %>>Release Date (New-Old)</option>
          <option value="date_asc" <%= 'selected' if params[:sort] == 'date_asc' %>>Release Date (Old-New)</option>
          <option value="alpha_asc" <%= 'selected' if params[:sort] == 'alpha_asc' %>>A-Z</option>
          <option value="alpha_desc" <%= 'selected' if params[:sort] == 'alpha_desc' %>>Z-A</option>
        <% end %>
      </select>
      <% if user_signed_in? %>
        <%= link_to "Add Film", new_film_path, class: "pill-btn primary add-film-btn" %>
      <% end %>
    </div>
  </div>

  <% if @films.any? %>
    <% if @grouped_films.present? %>
      <!-- Grouped Display -->
      <% @grouped_films.each do |group_name, films| %>
        <div class="grouped-section">
          <h2 class="group-header"><%= group_name || 'Unknown' %></h2>
          <div class="films-grid">
            <% films.each do |film| %>
              <%= link_to film, style: "text-decoration: none; color: inherit;" do %>
                <div class="film-card">
                  <div class="film-thumbnail" style="aspect-ratio: <%= film.aspect_ratio_css %>;">
                    <% if film.thumbnail.attached? %>
                      <%= image_tag film.thumbnail %>
                    <% elsif film.youtube_thumbnail_url %>
                      <%= image_tag film.youtube_thumbnail_url, alt: film.title %>
                    <% else %>
                      <div class="placeholder">üé¨</div>
                    <% end %>
                  </div>
                  <div class="film-info">
                    <h3 class="film-title"><%= film.title %></h3>
                    <div class="film-meta">
                      <% if film.company.present? %>
                        <div class="film-meta-row">
                          <span class="film-company"><%= film.company %></span>
                        </div>
                      <% end %>
                      <div class="film-meta-row">
                        <% if film.release_date.present? %>
                          <span><%= film.release_date.year %></span>
                        <% end %>
                        <% if film.runtime.present? %>
                          <span>¬∑ <%= film.formatted_runtime %></span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <!-- Normal Grid Display -->
      <div class="films-grid">
      <% @films.each do |film| %>
        <%= link_to film, style: "text-decoration: none; color: inherit;" do %>
          <div class="film-card">
            <div class="film-thumbnail" style="aspect-ratio: <%= film.aspect_ratio_css %>;">
              <% if film.thumbnail.attached? %>
                <%= image_tag film.thumbnail %>
              <% elsif film.youtube_thumbnail_url %>
                <%= image_tag film.youtube_thumbnail_url, alt: film.title %>
              <% else %>
                <div class="placeholder">üé¨</div>
              <% end %>
            </div>
            <div class="film-info">
              <h3 class="film-title"><%= film.title %></h3>
              <div class="film-meta">
                <% if film.company.present? %>
                  <div class="film-meta-row">
                    <span class="film-company"><%= film.company %></span>
                  </div>
                <% end %>
                <div class="film-meta-row">
                  <% if film.release_date.present? %>
                    <span><%= film.release_date.year %></span>
                  <% end %>
                  <% if film.runtime.present? %>
                    <span>¬∑ <%= film.formatted_runtime %></span>
                  <% end %>
                </div>
                <% if film.riders.any? %>
                  <div class="film-riders">
                    <% film.riders.limit(5).each do |rider| %>
                      <span class="rider-tag"><%= rider.username %></span>
                    <% end %>
                    <% if film.riders.count > 5 %>
                      <span class="rider-tag">+<%= film.riders.count - 5 %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="empty-state">
      <h2>No films yet</h2>
      <p>Be the first to add a film to the archive.</p>
    </div>
  <% end %>
</div>

<script>
  // Search functionality with debounce and enter key support
  function initializeFilmSearch() {
    const searchInput = document.getElementById('film-search');
    const sortSelect = document.getElementById('sort-select');
    let searchTimeout;

    function updateFilters() {
      const params = new URLSearchParams(window.location.search);
      const searchValue = searchInput ? searchInput.value.trim() : '';
      const sortValue = sortSelect ? sortSelect.value : '';

      // Update or remove search parameter
      if (searchValue) {
        params.set('q', searchValue);
      } else {
        params.delete('q');
      }

      // Update or remove sort parameter
      if (sortValue) {
        params.set('sort', sortValue);
      } else {
        params.delete('sort');
      }

      // Preserve group_by and film_type parameters if present
      const currentParams = new URLSearchParams(window.location.search);
      if (currentParams.get('group_by')) {
        params.set('group_by', currentParams.get('group_by'));
      }
      if (currentParams.get('film_type')) {
        params.set('film_type', currentParams.get('film_type'));
      }

      // Store that we should refocus after reload
      sessionStorage.setItem('filmSearchFocus', 'true');

      // Navigate to new URL
      window.location.href = window.location.pathname + '?' + params.toString();
    }

    if (searchInput) {
      // Auto-focus if we just did a search
      if (sessionStorage.getItem('filmSearchFocus') === 'true') {
        sessionStorage.removeItem('filmSearchFocus');
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
          searchInput.focus();
          // Move cursor to end of input
          const length = searchInput.value.length;
          searchInput.setSelectionRange(length, length);
        }, 100);
      }

      // Debounced search on input - 2 second delay to allow typing
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          updateFilters();
        }, 2000); // Increased to 2 seconds
      });

      // Immediate search on Enter key
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          clearTimeout(searchTimeout);
          updateFilters();
        }
      });
    }

    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        updateFilters();
      });
    }
  }

  // Initialize on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', initializeFilmSearch);

  // Also initialize on Turbo navigation
  document.addEventListener('turbo:load', initializeFilmSearch);
</script>
