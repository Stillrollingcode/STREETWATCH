<% theme = user_theme_styles %>
<% accent_hue = user_theme_styles[:accent_hue] || 145 %>
<% content_for :head do %>
  <style>
    /* Theme-specific dynamic styles - Chrome <111 fallbacks included */
    .group-btn:hover {
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .group-btn.active {
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.2') %>; /* Fallback */
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .search-box input:focus {
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .sort-select:focus, .group-select:focus, .type-select:focus {
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    /* DVD glow effects using theme accent */
    .dvd-stack-disc {
      box-shadow:
        inset 0 0 0 2px rgba(255,255,255,.10),
        inset 0 -14px 30px rgba(0,0,0,.35),
        0 0 8px hsla(<%= accent_hue %>, 70%, 60%, 0.15),
        0 8px 20px rgba(0,0,0,.45);
    }
    .dvd-stack-discs > a:hover .dvd-stack-disc {
      box-shadow:
        inset 0 0 0 2px rgba(255,255,255,.12),
        inset 0 -14px 30px rgba(0,0,0,.35),
        0 0 16px hsla(<%= accent_hue %>, 70%, 60%, 0.35),
        0 16px 40px rgba(0,0,0,.75);
    }
    .film-card {
      filter:
        drop-shadow(0 0 8px hsla(<%= accent_hue %>, 70%, 60%, 0.15))
        drop-shadow(0 0 16px hsla(<%= accent_hue %>, 70%, 60%, 0.08))
        drop-shadow(0 18px 40px rgba(0,0,0,.55));
    }
    .film-card:hover {
      filter:
        drop-shadow(0 0 12px hsla(<%= accent_hue %>, 70%, 60%, 0.25))
        drop-shadow(0 0 24px hsla(<%= accent_hue %>, 70%, 60%, 0.15))
        drop-shadow(0 22px 50px rgba(0,0,0,.65));
    }
    .film-card-rating {
      color: <%= theme[:theme_name] == 'light' ? 'hsl(45, 100%, 35%)' : 'hsl(45, 100%, 51%)' %>;
    }
  </style>
<% end %>

<div class="films-shell">
  <div class="films-header">
    <h1>Films</h1>
    <% if params[:group_by].present? %>
      <p style="font-size: 18px; font-weight: 600; color: var(--accent); margin: 8px auto 0;">
        Grouped by <%= params[:group_by].humanize %>
      </p>
    <% end %>
    <% if params[:film_type].present? %>
      <p style="font-size: 18px; font-weight: 600; color: var(--accent); margin: 8px auto 0;">
        <%= params[:film_type].humanize.titleize %>
      </p>
      <% if Film::FILM_TYPE_DESCRIPTIONS[params[:film_type]] %>
        <p style="font-size: 15px; font-style: italic; color: var(--muted); margin: 8px auto 0; max-width: 600px;">
          <%= Film::FILM_TYPE_DESCRIPTIONS[params[:film_type]] %>
        </p>
      <% end %>
    <% end %>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <div class="search-box">
      <span class="search-icon">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="7" cy="7" r="4.5" stroke="currentColor" stroke-width="1.5"/>
          <path d="M10.5 10.5L13.5 13.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </span>
      <input type="text" id="film-search" placeholder="Search films..." value="<%= params[:q] %>">
    </div>
    <div class="sort-controls">
      <select id="group-select" class="group-select">
        <option value="" <%= 'selected' if params[:group_by].blank? %>>All Films</option>
        <option value="company" <%= 'selected' if params[:group_by] == 'company' %>>Group by Company</option>
        <option value="filmer" <%= 'selected' if params[:group_by] == 'filmer' %>>Group by Filmer</option>
        <option value="editor" <%= 'selected' if params[:group_by] == 'editor' %>>Group by Editor</option>
      </select>
      <select id="type-select" class="type-select">
        <option value="" <%= 'selected' if params[:film_type].blank? %>>All Types</option>
        <option value="full_length" <%= 'selected' if params[:film_type] == 'full_length' %>>Full Length</option>
        <option value="rider_part" <%= 'selected' if params[:film_type] == 'rider_part' %>>Rider Part</option>
        <option value="mixtape" <%= 'selected' if params[:film_type] == 'mixtape' %>>Mixtape</option>
        <option value="series" <%= 'selected' if params[:film_type] == 'series' %>>Series</option>
        <option value="b_sides" <%= 'selected' if params[:film_type] == 'b_sides' %>>B-Sides</option>
        <option value="all_the_rest" <%= 'selected' if params[:film_type] == 'all_the_rest' %>>All The Rest</option>
      </select>
      <select id="sort-select" class="sort-select">
        <% if params[:group_by].present? %>
          <option value="alpha_asc" <%= 'selected' if params[:sort] == 'alpha_asc' || params[:sort].blank? %>>A-Z</option>
          <option value="alpha_desc" <%= 'selected' if params[:sort] == 'alpha_desc' %>>Z-A</option>
        <% else %>
          <option value="date_desc" <%= 'selected' if params[:sort] == 'date_desc' || params[:sort].blank? %>>Release Date (New-Old)</option>
          <option value="date_asc" <%= 'selected' if params[:sort] == 'date_asc' %>>Release Date (Old-New)</option>
          <option value="alpha_asc" <%= 'selected' if params[:sort] == 'alpha_asc' %>>A-Z</option>
          <option value="alpha_desc" <%= 'selected' if params[:sort] == 'alpha_desc' %>>Z-A</option>
        <% end %>
      </select>
      <% if user_signed_in? %>
        <%= link_to "Add Film", new_film_path, class: "pill-btn primary add-film-btn" %>
      <% end %>
    </div>
  </div>

  <turbo-frame id="films-content" data-turbo-action="advance">
  <% if @films.any? %>
    <% if @grouped_films.present? %>
      <!-- Grouped Display with DVD Stacks -->
      <% @grouped_films.each do |group_name, data| %>
        <div class="grouped-section">
          <% user = data[:user] %>
          <% films = data[:films] %>
          <% total_count = data[:total_count] %>

          <% if user %>
            <%= link_to user_path(user), class: "group-header", data: { turbo_frame: "_top" } do %>
              <span class="group-header-name"><%= group_name || 'Unknown' %></span>
              <span class="group-header-count"><%= total_count %> <%= total_count == 1 ? 'film' : 'films' %></span>
            <% end %>
          <% else %>
            <div class="group-header" style="cursor: default;">
              <span class="group-header-name"><%= group_name || 'Unknown' %></span>
              <span class="group-header-count"><%= total_count %> <%= total_count == 1 ? 'film' : 'films' %></span>
            </div>
          <% end %>

          <div class="dvd-stack">
            <div class="dvd-stack-discs">
              <% films.each_with_index do |film, index| %>
                <%= link_to film_path(film, nav_context: 'films', nav_sort: params[:sort], nav_type: params[:film_type]), data: { turbo_frame: "_top" }, style: "z-index: #{5 - index};" do %>
                  <div class="dvd-stack-disc">
                    <% if film.display_thumbnail.present? %>
                      <%= image_tag film.display_thumbnail, alt: film.title, loading: "lazy" %>
                    <% else %>
                      <div class="placeholder">ðŸŽ¬</div>
                    <% end %>
                    <div class="inner-ring"></div>
                  </div>
                <% end %>
              <% end %>
            </div>
            <% if total_count > 5 %>
              <% if user %>
                <%= link_to user_path(user), class: "dvd-more-indicator", data: { turbo_frame: "_top" } do %>
                  <div class="dvd-more-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <span>+<%= total_count - 5 %> more</span>
                <% end %>
              <% else %>
                <div class="dvd-more-indicator" style="cursor: default;">
                  <div class="dvd-more-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <span>+<%= total_count - 5 %> more</span>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <!-- Normal Grid Display with Lazy Loading -->
      <div data-controller="lazy-load"
           data-lazy-load-url-value="<%= films_path(format: :html) %>"
           data-lazy-load-has-more-value="<%= @has_more %>"
           data-lazy-load-page-value="<%= @films.current_page + 1 %>">

        <div class="films-grid" data-lazy-load-target="container">
        <% @films.each do |film| %>
          <%= link_to film_path(film, nav_context: 'films', nav_sort: params[:sort], nav_type: params[:film_type]), style: "text-decoration: none; color: inherit;", data: { turbo_frame: "_top" } do %>
            <div class="film-card">
              <%= render 'shared/film_thumbnail', film: film, show_pending: (user_signed_in? && !film.published?), unique_id: "normal-#{film.id}" %>
              <div class="film-info">
                <h3 class="film-title"><%= film.title %></h3>
                <div class="film-meta">
                  <%# Display companies - check multi-company association first, then legacy fields %>
                  <% company_names = film.companies_display_names %>
                  <% if company_names.any? %>
                    <div class="film-meta-row">
                      <span class="film-company"><%= company_names.first(2).join(', ') %><%= company_names.count > 2 ? " +#{company_names.count - 2}" : '' %></span>
                    </div>
                  <% end %>
                  <div class="film-meta-row">
                    <% if film.release_date.present? %>
                      <span><%= film.release_date.year %></span>
                    <% end %>
                    <% if film.runtime.present? %>
                      <span>Â· <%= film.formatted_runtime %></span>
                    <% end %>
                    <% if film.review_count > 0 %>
                      <span class="film-card-rating">
                        Â· â˜… <%= number_with_precision(film.average_rating, precision: 1) %> (<%= film.review_count %>)
                      </span>
                    <% end %>
                  </div>
                  <% riders_list = film.riders.to_a %>
                  <% if riders_list.any? %>
                    <div class="film-riders">
                      <% riders_list.first(5).each do |rider| %>
                        <span class="rider-tag"><%= rider.username %></span>
                      <% end %>
                      <% if riders_list.size > 5 %>
                        <span class="rider-tag">+<%= riders_list.size - 5 %></span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
        </div>

        <!-- Loader for infinite scroll -->
        <div class="loader hidden" data-lazy-load-target="loader" style="text-align: center; padding: 2rem;">
          <div style="display: inline-block; width: 3rem; height: 3rem; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        </div>

        <!-- Alternative: Load More button -->
        <% if @has_more %>
          <div data-lazy-load-target="loadMore" style="text-align: center; padding: 2rem;">
            <button class="group-btn" data-action="click->lazy-load#loadMoreClick" style="padding: 12px 32px; font-size: 15px; cursor: pointer;">
              Load More Films
            </button>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="empty-state">
      <h2>No films yet</h2>
      <p>Be the first to add a film to the archive.</p>
    </div>
  <% end %>
  </turbo-frame>
</div>

<script>
  // Search functionality with debounce and enter key support
  function initializeFilmSearch() {
    const searchInput = document.getElementById('film-search');
    const sortSelect = document.getElementById('sort-select');
    const groupSelect = document.getElementById('group-select');
    const typeSelect = document.getElementById('type-select');
    let searchTimeout;

    function updateFilters() {
      const params = new URLSearchParams();
      const searchValue = searchInput ? searchInput.value.trim() : '';
      const sortValue = sortSelect ? sortSelect.value : '';
      const groupValue = groupSelect ? groupSelect.value : '';
      const typeValue = typeSelect ? typeSelect.value : '';

      // Update or remove search parameter
      if (searchValue) {
        params.set('q', searchValue);
      }

      // Update or remove sort parameter
      if (sortValue) {
        params.set('sort', sortValue);
      }

      // Update or remove group_by parameter
      if (groupValue) {
        params.set('group_by', groupValue);
      }

      // Update or remove film_type parameter
      if (typeValue) {
        params.set('film_type', typeValue);
      }

      // Reset to page 1 when searching or filtering
      params.delete('page');

      // Store that we should refocus after reload
      sessionStorage.setItem('filmSearchFocus', 'true');

      // Navigate to new URL
      window.location.href = window.location.pathname + '?' + params.toString();
    }

    if (searchInput) {
      // Auto-focus if we just did a search
      if (sessionStorage.getItem('filmSearchFocus') === 'true') {
        sessionStorage.removeItem('filmSearchFocus');
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
          searchInput.focus();
          // Move cursor to end of input
          const length = searchInput.value.length;
          searchInput.setSelectionRange(length, length);
        }, 100);
      }

      // Debounced search on input - 2 second delay to allow typing
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          updateFilters();
        }, 2000); // Increased to 2 seconds
      });

      // Immediate search on Enter key
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          clearTimeout(searchTimeout);
          updateFilters();
        }
      });
    }

    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        updateFilters();
      });
    }

    if (groupSelect) {
      groupSelect.addEventListener('change', function() {
        updateFilters();
      });
    }

    if (typeSelect) {
      typeSelect.addEventListener('change', function() {
        updateFilters();
      });
    }
  }

  // Initialize on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', initializeFilmSearch);

  // Also initialize on Turbo navigation
  document.addEventListener('turbo:load', initializeFilmSearch);
</script>
