<% content_for :head do %>
  <style>
    .films-shell {
      max-width: 1200px;
      margin: 28px auto 60px;
      padding: 0 18px 40px;
      color: var(--text);
    }
    .films-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .films-header h1 {
      margin: 0 0 16px;
      font-size: 32px;
      letter-spacing: 0.01em;
    }
    .group-by-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .group-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
      display: inline-block;
    }
    .group-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .group-btn.active {
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
      color: var(--accent);
    }
    .filters-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    .search-box input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }
    .search-box input:focus {
      outline: none;
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .search-box input::placeholder {
      color: var(--muted);
    }
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }
    .sort-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .sort-select {
      padding: 10px 32px 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23999' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    .sort-select:focus {
      outline: none;
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .sort-select option {
      background: var(--bg);
      color: var(--text);
    }
    .add-film-btn {
      white-space: nowrap;
    }
    .grouped-section {
      margin-bottom: 40px;
    }
    .group-header {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    .films-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
    }
    .films-grid > a {
      display: flex;
      text-decoration: none;
      color: inherit;
      border: none;
      outline: none;
    }

    @media (max-width: 900px) {
      .films-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .films-grid {
        grid-template-columns: 1fr;
      }
    }
    .film-card {
      background: transparent;
      border: none;
      overflow: visible;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      filter:
        drop-shadow(0 0 8px <%= "hsla(#{user_theme_styles[:accent_hue] || 145}, 70%, 60%, 0.15)" %>)
        drop-shadow(0 0 16px <%= "hsla(#{user_theme_styles[:accent_hue] || 145}, 70%, 60%, 0.08)" %>)
        drop-shadow(0 18px 40px rgba(0,0,0,.55));
    }
    .film-card:hover {
      transform: translateY(-4px);
      filter:
        drop-shadow(0 0 12px <%= "hsla(#{user_theme_styles[:accent_hue] || 145}, 70%, 60%, 0.25)" %>)
        drop-shadow(0 0 24px <%= "hsla(#{user_theme_styles[:accent_hue] || 145}, 70%, 60%, 0.15)" %>)
        drop-shadow(0 22px 50px rgba(0,0,0,.65));
    }
    .film-card:hover .film-thumbnail {
      box-shadow:
        inset 0 0 0 2px rgba(255,255,255,.12),
        inset 0 -14px 30px rgba(0,0,0,.35);
    }

    /* DVD disc made from film thumbnail */
    .film-thumbnail {
      /* controls */
      --size: 260px;
      --hole: 18%;
      --inner-ring: 28%;
      --bg: var(--bg);

      width: var(--size);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      position: relative;
      overflow: visible;

      /* depth */
      box-shadow:
        inset 0 0 0 2px rgba(255,255,255,.10),
        inset 0 -14px 30px rgba(0,0,0,.35);
      transform: translateZ(0);

      /* punch the center hole (best support is WebKit) */
      -webkit-mask-image: radial-gradient(
        circle at 50% 50%,
        transparent 0 calc(var(--hole) * 0.50),
        #000      calc(var(--hole) * 0.52) 100%
      );
      mask-image: radial-gradient(
        circle at 50% 50%,
        transparent 0 calc(var(--hole) * 0.50),
        #000      calc(var(--hole) * 0.52) 100%
      );

      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Inner data ring circle - creates transparency for inner area like real DVDs */
    .film-thumbnail .inner-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      pointer-events: none;
      z-index: 3;

      /* Create uniform transparency overlay for inner area + visible ring border */
      background:
        /* Inner semi-transparent overlay (uniform opacity up to ring) */
        radial-gradient(
          circle at 50% 50%,
          rgba(255, 255, 255, 0.20) 0 calc(var(--inner-ring) * 0.94),
          rgba(255, 255, 255, 0.20) calc(var(--inner-ring) * 0.96),
          transparent calc(var(--inner-ring) * 0.97),
          transparent calc(var(--inner-ring) * 0.98),
          /* The actual ring border */
          rgba(180, 180, 200, 0.40) calc(var(--inner-ring) * 0.98),
          rgba(220, 220, 235, 0.50) calc(var(--inner-ring) * 1.00),
          rgba(180, 180, 200, 0.40) calc(var(--inner-ring) * 1.02),
          transparent calc(var(--inner-ring) * 1.03) 100%
        );
    }

    /* rim + bevel + subtle radial "plastic" shading */
    .film-thumbnail::before {
      content: "";
      position: absolute;
      inset: -2%;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.00) 48%,
          rgba(255,255,255,.10) 58%,
          rgba(0,0,0,.20) 72%,
          rgba(255,255,255,.14) 86%,
          rgba(0,0,0,.35) 100%
        );
      mix-blend-mode: overlay;
      pointer-events: none;
      z-index: 1;
    }

    /* glossy sweep + a faint "ring" texture */
    .film-thumbnail::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background:
        conic-gradient(from 220deg,
          rgba(255,255,255,.00) 0 20%,
          rgba(255,255,255,.18) 26%,
          rgba(255,255,255,.00) 36% 100%
        ),
        repeating-radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.05) 0 2px,
          rgba(0,0,0,.00) 2px 7px
        );
      opacity: .85;
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: 2;
    }

    /* fallback hole for browsers that ignore mask-image */
    @supports not (-webkit-mask-image: radial-gradient(circle, #000, transparent)) {
      .film-thumbnail {
        clip-path: circle(50% at 50% 50%);
      }
      .film-thumbnail::before {
        /* keep rim; add a "fake" hole fill on top */
        background:
          radial-gradient(circle at 50% 50%,
            var(--bg) 0 calc(var(--hole) * 0.50),
            rgba(255,255,255,.00) calc(var(--hole) * 0.52) 100%
          ),
          radial-gradient(circle at 50% 50%,
            rgba(255,255,255,.00) 48%,
            rgba(255,255,255,.10) 58%,
            rgba(0,0,0,.20) 72%,
            rgba(255,255,255,.14) 86%,
            rgba(0,0,0,.35) 100%
          );
      }
    }

    .pending-approval-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(120deg, rgba(255, 165, 0, 0.9), rgba(255, 140, 0, 0.9));
      color: #0b0b0d;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 3;
    }
    .pending-arc-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));
      z-index: 4;
    }

    /* Add yellow hue to pending films */
    .film-thumbnail.pending-film::after {
      background:
        conic-gradient(from 220deg,
          rgba(255,255,255,.00) 0 20%,
          rgba(255,255,255,.18) 26%,
          rgba(255,255,255,.00) 36% 100%
        ),
        repeating-radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.05) 0 2px,
          rgba(0,0,0,.00) 2px 7px
        ),
        radial-gradient(circle at 50% 50%,
          rgba(255, 165, 0, 0.6) 0%,
          rgba(255, 165, 0, 0.4) 100%
        );
      opacity: 1;
    }

    .film-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      inset: 0;
    }

    .film-thumbnail .placeholder {
      font-size: 48px;
      opacity: 0.3;
      z-index: 0;
    }
    .film-info {
      padding: 20px 14px 14px;
      display: grid;
      gap: 8px;
      width: 100%;
      max-width: 260px;
      text-align: center;
    }
    .film-title {
      font-weight: 700;
      font-size: 18px;
      margin: 0;
    }
    .film-meta {
      color: var(--muted);
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }
    .film-meta-row {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }
    .film-company {
      color: var(--accent);
      font-weight: 600;
    }
    .film-riders {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    .rider-tag {
      background: rgba(255,255,255,0.08);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-state h2 {
      margin: 0 0 10px;
      color: var(--text);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 32px 0;
    }

    .pagination a,
    .pagination .current,
    .pagination .gap {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
      transition: all 0.15s ease;
    }

    .pagination a:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--accent);
    }

    .pagination .current {
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
      color: var(--accent);
      font-weight: 600;
    }

    .pagination .gap {
      border: none;
      background: transparent;
      color: var(--muted);
    }

    .pagination .first,
    .pagination .prev,
    .pagination .next,
    .pagination .last {
      font-weight: 600;
    }
  </style>
<% end %>

<div class="films-shell">
  <div class="films-header">
    <h1>Films</h1>
    <% if params[:film_type].present? && Film::FILM_TYPE_DESCRIPTIONS[params[:film_type]] %>
      <p style="font-size: 15px; font-style: italic; color: var(--muted); margin: 8px auto 0; max-width: 600px;">
        <%= Film::FILM_TYPE_DESCRIPTIONS[params[:film_type]] %>
      </p>
    <% end %>
  </div>

  <!-- Group By Buttons -->
  <div class="group-by-buttons">
    <%= link_to "All Films", films_path, class: "group-btn #{params[:group_by].blank? ? 'active' : ''}" %>
    <%= link_to "Group by Company", films_path(group_by: 'company', sort: params[:sort], q: params[:q], film_type: params[:film_type]), class: "group-btn #{params[:group_by] == 'company' ? 'active' : ''}" %>
    <%= link_to "Group by Filmer", films_path(group_by: 'filmer', sort: params[:sort], q: params[:q], film_type: params[:film_type]), class: "group-btn #{params[:group_by] == 'filmer' ? 'active' : ''}" %>
    <%= link_to "Group by Editor", films_path(group_by: 'editor', sort: params[:sort], q: params[:q], film_type: params[:film_type]), class: "group-btn #{params[:group_by] == 'editor' ? 'active' : ''}" %>
  </div>

  <!-- Filter By Film Type -->
  <div class="group-by-buttons" style="margin-top: 12px;">
    <%= link_to "All Types", films_path(group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type].blank? ? 'active' : ''}" %>
    <%= link_to "Full Length", films_path(film_type: 'full_length', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'full_length' ? 'active' : ''}" %>
    <%= link_to "Rider Part", films_path(film_type: 'rider_part', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'rider_part' ? 'active' : ''}" %>
    <%= link_to "Mixtape", films_path(film_type: 'mixtape', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'mixtape' ? 'active' : ''}" %>
    <%= link_to "Series", films_path(film_type: 'series', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'series' ? 'active' : ''}" %>
    <%= link_to "B-Sides", films_path(film_type: 'b_sides', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'b_sides' ? 'active' : ''}" %>
    <%= link_to "All The Rest", films_path(film_type: 'all_the_rest', group_by: params[:group_by], sort: params[:sort], q: params[:q]), class: "group-btn #{params[:film_type] == 'all_the_rest' ? 'active' : ''}" %>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="film-search" placeholder="Search films..." value="<%= params[:q] %>">
    </div>
    <div class="sort-controls">
      <select id="sort-select" class="sort-select">
        <% if params[:group_by].present? %>
          <option value="alpha_asc" <%= 'selected' if params[:sort] == 'alpha_asc' || params[:sort].blank? %>>A-Z</option>
          <option value="alpha_desc" <%= 'selected' if params[:sort] == 'alpha_desc' %>>Z-A</option>
        <% else %>
          <option value="date_desc" <%= 'selected' if params[:sort] == 'date_desc' || params[:sort].blank? %>>Release Date (New-Old)</option>
          <option value="date_asc" <%= 'selected' if params[:sort] == 'date_asc' %>>Release Date (Old-New)</option>
          <option value="alpha_asc" <%= 'selected' if params[:sort] == 'alpha_asc' %>>A-Z</option>
          <option value="alpha_desc" <%= 'selected' if params[:sort] == 'alpha_desc' %>>Z-A</option>
        <% end %>
      </select>
      <% if user_signed_in? %>
        <%= link_to "Add Film", new_film_path, class: "pill-btn primary add-film-btn" %>
      <% end %>
    </div>
  </div>

  <turbo-frame id="films-content" data-turbo-action="advance">
  <% if @films.any? %>
    <% if @grouped_films.present? %>
      <!-- Grouped Display -->
      <% @grouped_films.each do |group_name, films| %>
        <div class="grouped-section">
          <h2 class="group-header"><%= group_name || 'Unknown' %></h2>
          <div class="films-grid">
            <% films.each do |film| %>
              <%= link_to film, style: "text-decoration: none; color: inherit;", data: { turbo_frame: "_top" } do %>
                <div class="film-card">
                  <%= render 'shared/film_thumbnail', film: film, show_pending: (user_signed_in? && !film.published?), unique_id: "grouped-#{film.id}" %>
                  <div class="film-info">
                    <h3 class="film-title"><%= film.title %></h3>
                    <div class="film-meta">
                      <% if film.company_user.present? || film.company.present? %>
                        <div class="film-meta-row">
                          <span class="film-company"><%= film.company_user&.username || film.company %></span>
                        </div>
                      <% end %>
                      <div class="film-meta-row">
                        <% if film.release_date.present? %>
                          <span><%= film.release_date.year %></span>
                        <% end %>
                        <% if film.runtime.present? %>
                          <span>¬∑ <%= film.formatted_runtime %></span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <!-- Normal Grid Display -->
      <div class="films-grid">
      <% @films.each do |film| %>
        <%= link_to film, style: "text-decoration: none; color: inherit;", data: { turbo_frame: "_top" } do %>
          <div class="film-card">
            <%= render 'shared/film_thumbnail', film: film, show_pending: (user_signed_in? && !film.published?), unique_id: "normal-#{film.id}" %>
            <div class="film-info">
              <h3 class="film-title"><%= film.title %></h3>
              <div class="film-meta">
                <% if film.company_user.present? || film.company.present? %>
                  <div class="film-meta-row">
                    <span class="film-company"><%= film.company_user&.username || film.company %></span>
                  </div>
                <% end %>
                <div class="film-meta-row">
                  <% if film.release_date.present? %>
                    <span><%= film.release_date.year %></span>
                  <% end %>
                  <% if film.runtime.present? %>
                    <span>¬∑ <%= film.formatted_runtime %></span>
                  <% end %>
                </div>
                <% if film.riders.any? %>
                  <div class="film-riders">
                    <% film.riders.limit(5).each do |rider| %>
                      <span class="rider-tag"><%= rider.username %></span>
                    <% end %>
                    <% if film.riders.count > 5 %>
                      <span class="rider-tag">+<%= film.riders.count - 5 %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
      </div>

      <!-- Pagination (only show when not grouped) -->
      <% if @films.respond_to?(:current_page) %>
        <%= paginate @films %>
      <% end %>
    <% end %>
  <% else %>
    <div class="empty-state">
      <h2>No films yet</h2>
      <p>Be the first to add a film to the archive.</p>
    </div>
  <% end %>
  </turbo-frame>
</div>

<script>
  // Search functionality with debounce and enter key support
  function initializeFilmSearch() {
    const searchInput = document.getElementById('film-search');
    const sortSelect = document.getElementById('sort-select');
    let searchTimeout;

    function updateFilters() {
      const params = new URLSearchParams(window.location.search);
      const searchValue = searchInput ? searchInput.value.trim() : '';
      const sortValue = sortSelect ? sortSelect.value : '';

      // Update or remove search parameter
      if (searchValue) {
        params.set('q', searchValue);
      } else {
        params.delete('q');
      }

      // Update or remove sort parameter
      if (sortValue) {
        params.set('sort', sortValue);
      } else {
        params.delete('sort');
      }

      // Preserve group_by and film_type parameters if present
      const currentParams = new URLSearchParams(window.location.search);
      if (currentParams.get('group_by')) {
        params.set('group_by', currentParams.get('group_by'));
      }
      if (currentParams.get('film_type')) {
        params.set('film_type', currentParams.get('film_type'));
      }

      // Reset to page 1 when searching or filtering
      params.delete('page');

      // Store that we should refocus after reload
      sessionStorage.setItem('filmSearchFocus', 'true');

      // Navigate to new URL
      window.location.href = window.location.pathname + '?' + params.toString();
    }

    if (searchInput) {
      // Auto-focus if we just did a search
      if (sessionStorage.getItem('filmSearchFocus') === 'true') {
        sessionStorage.removeItem('filmSearchFocus');
        // Small delay to ensure page is fully loaded
        setTimeout(() => {
          searchInput.focus();
          // Move cursor to end of input
          const length = searchInput.value.length;
          searchInput.setSelectionRange(length, length);
        }, 100);
      }

      // Debounced search on input - 2 second delay to allow typing
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          updateFilters();
        }, 2000); // Increased to 2 seconds
      });

      // Immediate search on Enter key
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          clearTimeout(searchTimeout);
          updateFilters();
        }
      });
    }

    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        updateFilters();
      });
    }
  }

  // Initialize on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', initializeFilmSearch);

  // Also initialize on Turbo navigation
  document.addEventListener('turbo:load', initializeFilmSearch);
</script>
