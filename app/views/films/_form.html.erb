<% content_for :head do %>
  <style>
    .form-shell {
      max-width: 700px;
      margin: 28px auto 60px;
      padding: 0 18px 40px;
      color: var(--text);
    }
    .form-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    .form-card h1 {
      margin: 0 0 24px;
      font-size: 28px;
    }
    .form-group {
      margin-bottom: 18px;
    }
    .form-card label {
      display: block;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .form-card input[type="text"],
    .form-card input[type="date"],
    .form-card input[type="number"],
    .form-card input[type="file"],
    .form-card textarea,
    .form-card select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
    }
    .form-card textarea {
      min-height: 100px;
      resize: vertical;
    }
    .form-card select[multiple] {
      min-height: 150px;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }
    .error-messages {
      background: rgba(255,100,100,0.1);
      border: 1px solid rgba(255,100,100,0.3);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 20px;
      color: #ffaaaa;
    }
    .error-messages h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .error-messages ul {
      margin: 0;
      padding-left: 20px;
    }
    .help-text {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }
    .field-group {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .field-group-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--accent);
      margin: 0 0 14px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .field-group .form-group {
      margin-bottom: 14px;
    }
    .field-group .form-group:last-child {
      margin-bottom: 0;
    }
    .searchable-select-wrapper {
      position: relative;
    }
    .searchable-select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      appearance: none;
    }
    .searchable-select:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.04);
    }
    .select-search-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.06);
    }
    .autocomplete-wrapper {
      position: relative;
    }
    .autocomplete-input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
    }
    .autocomplete-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.04);
    }
    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #111015;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 4px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      display: none;
    }
    .autocomplete-results.show {
      display: block;
    }
    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: background 0.1s ease;
    }
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: color-mix(in srgb, var(--accent) 20%, transparent);
    }
    .autocomplete-item.no-results {
      color: var(--muted);
      cursor: default;
      text-align: center;
    }
    .autocomplete-item.no-results:hover {
      background: transparent;
    }
    .hidden-field {
      display: none;
    }
    .upload-progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 95%, transparent), color-mix(in srgb, var(--accent-2) 95%, transparent));
      backdrop-filter: blur(10px);
      padding: 20px;
      z-index: 10000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .upload-progress-overlay.active {
      transform: translateY(0);
    }
    .progress-content {
      max-width: 700px;
      margin: 0 auto;
    }
    .progress-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      color: white;
      font-weight: 600;
      font-size: 15px;
    }
    .progress-spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .progress-bar-container {
      width: 100%;
      height: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ffffff, #f0f0f0);
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: rgba(255,255,255,0.9);
    }
    .progress-percentage {
      font-weight: 700;
      color: white;
    }
    .progress-filename {
      font-size: 13px;
      color: rgba(255,255,255,0.8);
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .existing-video-info {
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .existing-video-info .video-icon {
      font-size: 24px;
    }
    .toggle-upload-link {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
      font-size: 13px;
    }
    .toggle-upload-link:hover {
      color: #5ba876;
    }
    .riders-search-wrapper {
      position: relative;
    }
    .riders-search-input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 15px;
      transition: all 0.2s ease;
    }
    .riders-search-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.06);
    }
    .selected-riders-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      min-height: 40px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
    }
    .selected-riders-list:empty::before {
      content: 'No profiles selected yet';
      color: var(--muted);
      font-size: 13px;
      font-style: italic;
    }
    .selected-rider-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .remove-rider-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      line-height: 1;
      transition: color 0.15s ease;
    }
    .remove-rider-btn:hover {
      color: #ff6b6b;
    }
  </style>
<% end %>

<!-- Upload Progress Overlay -->
<div id="upload-progress-overlay" class="upload-progress-overlay">
  <div class="progress-content">
    <div class="progress-header">
      <div class="progress-spinner"></div>
      <span>Uploading video...</span>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="overlay-progress-bar"></div>
    </div>
    <div class="progress-info">
      <span class="progress-percentage" id="overlay-progress-percentage">0%</span>
      <span id="overlay-progress-size">0 MB / 0 MB</span>
    </div>
    <div class="progress-filename" id="overlay-progress-filename"></div>
  </div>
</div>

<div class="form-shell">
  <div class="form-card">
    <h1><%= film.new_record? ? "Add Film" : "Edit Film" %></h1>

    <%= form_with(model: film, class: 'film-form', html: { data: { turbo: "false" }, onkeydown: "return event.key !== 'Enter' || event.target.tagName === 'TEXTAREA' || event.target.type === 'submit';" }) do |f| %>
      <% if film.errors.any? %>
        <div class="error-messages">
          <h2><%= pluralize(film.errors.count, "error") %> prevented this film from being saved:</h2>
          <ul>
            <% film.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="form-group">
        <%= f.label :title %>
        <%= f.text_field :title, required: true %>
      </div>

      <div class="form-group">
        <%= f.label :description %>
        <%= f.text_area :description, placeholder: "Brief description of the film..." %>
      </div>

      <div class="form-group" id="video-upload-group">
        <%= f.label :video, "Video File" %>

        <% if film.video.attached? %>
          <div class="existing-video-info">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="video-icon">üé¨</span>
              <div>
                <div style="font-weight: 600;"><%= film.video.filename %></div>
                <div style="font-size: 13px; color: var(--muted);"><%= number_to_human_size(film.video.byte_size) %></div>
              </div>
            </div>
            <a class="toggle-upload-link" onclick="toggleVideoUpload()">Replace video</a>
          </div>
          <div id="video-field-wrapper" style="display: none;">
            <%= f.file_field :video, direct_upload: true, accept: "video/*", id: "film_video_input" %>
            <div class="help-text">Upload a new video file (MP4, MOV, etc.)</div>
          </div>
        <% else %>
          <%= f.file_field :video, direct_upload: true, accept: "video/*", id: "film_video_input", disabled: true %>
          <div class="help-text" style="color: #ff9966; font-weight: 600;">‚ö†Ô∏è FEATURE COMING SOON! Video uploads are temporarily disabled for legal compliance. Please use YouTube or Vimeo URL below.</div>
        <% end %>
      </div>

      <div class="form-group" id="youtube-url-group">
        <%= f.label :youtube_url, "Video URL (Required - YouTube or Vimeo)" %>
        <%= f.text_field :youtube_url, placeholder: "https://www.youtube.com/watch?v=... or https://vimeo.com/...", id: "youtube_url_input" %>
        <div class="help-text">Enter the full YouTube or Vimeo URL for your film. Video uploads are temporarily disabled.</div>
      </div>

      <div class="form-group">
        <%= f.label :thumbnail %>
        <%= f.file_field :thumbnail, direct_upload: true %>
        <div class="help-text">Optional: Auto-downloaded and stored from YouTube URL, or auto-generated from uploaded video if not provided.</div>
      </div>

      <div class="form-group">
        <%= f.label :aspect_ratio, "Aspect Ratio" %>
        <%= f.select :aspect_ratio,
          [
            ['16:9 (Standard Widescreen)', '16:9'],
            ['4:3 (Standard)', '4:3'],
            ['9:16 (Vertical/Portrait)', '9:16'],
            ['4:5 (Portrait)', '4:5'],
            ['21:9 (Ultrawide)', '21:9']
          ],
          { include_blank: 'Auto-detect from video' },
          { class: 'searchable-select' }
        %>
        <div class="help-text">Auto-detected from video if left blank</div>
      </div>

      <div class="form-group">
        <%= f.label :film_type, "Film Type" %>
        <div style="display: grid; gap: 12px; margin-top: 8px;">
          <% Film::FILM_TYPES.each do |type| %>
            <label style="display: flex; flex-direction: column; gap: 4px; cursor: pointer; padding: 10px; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <%= f.radio_button :film_type, type, checked: film.film_type == type || (film.new_record? && type == 'full_length'), class: "film-type-radio" %>
                <span style="font-weight: 600;"><%= type.titleize.gsub('_', ' ') %></span>
              </div>
              <div style="font-size: 13px; font-style: italic; color: var(--muted); margin-left: 28px;">
                <%= Film::FILM_TYPE_DESCRIPTIONS[type] %>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <div class="form-group" id="parent-film-field" style="display: none;">
        <%= f.label :parent_film_title, "Part of Full Length (Optional)" %>
        <%= f.text_field :parent_film_title, placeholder: "e.g., Deadline" %>
        <div class="help-text">If this video part is from a full length, enter the title here</div>
      </div>

      <div class="field-group">
        <h3 class="field-group-title">Companies & Crews</h3>
        <div class="form-group">
          <%= f.label :company_ids, "Search and select company/crew profiles" %>
          <div class="riders-search-wrapper">
            <input type="text"
                   id="companies-search-input"
                   class="riders-search-input"
                   placeholder="Type to search for companies or crews..."
                   autocomplete="off">
            <div class="autocomplete-results" id="companies-results"></div>
          </div>
          <div id="selected-companies-list" class="selected-riders-list"></div>
          <div id="companies-hidden-fields"></div>
          <div class="help-text">Search and click to add companies or crews to your film</div>
        </div>

        <div class="form-group">
          <%= f.label :company, "Or enter custom company/crew names" %>
          <%= f.text_field :company, placeholder: "Enter custom company/crew names (comma-separated) for non-registered companies or crews..." %>
          <div class="help-text">Comma-separated names for companies or crews who don't have user profiles</div>
        </div>
      </div>

      <div class="form-group">
        <%= f.label :release_date %>
        <%= f.date_field :release_date %>
      </div>

      <div class="field-group">
        <h3 class="field-group-title">Filmers</h3>
        <div class="form-group">
          <%= f.label :filmer_ids, "Search and select user profiles" %>
          <div class="riders-search-wrapper">
            <input type="text"
                   id="filmers-search-input"
                   class="riders-search-input"
                   placeholder="Type to search for filmers..."
                   autocomplete="off">
            <div class="autocomplete-results" id="filmers-results"></div>
          </div>
          <div id="selected-filmers-list" class="selected-riders-list"></div>
          <div id="filmers-hidden-fields"></div>
          <div class="help-text">Search and click to add filmers to your film</div>
        </div>

        <div class="form-group">
          <%= f.label :custom_filmer_name, "Or enter custom filmer names" %>
          <%= f.text_field :custom_filmer_name, placeholder: "Enter custom filmer names (comma-separated) for non-registered filmers..." %>
          <div class="help-text">Comma-separated names for filmers who don't have user profiles</div>
        </div>
      </div>

      <div class="field-group">
        <h3 class="field-group-title">Editor</h3>
        <div class="form-group">
          <%= f.label :editor_user_id, "Search for profile or enter custom name" %>
          <div class="autocomplete-wrapper" data-autocomplete-for="editor">
            <input type="text"
                   class="autocomplete-input"
                   placeholder="Type to search profiles or enter custom name..."
                   data-field="editor"
                   value="<%= @film.editor_display_name %>">
            <div class="autocomplete-results"></div>
          </div>
          <%= f.hidden_field :editor_user_id, class: "hidden-field" %>
          <%= f.hidden_field :custom_editor_name, class: "hidden-field" %>
          <div class="help-text">Search for a user profile or enter a custom name</div>
        </div>
      </div>

      <div class="field-group">
        <h3 class="field-group-title">Featured Riders</h3>
        <div class="form-group">
          <%= f.label :rider_ids, "Search and select user profiles" %>
          <div class="riders-search-wrapper">
            <input type="text"
                   id="riders-search-input"
                   class="riders-search-input"
                   placeholder="Type to search for riders..."
                   autocomplete="off">
            <div class="autocomplete-results" id="riders-results"></div>
          </div>
          <div id="selected-riders-list" class="selected-riders-list"></div>
          <div id="riders-hidden-fields"></div>
          <div class="help-text">Search and click to add riders to your film</div>
        </div>

        <div class="form-group">
          <%= f.label :custom_riders, "Or enter custom names" %>
          <%= f.text_area :custom_riders, placeholder: "Enter rider names (one per line) for riders without profiles..." %>
          <div class="help-text">One name per line for riders who don't have user profiles</div>
        </div>
      </div>

      <div class="form-group">
        <%= f.label :music_featured %>
        <%= f.text_area :music_featured, placeholder: "List songs and artists (one per line)..." %>
      </div>

      <div class="form-actions">
        <%= f.submit film.new_record? ? "Create Film" : "Update Film", class: "pill-btn primary" %>
        <%= link_to "Cancel", film.new_record? ? films_path : film_path(film), class: "pill-btn" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  console.log('=== FILM FORM SCRIPT STARTED ===');

  // Get user data for autocomplete (load ALL users)
  let users = [];
  let companyUsers = [];

  try {
    users = <%= User.order(:username).select(:id, :username, :profile_type).map { |u| { id: u.id, username: u.username, profile_type: u.profile_type } }.to_json.html_safe %>;
    companyUsers = users.filter(u => u.profile_type === 'company' || u.profile_type === 'crew');
    console.log('[Film Form] Successfully loaded ' + users.length + ' users for autocomplete');
    console.log('[Film Form] Company users: ' + companyUsers.length);
  } catch (error) {
    console.error('[Film Form] Failed to load users:', error);
  }

  function initForm() {
    // Film type toggle
    const radioButtons = document.querySelectorAll('.film-type-radio');
    const parentFilmField = document.getElementById('parent-film-field');

    function toggleParentFilmField() {
      const selectedType = document.querySelector('.film-type-radio:checked')?.value;
      if (selectedType === 'rider_part' || selectedType === 'mixtape' || selectedType === 'b_sides') {
        parentFilmField.style.display = 'block';
      } else {
        parentFilmField.style.display = 'none';
      }
    }

    radioButtons.forEach(radio => {
      radio.addEventListener('change', toggleParentFilmField);
    });
    toggleParentFilmField();

    // Initialize autocomplete for editor only (filmers and companies now use multi-select)
    initAutocomplete();

    // Initialize multi-select search for riders, filmers, and companies
    initRidersSearch();
    initFilmersSearch();
    initCompaniesSearch();

    // Initialize mutual exclusivity for video upload and YouTube URL
    initVideoSourceExclusivity();
  }

  // Make video upload and YouTube URL mutually exclusive
  // NOTE: Video uploads are temporarily disabled for legal compliance
  function initVideoSourceExclusivity() {
    const videoInput = document.getElementById('film_video_input');
    const youtubeInput = document.getElementById('youtube_url_input');
    const videoUploadGroup = document.getElementById('video-upload-group');
    const youtubeUrlGroup = document.getElementById('youtube-url-group');

    if (!videoInput || !youtubeInput) return;

    // VIDEO UPLOADS ARE DISABLED - Do not re-enable the video input
    // Keep video input permanently disabled
    videoInput.disabled = true;

    // YouTube URL functionality remains active (no need to disable it)
    // Remove the mutual exclusivity since video uploads are disabled anyway

    // Legacy code kept for reference when re-enabling video uploads:
    /*
    // Disable YouTube URL when video is selected
    videoInput.addEventListener('change', function() {
      if (this.files && this.files.length > 0) {
        youtubeInput.disabled = true;
        youtubeInput.style.opacity = '0.5';
        youtubeInput.style.cursor = 'not-allowed';
        youtubeUrlGroup.querySelector('.help-text').innerHTML = '<strong style="color: var(--accent);">Video upload selected. YouTube URL is disabled.</strong>';
      } else {
        youtubeInput.disabled = false;
        youtubeInput.style.opacity = '1';
        youtubeInput.style.cursor = '';
        youtubeUrlGroup.querySelector('.help-text').innerHTML = 'Instead of uploading, you can link to a YouTube or Vimeo video. Leave blank if uploading a file above.';
      }
    });

    // Disable video upload when YouTube URL is entered
    youtubeInput.addEventListener('input', function() {
      if (this.value.trim().length > 0) {
        videoInput.disabled = true;
        videoInput.style.opacity = '0.5';
        videoInput.style.cursor = 'not-allowed';
        const helpText = videoUploadGroup.querySelector('.help-text');
        if (helpText) {
          helpText.innerHTML = '<strong style="color: var(--accent);">YouTube or Vimeo URL entered. Video upload is disabled.</strong>';
        }
      } else {
        videoInput.disabled = false;
        videoInput.style.opacity = '1';
        videoInput.style.cursor = '';
        const helpText = videoUploadGroup.querySelector('.help-text');
        if (helpText) {
          helpText.innerHTML = 'Upload the full film video (MP4, MOV, etc.)';
        }
      }
    });

    // Check initial state
    if (youtubeInput.value.trim().length > 0) {
      youtubeInput.dispatchEvent(new Event('input'));
    }
    */
  }

  function initAutocomplete() {
    if (!users || users.length === 0) {
      console.error('[Film Form] No users loaded for autocomplete!');
      return;
    }

    const autocompleteInputs = document.querySelectorAll('.autocomplete-input');

    autocompleteInputs.forEach(input => {
      if (input.hasAttribute('data-initialized')) return;
      input.setAttribute('data-initialized', 'true');

      const field = input.getAttribute('data-field');
      const wrapper = input.closest('.autocomplete-wrapper');

      // Safety check: skip if wrapper not found
      if (!wrapper) return;

      const resultsDiv = wrapper.querySelector('.autocomplete-results');
      const userIdField = document.querySelector(`#film_${field}_user_id`);
      // For company, the custom field is just company, not custom_company_name
      const customFieldName = field === 'company' ? `#film_company` : `#film_custom_${field}_name`;
      const customNameField = document.querySelector(customFieldName);

      // Debug logging
      console.log(`[Editor Autocomplete] Initializing for field: ${field}`);
      console.log(`[Editor Autocomplete] userIdField found:`, !!userIdField);
      console.log(`[Editor Autocomplete] customNameField found:`, !!customNameField);
      console.log(`[Editor Autocomplete] users array length:`, users.length);

      // Safety check: skip if required fields not found
      if (!userIdField || !customNameField) {
        console.error(`[Editor Autocomplete] Missing required fields for ${field}`);
        return;
      }

      let selectedUserId = userIdField.value;
      let currentFocus = -1;

      // Show results on focus
      input.addEventListener('focus', function() {
        if (this.value.trim().length > 0) {
          showResults(this.value);
        }
      });

      // Filter as user types
      input.addEventListener('input', function() {
        const value = this.value;
        selectedUserId = null;
        userIdField.value = '';

        if (value.trim().length === 0) {
          hideResults();
          customNameField.value = '';
          return;
        }

        showResults(value);
        customNameField.value = value;
      });

      // Keyboard navigation and prevent form submission
      input.addEventListener('keydown', function(e) {
        const items = resultsDiv.querySelectorAll('.autocomplete-item:not(.no-results)');

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          currentFocus++;
          addActive(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          currentFocus--;
          addActive(items);
        } else if (e.key === 'Enter') {
          e.preventDefault(); // Prevent form submission
          if (currentFocus > -1 && items[currentFocus]) {
            items[currentFocus].click();
          } else {
            hideResults();
          }
        } else if (e.key === 'Escape') {
          hideResults();
        }
      });

      function showResults(searchTerm) {
        // Use companyUsers for company field, regular users for others
        const userList = field === 'company' ? companyUsers : users;
        console.log(`[${field}] Searching for "${searchTerm}" in ${userList.length} users`);

        const filtered = userList.filter(u =>
          u.username && u.username.toLowerCase().includes(searchTerm.toLowerCase())
        );

        console.log(`[${field}] Found ${filtered.length} matching users`);

        resultsDiv.innerHTML = '';
        currentFocus = -1;

        if (filtered.length === 0) {
          const message = field === 'company' ? 'No company profiles found' : 'No profiles found';
          resultsDiv.innerHTML = `<div class="autocomplete-item no-results">${message}</div>`;
        } else {
          filtered.forEach(user => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = user.username;
            div.addEventListener('click', function() {
              selectUser(user);
            });
            resultsDiv.appendChild(div);
          });
        }

        resultsDiv.classList.add('show');
      }

      function hideResults() {
        resultsDiv.classList.remove('show');
        currentFocus = -1;
      }

      function selectUser(user) {
        input.value = user.username;
        userIdField.value = user.id;
        customNameField.value = '';
        selectedUserId = user.id;
        hideResults();
      }

      function addActive(items) {
        if (!items || items.length === 0) return;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        items[currentFocus].classList.add('selected');
      }

      function removeActive(items) {
        items.forEach(item => item.classList.remove('selected'));
      }

      // Close results when clicking outside
      document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
          hideResults();
        }
      });
    });
  }

  // Initialize riders search with tag-based selection
  function initRidersSearch() {
    const searchInput = document.getElementById('riders-search-input');
    const resultsDiv = document.getElementById('riders-results');
    const selectedList = document.getElementById('selected-riders-list');
    const hiddenFieldsContainer = document.getElementById('riders-hidden-fields');

    if (!searchInput || !resultsDiv || !selectedList) {
      return;
    }

    // Prevent double-initialization
    if (searchInput.hasAttribute('data-initialized')) {
      return;
    }
    searchInput.setAttribute('data-initialized', 'true');

    const selectedRiders = new Map(); // Map of id -> {id, username}
    let currentFocus = -1;

    // Load existing selected riders from the film data - ONLY if film is persisted
    <% if @film.persisted? %>
      const existingRiderIds = <%= @film.rider_ids.to_json.html_safe %>;
      console.log('[Riders] Loading existing rider IDs:', existingRiderIds);
      existingRiderIds.forEach(riderId => {
        const rider = users.find(u => u.id === riderId);
        if (rider) {
          selectedRiders.set(rider.id, rider);
          console.log('[Riders] Added existing rider:', rider.username);
        } else {
          console.warn('[Riders] Could not find user for ID:', riderId);
        }
      });
    <% end %>
    renderSelectedRiders();

    // Show results on focus
    searchInput.addEventListener('focus', function() {
      if (this.value.trim().length > 0) {
        showResults(this.value);
      }
    });

    // Filter as user types
    searchInput.addEventListener('input', function() {
      const value = this.value.trim();

      if (value.length === 0) {
        hideResults();
        return;
      }

      showResults(value);
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
      const items = resultsDiv.querySelectorAll('.autocomplete-item:not(.no-results)');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentFocus++;
        addActive(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentFocus--;
        addActive(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentFocus > -1 && items[currentFocus]) {
          items[currentFocus].click();
        } else {
          hideResults();
        }
      } else if (e.key === 'Escape') {
        hideResults();
      }
    });

    function showResults(searchTerm) {
      if (!users || users.length === 0) {
        console.error('[Riders] No users available for search!');
        resultsDiv.innerHTML = '<div class="autocomplete-item no-results">Loading users...</div>';
        resultsDiv.classList.add('show');
        return;
      }

      console.log(`[Riders] Searching for "${searchTerm}" in ${users.length} users`);

      const filtered = users.filter(u =>
        u.username && u.username.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !selectedRiders.has(u.id) // Don't show already selected riders
      );

      console.log(`[Riders] Found ${filtered.length} matching users (showing max 10)`);

      resultsDiv.innerHTML = '';
      currentFocus = -1;

      if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="autocomplete-item no-results">No riders found</div>';
      } else {
        filtered.slice(0, 10).forEach(user => { // Limit to 10 results
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = user.username;
          div.addEventListener('click', function() {
            addRider(user);
          });
          resultsDiv.appendChild(div);
        });
      }

      resultsDiv.classList.add('show');
    }

    function hideResults() {
      resultsDiv.classList.remove('show');
      currentFocus = -1;
    }

    function addRider(rider) {
      selectedRiders.set(rider.id, rider);
      renderSelectedRiders();
      searchInput.value = '';
      hideResults();
      searchInput.focus();
    }

    function removeRider(riderId) {
      selectedRiders.delete(riderId);
      renderSelectedRiders();
    }

    function renderSelectedRiders() {
      // Update visual list
      selectedList.innerHTML = '';
      selectedRiders.forEach((rider, id) => {
        const tag = document.createElement('div');
        tag.className = 'selected-rider-tag';
        tag.innerHTML = `
          <span>${rider.username}</span>
          <button type="button" class="remove-rider-btn" data-rider-id="${id}">√ó</button>
        `;
        selectedList.appendChild(tag);
      });

      // Update hidden fields for form submission
      hiddenFieldsContainer.innerHTML = '';

      // CRITICAL: Always include at least one field (even if empty) so Rails receives the parameter
      // This ensures Rails clears associations when array is empty
      if (selectedRiders.size === 0) {
        const emptyInput = document.createElement('input');
        emptyInput.type = 'hidden';
        emptyInput.name = 'film[rider_ids][]';
        emptyInput.value = '';
        hiddenFieldsContainer.appendChild(emptyInput);
      } else {
        selectedRiders.forEach((rider, id) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'film[rider_ids][]';
          input.value = id;
          hiddenFieldsContainer.appendChild(input);
        });
      }

      // Add event listeners to remove buttons
      selectedList.querySelectorAll('.remove-rider-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const riderId = parseInt(this.getAttribute('data-rider-id'));
          removeRider(riderId);
        });
      });
    }

    function addActive(items) {
      if (!items || items.length === 0) return;
      removeActive(items);
      if (currentFocus >= items.length) currentFocus = 0;
      if (currentFocus < 0) currentFocus = items.length - 1;
      items[currentFocus].classList.add('selected');
    }

    function removeActive(items) {
      items.forEach(item => item.classList.remove('selected'));
    }

    // Close results when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        hideResults();
      }
    });
  }

  // Initialize filmers search with tag-based selection
  function initFilmersSearch() {
    const searchInput = document.getElementById('filmers-search-input');
    const resultsDiv = document.getElementById('filmers-results');
    const selectedList = document.getElementById('selected-filmers-list');
    const hiddenFieldsContainer = document.getElementById('filmers-hidden-fields');

    if (!searchInput || !resultsDiv || !selectedList) {
      return;
    }

    // Prevent double-initialization
    if (searchInput.hasAttribute('data-initialized')) {
      return;
    }
    searchInput.setAttribute('data-initialized', 'true');

    const selectedFilmers = new Map();
    let currentFocus = -1;

    // Load existing selected filmers from the film data - ONLY if film is persisted
    <% if @film.persisted? %>
      const existingFilmerIds = <%= @film.filmer_ids.to_json.html_safe %>;
      console.log('[Filmers] Loading existing filmer IDs:', existingFilmerIds);
      existingFilmerIds.forEach(filmerId => {
        const filmer = users.find(u => u.id === filmerId);
        if (filmer) {
          selectedFilmers.set(filmer.id, filmer);
          console.log('[Filmers] Added existing filmer:', filmer.username);
        } else {
          console.warn('[Filmers] Could not find user for ID:', filmerId);
        }
      });
    <% end %>
    if (selectedFilmers.size > 0) {
      renderSelectedFilmers();
    }

    searchInput.addEventListener('focus', function() {
      if (this.value.trim().length > 0) {
        showResults(this.value);
      }
    });

    searchInput.addEventListener('input', function() {
      const value = this.value.trim();
      if (value.length === 0) {
        hideResults();
        return;
      }
      showResults(value);
    });

    searchInput.addEventListener('keydown', function(e) {
      const items = resultsDiv.querySelectorAll('.autocomplete-item:not(.no-results)');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentFocus++;
        addActive(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentFocus--;
        addActive(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentFocus > -1 && items[currentFocus]) {
          items[currentFocus].click();
        } else {
          hideResults();
        }
      } else if (e.key === 'Escape') {
        hideResults();
      }
    });

    function showResults(searchTerm) {
      const filtered = users.filter(u =>
        u.username && u.username.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !selectedFilmers.has(u.id)
      );
      resultsDiv.innerHTML = '';
      currentFocus = -1;
      if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="autocomplete-item no-results">No filmers found</div>';
      } else {
        filtered.slice(0, 10).forEach(user => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = user.username;
          div.addEventListener('click', function() {
            addFilmer(user);
          });
          resultsDiv.appendChild(div);
        });
      }
      resultsDiv.classList.add('show');
    }

    function hideResults() {
      resultsDiv.classList.remove('show');
      currentFocus = -1;
    }

    function addFilmer(filmer) {
      selectedFilmers.set(filmer.id, filmer);
      renderSelectedFilmers();
      searchInput.value = '';
      hideResults();
      searchInput.focus();
    }

    function removeFilmer(filmerId) {
      selectedFilmers.delete(filmerId);
      renderSelectedFilmers();
    }

    function renderSelectedFilmers() {
      selectedList.innerHTML = '';
      selectedFilmers.forEach((filmer, id) => {
        const tag = document.createElement('div');
        tag.className = 'selected-rider-tag';
        tag.innerHTML = `<span>${filmer.username}</span><button type="button" class="remove-filmer-btn" data-filmer-id="${id}">√ó</button>`;
        selectedList.appendChild(tag);
      });

      hiddenFieldsContainer.innerHTML = '';

      // CRITICAL: Always include at least one field (even if empty) so Rails receives the parameter
      if (selectedFilmers.size === 0) {
        const emptyInput = document.createElement('input');
        emptyInput.type = 'hidden';
        emptyInput.name = 'film[filmer_ids][]';
        emptyInput.value = '';
        hiddenFieldsContainer.appendChild(emptyInput);
      } else {
        selectedFilmers.forEach((filmer, id) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'film[filmer_ids][]';
          input.value = id;
          hiddenFieldsContainer.appendChild(input);
        });
      }

      selectedList.querySelectorAll('.remove-filmer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const filmerId = parseInt(this.getAttribute('data-filmer-id'));
          removeFilmer(filmerId);
        });
      });
    }

    function addActive(items) {
      if (!items || items.length === 0) return;
      removeActive(items);
      if (currentFocus >= items.length) currentFocus = 0;
      if (currentFocus < 0) currentFocus = items.length - 1;
      items[currentFocus].classList.add('selected');
    }

    function removeActive(items) {
      items.forEach(item => item.classList.remove('selected'));
    }

    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        hideResults();
      }
    });
  }

  // Initialize companies search with tag-based selection
  function initCompaniesSearch() {
    const searchInput = document.getElementById('companies-search-input');
    const resultsDiv = document.getElementById('companies-results');
    const selectedList = document.getElementById('selected-companies-list');
    const hiddenFieldsContainer = document.getElementById('companies-hidden-fields');

    if (!searchInput || !resultsDiv || !selectedList) {
      return;
    }

    // Prevent double-initialization
    if (searchInput.hasAttribute('data-initialized')) {
      return;
    }
    searchInput.setAttribute('data-initialized', 'true');

    const selectedCompanies = new Map();
    let currentFocus = -1;

    // Load existing selected companies from the film data - ONLY if film is persisted
    <% if @film.persisted? %>
      const existingCompanyIds = <%= @film.company_ids.to_json.html_safe %>;
      console.log('[Companies] Loading existing company IDs:', existingCompanyIds);
      existingCompanyIds.forEach(companyId => {
        const company = users.find(u => u.id === companyId);
        if (company) {
          selectedCompanies.set(company.id, company);
          console.log('[Companies] Added existing company:', company.username);
        } else {
          console.warn('[Companies] Could not find user for ID:', companyId);
        }
      });
    <% end %>
    if (selectedCompanies.size > 0) {
      renderSelectedCompanies();
    }

    searchInput.addEventListener('focus', function() {
      if (this.value.trim().length > 0) {
        showResults(this.value);
      }
    });

    searchInput.addEventListener('input', function() {
      const value = this.value.trim();
      if (value.length === 0) {
        hideResults();
        return;
      }
      showResults(value);
    });

    searchInput.addEventListener('keydown', function(e) {
      const items = resultsDiv.querySelectorAll('.autocomplete-item:not(.no-results)');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentFocus++;
        addActive(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentFocus--;
        addActive(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentFocus > -1 && items[currentFocus]) {
          items[currentFocus].click();
        } else {
          hideResults();
        }
      } else if (e.key === 'Escape') {
        hideResults();
      }
    });

    function showResults(searchTerm) {
      const filtered = companyUsers.filter(u =>
        u.username && u.username.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !selectedCompanies.has(u.id)
      );
      resultsDiv.innerHTML = '';
      currentFocus = -1;
      if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="autocomplete-item no-results">No companies or crews found</div>';
      } else {
        filtered.slice(0, 10).forEach(user => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = user.username;
          div.addEventListener('click', function() {
            addCompany(user);
          });
          resultsDiv.appendChild(div);
        });
      }
      resultsDiv.classList.add('show');
    }

    function hideResults() {
      resultsDiv.classList.remove('show');
      currentFocus = -1;
    }

    function addCompany(company) {
      selectedCompanies.set(company.id, company);
      renderSelectedCompanies();
      searchInput.value = '';
      hideResults();
      searchInput.focus();
    }

    function removeCompany(companyId) {
      selectedCompanies.delete(companyId);
      renderSelectedCompanies();
    }

    function renderSelectedCompanies() {
      selectedList.innerHTML = '';
      selectedCompanies.forEach((company, id) => {
        const tag = document.createElement('div');
        tag.className = 'selected-rider-tag';
        tag.innerHTML = `<span>${company.username}</span><button type="button" class="remove-company-btn" data-company-id="${id}">√ó</button>`;
        selectedList.appendChild(tag);
      });

      hiddenFieldsContainer.innerHTML = '';

      // CRITICAL: Always include at least one field (even if empty) so Rails receives the parameter
      if (selectedCompanies.size === 0) {
        const emptyInput = document.createElement('input');
        emptyInput.type = 'hidden';
        emptyInput.name = 'film[company_ids][]';
        emptyInput.value = '';
        hiddenFieldsContainer.appendChild(emptyInput);
      } else {
        selectedCompanies.forEach((company, id) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'film[company_ids][]';
          input.value = id;
          hiddenFieldsContainer.appendChild(input);
        });
      }

      selectedList.querySelectorAll('.remove-company-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const companyId = parseInt(this.getAttribute('data-company-id'));
          removeCompany(companyId);
        });
      });
    }

    function addActive(items) {
      if (!items || items.length === 0) return;
      removeActive(items);
      if (currentFocus >= items.length) currentFocus = 0;
      if (currentFocus < 0) currentFocus = items.length - 1;
      items[currentFocus].classList.add('selected');
    }

    function removeActive(items) {
      items.forEach(item => item.classList.remove('selected'));
    }

    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        hideResults();
      }
    });
  }

  // Toggle video upload field when replacing
  function toggleVideoUpload() {
    const wrapper = document.getElementById('video-field-wrapper');
    if (wrapper) {
      wrapper.style.display = wrapper.style.display === 'none' ? 'block' : 'none';
    }
  }

  // Upload progress tracking
  function initUploadProgress() {
    const videoInput = document.getElementById('film_video_input');
    if (!videoInput) return;

    const overlay = document.getElementById('upload-progress-overlay');
    const progressBar = document.getElementById('overlay-progress-bar');
    const progressPercentage = document.getElementById('overlay-progress-percentage');
    const progressSize = document.getElementById('overlay-progress-size');
    const progressFilename = document.getElementById('overlay-progress-filename');
    const form = videoInput.closest('form');

    let progressInterval = null;
    let hasDirectUpload = false;

    // Listen for Active Storage direct upload events
    videoInput.addEventListener('direct-upload:initialize', event => {
      hasDirectUpload = true;
      console.log('Direct upload initialized');
    });

    videoInput.addEventListener('direct-upload:start', event => {
      console.log('Direct upload started');
    });

    videoInput.addEventListener('direct-upload:progress', event => {
      const { progress } = event.detail;
      const file = videoInput.files[0];

      if (progressBar && progressPercentage && file) {
        const percentage = Math.round(progress);
        const totalSize = file.size;
        const uploadedSize = (totalSize * progress) / 100;

        progressBar.style.width = percentage + '%';
        progressPercentage.textContent = percentage + '%';
        progressSize.textContent = formatBytes(uploadedSize) + ' / ' + formatBytes(totalSize);

        console.log('Progress:', percentage + '%');
      }
    });

    videoInput.addEventListener('direct-upload:error', event => {
      event.preventDefault();
      const { error } = event.detail;
      console.error('Upload error:', error);
      alert(`Upload failed: ${error}`);

      if (overlay) {
        overlay.classList.remove('active');
      }
      if (progressInterval) clearInterval(progressInterval);
    });

    videoInput.addEventListener('direct-upload:end', event => {
      console.log('Direct upload completed');
      if (progressInterval) clearInterval(progressInterval);

      // Set to 100%
      progressBar.style.width = '100%';
      progressPercentage.textContent = '100%';

      // Keep overlay visible for a moment
      setTimeout(() => {
        if (overlay) {
          overlay.classList.remove('active');
        }
      }, 1500);
    });

    // Form submit - start upload process
    if (form) {
      form.addEventListener('submit', event => {
        const file = videoInput.files[0];
        if (!file) return;

        console.log('Form submitting with file:', file.name);

        // Show overlay
        if (overlay && progressFilename) {
          overlay.classList.add('active');
          progressFilename.textContent = file.name;
          progressSize.textContent = '0 MB / ' + formatBytes(file.size);
        }

        // Start simulated progress (will be overridden by real progress if direct upload works)
        let progress = 0;
        const fileSize = file.size;
        const estimatedTimeMs = Math.min(fileSize / 100000, 60000); // Rough estimate: 1MB = 1 second, max 60s
        const incrementInterval = 300; // Update every 300ms
        const totalSteps = estimatedTimeMs / incrementInterval;
        const progressPerStep = 90 / totalSteps; // Only go to 90%, then wait for completion

        if (progressInterval) clearInterval(progressInterval);

        progressInterval = setInterval(() => {
          if (hasDirectUpload) {
            // Direct upload is handling it, stop simulated progress
            clearInterval(progressInterval);
            return;
          }

          progress += progressPerStep;
          if (progress >= 90) {
            progress = 90;
            clearInterval(progressInterval);
          }

          const uploadedSize = (fileSize * progress) / 100;
          progressBar.style.width = progress + '%';
          progressPercentage.textContent = Math.round(progress) + '%';
          progressSize.textContent = formatBytes(uploadedSize) + ' / ' + formatBytes(fileSize);
        }, incrementInterval);
      });
    }
  }

  function formatBytes(bytes, decimals = 1) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  }

  // Prevent Enter key from submitting the form
  function preventEnterSubmit() {
    const form = document.querySelector('.film-form');
    if (!form) return;

    form.addEventListener('keydown', function(e) {
      // Only prevent if Enter is pressed and target is not a textarea or submit button
      if (e.key === 'Enter' &&
          e.target.tagName !== 'TEXTAREA' &&
          e.target.type !== 'submit') {
        e.preventDefault();
        return false;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initForm();
    initUploadProgress();
    preventEnterSubmit();
  });

  document.addEventListener('turbo:load', () => {
    initForm();
    initUploadProgress();
    preventEnterSubmit();
  });
</script>
