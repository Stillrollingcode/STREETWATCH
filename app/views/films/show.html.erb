<% theme = user_theme_styles %>
<% content_for :head do %>
  <style>
    .film-shell {
      max-width: 900px;
      margin: 28px auto 60px;
      padding: 0 18px 40px;
      color: var(--text);
    }
    .film-detail-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    .film-hero {
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, <%= theme[:primary_rgba].sub('ALPHA', '0.3') %>, <%= theme[:secondary_rgba].sub('ALPHA', '0.3') %>); /* Fallback for Chrome <111 */
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 30%, transparent), color-mix(in srgb, var(--accent-2) 30%, transparent));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .film-hero img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .film-hero .placeholder {
      font-size: 80px;
      opacity: 0.3;
    }
    .video-player-wrapper {
      width: 100%;
      background: #000;
      aspect-ratio: <%= @film.aspect_ratio_css %>;
    }
    .video-js {
      width: 100%;
      height: 100%;
    }
    .video-js .vjs-big-play-button {
      border-color: var(--accent);
      background-color: <%= theme[:primary_rgba].sub('ALPHA', '0.8') %>; /* Fallback for Chrome <111 */
      background-color: color-mix(in srgb, var(--accent) 80%, transparent);
    }
    .video-js .vjs-big-play-button:hover {
      background-color: var(--accent);
    }
    .vjs-quality-button .vjs-menu-content {
      max-height: 300px;
      overflow-y: auto;
    }
    .vjs-quality-button .vjs-menu-item.vjs-selected {
      background-color: <%= theme[:primary_rgba].sub('ALPHA', '0.2') %>; /* Fallback for Chrome <111 */
      background-color: color-mix(in srgb, var(--accent) 20%, transparent);
      color: var(--accent);
    }
    .vjs-quality-button .vjs-menu-item:hover {
      background-color: <%= theme[:primary_rgba].sub('ALPHA', '0.1') %>; /* Fallback for Chrome <111 */
      background-color: color-mix(in srgb, var(--accent) 10%, transparent);
    }
    .film-content {
      padding: 24px;
      display: grid;
      gap: 20px;
    }
    .approval-banner {
      background: linear-gradient(120deg, rgba(255, 165, 0, 0.2), rgba(255, 140, 0, 0.2));
      border: 1px solid rgba(255, 165, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .approval-banner h3 {
      margin: 0 0 12px;
      font-size: 18px;
      color: hsl(39, 100%, 60%);
    }
    .approval-banner-text {
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    .approval-list {
      display: grid;
      gap: 8px;
      margin-bottom: 16px;
    }
    .approval-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    .approval-status {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .approval-status.pending {
      background: rgba(255, 165, 0, 0.3);
      color: hsl(39, 100%, 60%);
    }
    .approval-status.approved {
      background: rgba(76, 175, 80, 0.3);
      color: hsl(122, 39%, 60%);
    }
    .approval-item-text {
      flex: 1;
      font-size: 14px;
    }
    .approval-item-text strong {
      color: var(--text);
    }
    .film-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }
    .film-title-section h1 {
      margin: 0 0 8px;
      font-size: 32px;
      letter-spacing: 0.01em;
    }
    .film-company-tag {
      color: var(--accent);
      font-weight: 800;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .film-runtime {
      color: var(--muted);
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.02em;
    }

    .film-runtime button:hover,
    button.film-runtime:hover {
      color: var(--text) !important;
    }

    button.film-runtime:hover svg {
      opacity: 1 !important;
    }
    .film-rating {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .film-rating:hover {
      color: var(--text);
    }
    .film-rating-stars {
      display: flex;
      gap: 2px;
      color: hsl(45, 100%, 51%);
    }
    .film-rating-number {
      font-size: 14px;
    }
    .film-rating-count {
      font-size: 14px;
      opacity: 0.7;
    }
    .film-actions {
      display: flex;
      gap: 8px;
    }
    .film-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .meta-item {
      display: grid;
      gap: 4px;
    }
    .meta-label {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .meta-value {
      font-weight: 600;
      font-size: 15px;
    }
    .film-description {
      line-height: 1.6;
      color: var(--muted);
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 12px;
      color: var(--text);
    }
    .riders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }
    .rider-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      transition: all 0.15s ease;
    }
    .rider-card:hover {
      border-color: rgba(255,255,255,0.2);
    }
    .rider-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, <%= theme[:primary_rgba].sub('ALPHA', '0.4') %>, <%= theme[:secondary_rgba].sub('ALPHA', '0.4') %>); /* Fallback for Chrome <111 */
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 40%, transparent), color-mix(in srgb, var(--accent-2) 40%, transparent));
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      overflow: hidden;
    }
    .rider-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .rider-name {
      font-size: 13px;
      font-weight: 600;
    }

    /* Linked vs non-linked crew/rider styling */
    .crew-link {
      color: var(--accent) !important;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .crew-link:hover {
      color: <%= theme[:light_rgba].sub('ALPHA', '1') %> !important; /* Fallback for Chrome <111 */
      color: color-mix(in srgb, var(--accent) 80%, white) !important;
      text-decoration: underline;
    }

    .crew-text-only {
      color: var(--muted);
      cursor: default;
    }

    .film-company-tag .crew-link {
      color: var(--accent) !important;
    }

    .film-company-tag .crew-link:hover {
      color: <%= theme[:light_rgba].sub('ALPHA', '1') %> !important; /* Fallback for Chrome <111 */
      color: color-mix(in srgb, var(--accent) 80%, white) !important;
    }

    .rider-card.clickable {
      cursor: pointer;
    }

    .rider-card.clickable:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .rider-card.text-only {
      cursor: default;
      opacity: 0.7;
    }

    .rider-card.text-only .rider-name {
      color: var(--muted);
    }
    .music-list {
      background: rgba(255,255,255,0.02);
      border-radius: 10px;
      padding: 12px;
      color: var(--muted);
      white-space: pre-line;
      line-height: 1.5;
    }
    .social-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      border: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .favorite-btn, .playlist-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .favorite-btn:hover, .playlist-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.3);
    }
    .favorite-btn.favorited {
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.2') %>; /* Fallback for Chrome <111 */
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback for Chrome <111 */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
      color: var(--accent);
    }

    /* Share button and modal */
    .share-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .share-modal.active {
      display: flex;
    }

    .share-modal-content {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
    }

    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .share-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .share-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .share-close:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .share-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .share-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      color: var(--text);
    }

    .share-option:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .share-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .share-label {
      font-size: 13px;
      font-weight: 600;
    }

    .share-link-container {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .share-link-input {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      font-size: 14px;
      font-family: monospace;
      outline: none;
    }

    .share-copy-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    .share-copy-btn:hover {
      background: <%= theme[:light_rgba].sub('ALPHA', '1') %>; /* Fallback for Chrome <111 */
      background: color-mix(in srgb, var(--accent) 80%, white);
    }

    .share-copy-btn.copied {
      background: #10b981;
    }

    /* Reviews Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .reviews-modal-content {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* Review Form */
    .review-form-container {
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .review-form-container h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 16px 0;
    }

    .star-rating-input {
      margin-bottom: 16px;
    }

    .star-rating-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .star-rating-stars {
      display: flex;
      gap: 4px;
    }

    .star-input {
      width: 32px;
      height: 32px;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s ease;
    }

    .star-input:hover,
    .star-input.filled {
      color: hsl(45, 100%, 51%);
      transform: scale(1.1);
    }

    .review-comment-input {
      margin-bottom: 12px;
    }

    .review-comment-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .review-comment-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: all 0.2s ease;
    }

    .review-comment-textarea:focus {
      outline: none;
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback for Chrome <111 */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
      background: rgba(255,255,255,0.06);
    }

    .char-count {
      font-size: 12px;
      color: var(--muted);
      text-align: right;
      margin-bottom: 16px;
    }

    .char-count.over-limit {
      color: #ef4444;
    }

    .review-form-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .review-action-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .review-action-btn.primary {
      background: var(--accent);
      color: white;
    }

    .review-action-btn.primary:hover {
      background: <%= theme[:light_rgba].sub('ALPHA', '1') %>; /* Fallback for Chrome <111 */
      background: color-mix(in srgb, var(--accent) 80%, white);
    }

    .review-action-btn.secondary {
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .review-action-btn.secondary:hover {
      background: rgba(255,255,255,0.08);
    }

    .review-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Review Items */
    .review-item {
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
    }

    .review-item:last-child {
      border-bottom: none;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }

    .review-user {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .review-username {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .review-name {
      font-size: 13px;
      color: var(--muted);
    }

    .review-rating-display {
      display: flex;
      gap: 2px;
      color: hsl(45, 100%, 51%);
      font-size: 14px;
    }

    .review-comment {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      margin: 12px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .review-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }

    .review-date {
      font-size: 12px;
      color: var(--muted);
    }

    .review-actions {
      display: flex;
      gap: 8px;
    }

    .review-actions button {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .review-actions button:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .review-actions button.delete:hover {
      color: #ef4444;
    }

    .reviews-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 14px;
    }

    .comments-section {
      padding: 20px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .comment-form {
      margin-bottom: 20px;
    }
    .comment-form textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
    }
    .comment-form textarea:focus {
      outline: none;
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback for Chrome <111 */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .comments-list {
      display: grid;
      gap: 12px;
    }
    .comment {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .comment-author {
      font-weight: 700;
      color: var(--accent);
      font-size: 14px;
    }
    .comment-date {
      color: var(--muted);
      font-size: 12px;
    }
    .comment-body {
      color: var(--text);
      line-height: 1.5;
      font-size: 14px;
    }
    .comment-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .reply-btn {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background 0.15s ease;
    }
    .reply-btn:hover {
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.1') %>; /* Fallback for Chrome <111 */
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }
    .reply-form {
      margin-top: 12px;
      padding-left: 12px;
      border-left: 2px solid var(--border);
      display: none;
    }
    .reply-form.show {
      display: block;
    }
    .reply-form textarea {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
      margin-bottom: 6px;
    }
    .reply-form textarea:focus {
      outline: none;
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback for Chrome <111 */
      border-color: color-mix(in srgb, var(--accent) 50%, transparent);
    }
    .replies-section {
      margin-top: 12px;
      padding-left: 20px;
      border-left: 2px solid var(--border);
    }
    .reply-comment {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .reply-comment:last-child {
      margin-bottom: 0;
    }
    .playlist-selector {
      position: relative;
      display: inline-block;
    }
    .playlist-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .playlist-dropdown.show {
      display: block;
    }
    .playlist-item {
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-size: 14px;
    }
    .playlist-item:hover {
      background: rgba(255,255,255,0.08);
    }
    .create-playlist-link {
      display: block;
      padding: 8px 12px;
      text-align: center;
      color: var(--accent);
      text-decoration: none;
      border-top: 1px solid var(--border);
      margin-top: 4px;
      font-size: 13px;
      font-weight: 600;
    }
    .create-playlist-link:hover {
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.1') %>; /* Fallback for Chrome <111 */
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }
    .delete-btn {
      background: transparent !important;
      border: 2px solid <%= theme[:primary_rgba].sub('ALPHA', '0.8') %> !important; /* Fallback for Chrome <111 */
      border: 2px solid color-mix(in srgb, var(--accent) 80%, transparent) !important;
      color: var(--accent) !important; /* Fallback for Chrome <111 */
      color: color-mix(in srgb, var(--accent) 85%, var(--text) 15%) !important;
      transition: all 0.2s ease;
    }
    .delete-btn:hover {
      border-color: var(--accent) !important;
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.1') %> !important; /* Fallback for Chrome <111 */
      background: color-mix(in srgb, var(--accent) 10%, transparent) !important;
    }
    /* Film navigation bar */
    .film-nav-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255,255,255,0.04);
      border-top: 1px solid var(--border);
      gap: 12px;
    }
    .film-nav-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .film-nav-btn:hover {
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.15') %>; /* Fallback for Chrome <111 */
      background: color-mix(in srgb, var(--accent) 15%, transparent);
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.4') %>; /* Fallback for Chrome <111 */
      border-color: color-mix(in srgb, var(--accent) 40%, transparent);
      color: var(--accent);
    }
    .film-nav-center {
      flex: 1;
      text-align: center;
    }
    .film-nav-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .autoplay-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }
    .autoplay-toggle:hover {
      background: rgba(255,255,255,0.1);
    }
    .autoplay-toggle.active {
      background: <%= theme[:primary_rgba].sub('ALPHA', '0.2') %>;
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      border-color: <%= theme[:primary_rgba].sub('ALPHA', '0.4') %>;
      border-color: color-mix(in srgb, var(--accent) 40%, transparent);
      color: var(--accent);
    }
    .autoplay-toggle-icon {
      font-size: 14px;
    }
    @media (max-width: 480px) {
      .film-nav-bar {
        flex-wrap: wrap;
        gap: 8px;
      }
      .film-nav-btn {
        padding: 6px 12px;
        font-size: 13px;
      }
      .film-nav-center {
        order: -1;
        width: 100%;
        margin-bottom: 4px;
      }
      .film-nav-right {
        gap: 6px;
      }
      .autoplay-toggle {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
  </style>
<% end %>

<div class="film-shell">
  <div class="film-detail-card">
    <% if @film.youtube_url.present? %>
      <div class="video-player-wrapper">
        <% if @film.video_platform == :youtube %>
          <iframe
            id="youtube-player"
            src="https://www.youtube-nocookie.com/embed/<%= @film.youtube_video_id %>?autoplay=1&origin=<%= request.base_url %>&enablejsapi=1"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
            style="width: 100%; height: 100%;">
          </iframe>
          <div class="film-nav-bar" data-film-id="<%= @film.friendly_id %>"
               data-nav-context="<%= params[:nav_context] %>"
               data-nav-id="<%= params[:nav_id] %>"
               data-nav-sort="<%= params[:nav_sort] %>"
               data-nav-type="<%= params[:nav_type] %>">
            <a href="#" class="film-nav-btn prev-btn" style="visibility: hidden;">‚Üê Prev</a>
            <div class="film-nav-center">
              <a href="<%= @film.youtube_url %>" target="_blank" rel="noopener" class="pill-btn" style="display: inline-flex; align-items: center; gap: 6px;">
                <span>Watch on YouTube</span>
                <span>‚Üó</span>
              </a>
              <p style="color: var(--muted); font-size: 12px; margin: 8px 0 0;">
                Note: YouTube embedded videos may not load depending on channel settings
              </p>
            </div>
            <div class="film-nav-right">
              <button type="button" class="autoplay-toggle" id="autoplay-toggle" title="Auto-play next video when current finishes">
                <span class="autoplay-toggle-icon">‚ñ∂</span>
                <span>Autoplay</span>
              </button>
              <a href="#" class="film-nav-btn next-btn" style="visibility: hidden;">Next ‚Üí</a>
            </div>
          </div>
        <% elsif @film.video_platform == :vimeo %>
          <iframe
            id="vimeo-player"
            src="https://player.vimeo.com/video/<%= @film.vimeo_video_id %>?autoplay=1&title=0&byline=0&portrait=0"
            frameborder="0"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            style="width: 100%; height: 100%;">
          </iframe>
          <div class="film-nav-bar" data-film-id="<%= @film.friendly_id %>"
               data-nav-context="<%= params[:nav_context] %>"
               data-nav-id="<%= params[:nav_id] %>"
               data-nav-sort="<%= params[:nav_sort] %>"
               data-nav-type="<%= params[:nav_type] %>">
            <a href="#" class="film-nav-btn prev-btn" style="visibility: hidden;">‚Üê Prev</a>
            <div class="film-nav-center">
              <a href="<%= @film.youtube_url %>" target="_blank" rel="noopener" class="pill-btn" style="display: inline-flex; align-items: center; gap: 6px;">
                <span>Watch on Vimeo</span>
                <span>‚Üó</span>
              </a>
            </div>
            <div class="film-nav-right">
              <button type="button" class="autoplay-toggle" id="autoplay-toggle" title="Auto-play next video when current finishes">
                <span class="autoplay-toggle-icon">‚ñ∂</span>
                <span>Autoplay</span>
              </button>
              <a href="#" class="film-nav-btn next-btn" style="visibility: hidden;">Next ‚Üí</a>
            </div>
          </div>
        <% end %>
      </div>
    <% elsif @film.video.attached? %>
      <div class="video-player-wrapper">
        <video
          id="film-video-player"
          class="video-js vjs-big-play-centered"
          controls
          preload="auto"
          <% if @film.thumbnail.attached? %>
            poster="<%= url_for(@film.thumbnail) %>"
          <% end %>>
          <% # Add sources for all available qualities in order of preference (highest to lowest) %>
          <% if @film.video_4k.attached? %>
            <source src="<%= url_for(@film.video_4k) %>" type="video/mp4" label="4K" data-quality="4k">
          <% end %>
          <% if @film.video_2k.attached? %>
            <source src="<%= url_for(@film.video_2k) %>" type="video/mp4" label="2K" data-quality="2k">
          <% end %>
          <% if @film.video_1080p.attached? %>
            <source src="<%= url_for(@film.video_1080p) %>" type="video/mp4" label="1080p" data-quality="1080p">
          <% end %>
          <% if @film.video_720p.attached? %>
            <source src="<%= url_for(@film.video_720p) %>" type="video/mp4" label="720p" data-quality="720p">
          <% end %>
          <% if @film.video_480p.attached? %>
            <source src="<%= url_for(@film.video_480p) %>" type="video/mp4" label="480p" data-quality="480p">
          <% end %>
          <% if @film.video_360p.attached? %>
            <source src="<%= url_for(@film.video_360p) %>" type="video/mp4" label="360p" data-quality="360p">
          <% end %>
          <% # Fallback to original video %>
          <source src="<%= url_for(@film.video) %>" type="<%= @film.video.content_type %>" label="Original" data-quality="original">
          <p class="vjs-no-js">
            To view this video please enable JavaScript, and consider upgrading to a web browser that
            <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
          </p>
        </video>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var player = videojs('film-video-player', {
            fluid: true,
            autoplay: true,
            playbackRates: [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2],
            controlBar: {
              playbackRateMenuButton: true
            }
          });

          // Add quality selector manually
          var qualities = [];
          var videoElement = document.getElementById('film-video-player');
          var sources = videoElement.querySelectorAll('source');

          console.log('Found ' + sources.length + ' source elements');

          sources.forEach(function(source) {
            var quality = source.getAttribute('data-quality');
            var label = source.getAttribute('label');
            console.log('Source:', label, quality, source.getAttribute('src'));
            if (quality && label) {
              qualities.push({
                src: source.getAttribute('src'),
                type: source.getAttribute('type'),
                label: label,
                quality: quality
              });
            }
          });

          console.log('Total qualities found:', qualities.length);

          // Only add quality menu if multiple qualities exist
          if (qualities.length > 1) {
            console.log('Adding quality selector with', qualities.length, 'options');
            var MenuButton = videojs.getComponent('MenuButton');
            var MenuItem = videojs.getComponent('MenuItem');

            // ES6 class syntax for Video.js 7.x+
            class QualityMenuItem extends MenuItem {
              constructor(player, options) {
                super(player, options);
                this.src = options.src;
                this.quality = options.quality;
                this.label = options.label;
                this.selected(player.currentSrc() === this.src);
              }

              handleClick() {
                var currentTime = player.currentTime();
                var isPaused = player.paused();

                player.src({ src: this.src, type: 'video/mp4' });
                player.one('loadedmetadata', function() {
                  player.currentTime(currentTime);
                  if (!isPaused) {
                    player.play();
                  }
                });

                // Update selected state
                var items = this.parentComponent.items;
                items.forEach(function(item) {
                  item.selected(false);
                });
                this.selected(true);
              }
            }

            class QualityMenuButton extends MenuButton {
              constructor(player, options) {
                super(player, options);
                this.el().setAttribute('aria-label', 'Quality');
                this.controlText('Quality');
                this.addClass('vjs-quality-button');
              }

              createItems() {
                return qualities.map(function(quality) {
                  return new QualityMenuItem(player, quality);
                });
              }

              buildCSSClass() {
                return 'vjs-quality-button ' + super.buildCSSClass();
              }
            }

            videojs.registerComponent('QualityMenuButton', QualityMenuButton);
            player.getChild('controlBar').addChild('QualityMenuButton', {},
              player.getChild('controlBar').children().length - 1);
            console.log('Quality selector button added to control bar');
          } else {
            console.log('Skipping quality selector - only', qualities.length, 'quality available');
          }

          // Add custom slow-mo button
          var Button = videojs.getComponent('Button');

          class SlowMoButton extends Button {
            constructor(player, options) {
              super(player, options);
              this.controlText('Slow Motion (0.25x)');
              this.addClass('vjs-slow-mo-button');
            }

            handleClick() {
              var currentRate = player.playbackRate();
              if (currentRate === 0.25) {
                player.playbackRate(1);
                this.controlText('Slow Motion (0.25x)');
              } else {
                player.playbackRate(0.25);
                this.controlText('Normal Speed');
              }
            }
          }

          videojs.registerComponent('SlowMoButton', SlowMoButton);
          player.getChild('controlBar').addChild('SlowMoButton', {}, 12);
        });
      </script>

      <style>
        .vjs-slow-mo-button .vjs-icon-placeholder:before {
          content: "üêå";
          font-size: 1.5em;
          line-height: 1.9;
        }
        .vjs-quality-button .vjs-icon-placeholder:before {
          content: "HD";
          font-size: 1em;
          line-height: 2;
          font-weight: bold;
        }
        .vjs-quality-button .vjs-menu {
          background-color: rgba(17, 16, 21, 0.95);
          border: 1px solid var(--border);
        }
        .vjs-quality-button .vjs-menu-item {
          color: var(--text);
        }
        .vjs-quality-button .vjs-menu-item:hover,
        .vjs-quality-button .vjs-menu-item:focus {
          background-color: <%= theme[:primary_rgba].sub('ALPHA', '0.3') %>; /* Fallback for Chrome <111 */
          background-color: color-mix(in srgb, var(--accent) 30%, transparent);
        }
        .vjs-quality-button .vjs-menu-item.vjs-selected {
          background-color: <%= theme[:primary_rgba].sub('ALPHA', '0.5') %>; /* Fallback for Chrome <111 */
          background-color: color-mix(in srgb, var(--accent) 50%, transparent);
          color: var(--text);
        }
        .vjs-playback-rate .vjs-menu {
          background-color: rgba(17, 16, 21, 0.95);
          border: 1px solid var(--border);
        }
        .vjs-playback-rate .vjs-menu-item {
          color: var(--text);
        }
        .vjs-playback-rate .vjs-menu-item:hover,
        .vjs-playback-rate .vjs-menu-item:focus {
          background-color: rgba(176, 74, 42, 0.3);
        }
        .vjs-playback-rate .vjs-menu-item.vjs-selected {
          background-color: rgba(176, 74, 42, 0.5);
          color: var(--text);
        }
      </style>

      <div class="film-nav-bar" data-film-id="<%= @film.friendly_id %>"
           data-nav-context="<%= params[:nav_context] %>"
           data-nav-id="<%= params[:nav_id] %>"
           data-nav-sort="<%= params[:nav_sort] %>"
           data-nav-type="<%= params[:nav_type] %>">
        <a href="#" class="film-nav-btn prev-btn" style="visibility: hidden;">‚Üê Prev</a>
        <div class="film-nav-center"></div>
        <div class="film-nav-right">
          <button type="button" class="autoplay-toggle" id="autoplay-toggle" title="Auto-play next video when current finishes">
            <span class="autoplay-toggle-icon">‚ñ∂</span>
            <span>Autoplay</span>
          </button>
          <a href="#" class="film-nav-btn next-btn" style="visibility: hidden;">Next ‚Üí</a>
        </div>
      </div>
    <% else %>
      <div class="film-hero">
        <% if @film.thumbnail.attached? %>
          <%= image_tag @film.thumbnail %>
        <% elsif @film.youtube_thumbnail_url %>
          <%= image_tag @film.youtube_thumbnail_url, alt: @film.title %>
        <% else %>
          <div class="placeholder">üé¨</div>
        <% end %>
      </div>
    <% end %>

    <div class="film-content">
      <% if user_signed_in? && @film.pending_approvals.any? %>
        <div class="approval-banner">
          <h3>‚è≥ Pending Approval</h3>
          <p class="approval-banner-text">
            This film is waiting for approval from the following tagged profiles before it can be published:
          </p>
          <div class="approval-list">
            <% @film.film_approvals.each do |approval| %>
              <div class="approval-item">
                <div class="approval-status <%= approval.status %>">
                  <%= approval.status == 'approved' ? '‚úì' : '‚è≥' %>
                </div>
                <div class="approval-item-text">
                  <% approver_name = approval.approver.name.presence || approval.approver.username %>
                  <strong><%= link_to approver_name, user_path(approval.approver), style: "color: var(--accent); text-decoration: none;" %></strong>
                  (tagged as <%= approval.approval_type.titleize %>)
                  <% if approval.status == 'pending' && approval.approver_id == current_user.id %>
                    - <%= button_to "Approve now", approve_film_approval_path(approval), method: :post, style: "color: var(--accent); background: none; border: none; padding: 0; font: inherit; cursor: pointer; text-decoration: underline;" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          <% if @film.pending_approvals.any? { |a| a.approver_id == current_user.id } %>
            <p class="approval-banner-text" style="margin-bottom: 0; font-style: italic;">
              You can approve your tag from your <%= link_to "Content Approvals", film_approvals_path, style: "color: var(--accent);" %> page.
            </p>
          <% end %>
        </div>
      <% end %>

      <% if user_signed_in? && @film.user_id == current_user.id && @film.pending_tag_requests.any? %>
        <div class="approval-banner" style="background: rgba(var(--accent-rgb), 0.1); border-color: var(--accent);">
          <p class="approval-banner-text">
            <strong>Tag Requests</strong> - Users have requested to be tagged in this film:
          </p>
          <div class="approval-list">
            <% @film.pending_tag_requests.each do |tag_request| %>
              <div class="approval-item" style="padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; margin-bottom: 8px;">
                <div class="approval-item-text" style="display: flex; flex-direction: column; gap: 6px;">
                  <div>
                    <% requester_name = tag_request.requester.name.presence || tag_request.requester.username %>
                    <strong><%= link_to requester_name, user_path(tag_request.requester), style: "color: var(--accent); text-decoration: none;" %></strong>
                    wants to be tagged as <strong><%= tag_request.role.titleize %></strong>
                  </div>
                  <% if tag_request.message.present? %>
                    <div style="font-size: 13px; color: var(--muted); font-style: italic;">
                      "<%= tag_request.message %>"
                    </div>
                  <% end %>
                  <div style="display: flex; gap: 8px; margin-top: 4px;">
                    <%= button_to "Approve", approve_tag_request_path(tag_request), method: :post, style: "padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;" %>
                    <%= button_to "Deny", deny_tag_request_path(tag_request), method: :post, style: "padding: 6px 12px; background: rgba(255,255,255,0.1); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px;" %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="film-header-row">
        <div class="film-title-section">
          <h1><%= @film.title %></h1>
          <div class="film-company-tag">
            <%
              company_users = @film.companies.to_a
              if @film.company_user && company_users.none? { |u| u.id == @film.company_user_id }
                company_users << @film.company_user
              end
              custom_company_names = @film.company.to_s.split(',').map(&:strip).reject(&:blank?)
              company_entries = []
              company_users.each do |user|
                label = user.name.presence || user.username
                company_entries << { label: label, user: user, key: "user-#{user.id}" }
              end
              custom_company_names.each do |name|
                company_entries << { label: name, user: nil, key: "custom-#{name.downcase}" }
              end
              company_entries = company_entries.uniq { |entry| entry[:key] }
            %>
            <% if company_entries.any? %>
              <% company_entries.each_with_index do |entry, index| %>
                <% if entry[:user] %>
                  <%= link_to entry[:label], user_path(entry[:user]), class: "crew-link" %><%= index < company_entries.length - 1 ? ',' : '' %>
                <% else %>
                  <span class="crew-text-only"><%= entry[:label] %><%= index < company_entries.length - 1 ? ',' : '' %></span>
                <% end %>
              <% end %>
            <% end %>
            <% if @film.runtime.present? %>
              <span class="film-runtime"><%= @film.formatted_runtime %></span>
            <% end %>
            <span class="film-runtime">‚ô• <%= @film.favorites.count %></span>
            <span class="film-runtime" style="display: flex; align-items: center; gap: 4px;">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.8;">
                <path d="M8 3C4.5 3 1.73 5.11 1 8c.73 2.89 3.5 5 7 5s6.27-2.11 7-5c-.73-2.89-3.5-5-7-5zm0 8.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7zm0-5.5a2 2 0 100 4 2 2 0 000-4z"/>
              </svg>
              <%= @film.views_count %>
            </span>
            <% if @film.review_count > 0 %>
              <span class="film-rating" onclick="toggleReviewsModal()">
                <span class="film-rating-stars">
                  <% full_stars = @film.average_rating.floor %>
                  <% half_star = (@film.average_rating - full_stars) >= 0.5 %>
                  <% empty_stars = 5 - full_stars - (half_star ? 1 : 0) %>

                  <% full_stars.times do %>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  <% end %>

                  <% if half_star %>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/>
                    </svg>
                  <% end %>

                  <% empty_stars.times do %>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  <% end %>
                </span>
                <span class="film-rating-number"><%= number_with_precision(@film.average_rating, precision: 1) %></span>
                <span class="film-rating-count">(<%= @film.review_count %>)</span>
              </span>
            <% end %>
            <button type="button" class="film-runtime" onclick="toggleShareModal()" style="display: flex; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; color: var(--muted); font-weight: 600; font-size: 16px; letter-spacing: 0.02em; padding: 0; transition: color 0.2s ease;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.8;">
                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
              </svg>
              Share
            </button>
          </div>
        </div>
        <% if user_signed_in? && @film.user_id == current_user.id %>
          <div class="film-actions">
            <%= link_to "Edit", edit_film_path(@film), class: "pill-btn" %>
          </div>
        <% end %>
      </div>

      <% if user_signed_in? %>
        <div class="social-actions">
          <% favorite = current_user.favorites.find_by(film: @film) %>
          <% if favorite %>
            <%= button_to film_favorite_path(@film), method: :delete, class: "favorite-btn favorited" do %>
              ‚ô• Favorited
            <% end %>
          <% else %>
            <%= button_to film_favorite_path(@film), method: :post, class: "favorite-btn" do %>
              ‚ô° Add to Favorites
            <% end %>
          <% end %>

          <div class="playlist-selector">
            <button type="button" class="playlist-btn" onclick="togglePlaylistDropdown()">
              ‚ûï Add to Playlist
            </button>
            <div class="playlist-dropdown" id="playlistDropdown">
              <% if current_user.playlists.any? %>
                <% current_user.playlists.recent.each do |playlist| %>
                  <% if playlist.films.include?(@film) %>
                    <div class="playlist-item" style="opacity: 0.5; cursor: default;">
                      ‚úì <%= playlist.name %>
                    </div>
                  <% else %>
                    <%= button_to add_film_playlist_path(playlist, film_id: @film.id), method: :post, class: "playlist-item", style: "text-decoration: none; color: inherit; display: block; background: none; border: none; cursor: pointer; width: 100%; text-align: left; padding: 12px 16px; font-family: inherit; font-size: inherit;" do %>
                      <%= playlist.name %>
                    <% end %>
                  <% end %>
                <% end %>
              <% else %>
                <div class="playlist-item" style="opacity: 0.5; text-align: center;">
                  No playlists yet
                </div>
              <% end %>
              <%= link_to "+ Create New Playlist", new_playlist_path(film_id: @film.id), class: "create-playlist-link" %>
            </div>
          </div>

          <button type="button" class="favorite-btn" onclick="toggleReviewsModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <%= @film.user_review(current_user) ? 'Edit Review' : 'Leave Review' %>
          </button>

          <% if @film.tagged_users.include?(current_user) %>
            <% if current_user.film_hidden_from_profile?(@film) %>
              <%= button_to unhide_from_profile_film_path(@film), method: :delete, class: "favorite-btn", style: "background: rgba(100, 100, 100, 0.2); display: flex; align-items: center; gap: 6px;" do %>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                  <path d="M8 3C4.5 3 1.73 5.11 1 8c.73 2.89 3.5 5 7 5s6.27-2.11 7-5c-.73-2.89-3.5-5-7-5zm0 8.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7zm0-5.5a2 2 0 100 4 2 2 0 000-4z" fill="currentColor"/>
                </svg>
                <span>Unhide from Profile</span>
              <% end %>
            <% else %>
              <%= button_to hide_from_profile_film_path(@film), method: :post, class: "favorite-btn", style: "background: rgba(100, 100, 100, 0.2); display: flex; align-items: center; gap: 6px;" do %>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink: 0;">
                  <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                </svg>
                <span>Hide from Profile</span>
              <% end %>
            <% end %>
          <% end %>

          <% unless @film.user_id == current_user.id || @film.tagged_users.include?(current_user) %>
            <button type="button" class="favorite-btn" onclick="toggleTagRequestModal()" style="background: rgba(var(--accent-rgb), 0.15); display: flex; align-items: center; gap: 6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink: 0;">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              <span>Request Tag</span>
            </button>
          <% end %>
        </div>
      <% end %>

      <div class="film-meta-grid">
        <% if @film.film_type.present? %>
          <div class="meta-item">
            <div class="meta-label">Type</div>
            <div class="meta-value"><%= @film.formatted_film_type %></div>
          </div>
        <% end %>
        <% if @film.parent_film_title.present? %>
          <div class="meta-item">
            <div class="meta-label">From</div>
            <div class="meta-value"><%= @film.parent_film_title %></div>
          </div>
        <% end %>
        <% if @film.release_date.present? %>
          <div class="meta-item">
            <div class="meta-label">Release Date</div>
            <div class="meta-value"><%= @film.release_date.strftime("%B %d, %Y") %></div>
          </div>
        <% end %>
        <% if @film.runtime.present? %>
          <div class="meta-item">
            <div class="meta-label">Runtime</div>
            <div class="meta-value"><%= @film.formatted_runtime %></div>
          </div>
        <% end %>
        <%
          filmer_users = @film.filmers.to_a
          if @film.filmer_user && filmer_users.none? { |u| u.id == @film.filmer_user_id }
            filmer_users << @film.filmer_user
          end
          custom_filmer_names = @film.custom_filmer_name.to_s.split(',').map(&:strip).reject(&:blank?)
          filmer_entries = []
          filmer_users.each do |user|
            label = user.name.presence || user.username
            filmer_entries << { label: label, user: user, key: "user-#{user.id}" }
          end
          custom_filmer_names.each do |name|
            filmer_entries << { label: name, user: nil, key: "custom-#{name.downcase}" }
          end
          filmer_entries = filmer_entries.uniq { |entry| entry[:key] }
        %>
        <% if filmer_entries.any? %>
          <div class="meta-item">
            <div class="meta-label"><%= filmer_entries.length == 1 ? 'Filmer' : 'Filmers' %></div>
            <div class="meta-value">
              <% filmer_entries.each_with_index do |entry, index| %>
                <% if entry[:user] %>
                  <%= link_to entry[:label], user_path(entry[:user]), class: "crew-link" %><%= index < filmer_entries.length - 1 ? ', ' : '' %>
                <% else %>
                  <span class="crew-text-only"><%= entry[:label] %></span><%= index < filmer_entries.length - 1 ? ', ' : '' %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
        <% if @film.editor_user.present? || @film.custom_editor_name.present? %>
          <div class="meta-item">
            <div class="meta-label">Editor</div>
            <div class="meta-value">
              <% if @film.editor_user %>
                <% editor_label = @film.editor_user.name.presence || @film.editor_user.username %>
                <%= link_to editor_label, user_path(@film.editor_user), class: "crew-link" %>
              <% else %>
                <span class="crew-text-only"><%= @film.custom_editor_name %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <% if @film.description.present? %>
        <div>
          <h2 class="section-title">About</h2>
          <div class="film-description"><%= @film.description %></div>
        </div>
      <% end %>

      <% if @film.all_riders_display.any? %>
        <div>
          <h2 class="section-title">Featured Riders</h2>
          <div class="riders-grid">
            <% @film.riders.each do |rider| %>
              <%= link_to user_path(rider), style: "text-decoration: none; color: inherit;" do %>
                <div class="rider-card clickable">
                  <div class="rider-avatar">
                    <% if rider.avatar.attached? %>
                      <%= image_tag rider.avatar %>
                    <% else %>
                      <%= (rider.name.presence || rider.username || rider.email).first&.upcase %>
                    <% end %>
                  </div>
                  <div class="rider-name"><%= rider.name.presence || rider.username %></div>
                </div>
              <% end %>
            <% end %>
            <% if @film.custom_riders.present? %>
              <% @film.custom_riders.split("\n").map(&:strip).reject(&:blank?).each do |custom_rider| %>
                <div class="rider-card text-only">
                  <div class="rider-avatar">
                    <%= custom_rider.first&.upcase %>
                  </div>
                  <div class="rider-name"><%= custom_rider %></div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @film.music_featured.present? %>
        <div>
          <h2 class="section-title">Music Featured</h2>
          <div class="music-list"><%= @film.music_featured %></div>
        </div>
      <% end %>

      <!-- Comments section - visible to everyone -->
      <div class="comments-section" id="comments">
        <h2 class="section-title">Comments (<%= @film.comments.count %>)</h2>

        <% if user_signed_in? %>
          <div class="comment-form">
            <%= form_with model: [@film, Comment.new], url: film_comments_path(@film), data: { turbo: false } do |f| %>
              <%= f.text_area :body, placeholder: "Share your thoughts...", required: true %>
              <%= f.submit "Post Comment", class: "pill-btn" %>
            <% end %>
          </div>
        <% else %>
          <div class="comment-form" style="padding: 20px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid var(--border);">
            <p style="color: var(--muted); margin: 0 0 12px;">
              <%= link_to "Sign in", new_user_session_path, style: "color: var(--accent); text-decoration: none;" %> to join the conversation
            </p>
          </div>
        <% end %>

        <div class="comments-list">
            <% @film.comments.top_level.recent.each do |comment| %>
              <div class="comment" id="comment-<%= comment.id %>">
                <div class="comment-header">
                  <div>
                    <div class="comment-author"><%= comment.user.username || comment.user.email %></div>
                    <div class="comment-date"><%= time_ago_in_words(comment.created_at) %> ago</div>
                  </div>
                </div>
                <div class="comment-body"><%= comment.body %></div>
                <% if user_signed_in? %>
                  <div class="comment-actions">
                    <button class="reply-btn" onclick="toggleReplyForm(<%= comment.id %>)">Reply</button>
                    <% if comment.user == current_user || can_delete_comment?(current_user, @film, comment) %>
                      <%= button_to "Delete", film_comment_path(@film, comment), method: :delete,
                            data: { confirm: "Are you sure?", turbo_confirm: "Are you sure?" },
                            class: "pill-btn", style: "font-size: 12px; padding: 4px 10px;" %>
                    <% end %>
                  </div>

                  <!-- Reply form -->
                  <div class="reply-form" id="reply-form-<%= comment.id %>">
                    <%= form_with model: [@film, Comment.new], url: film_comments_path(@film), data: { turbo: false } do |f| %>
                      <%= f.hidden_field :parent_id, value: comment.id %>
                      <%= f.text_area :body, placeholder: "Write a reply...", required: true %>
                      <div style="display: flex; gap: 8px;">
                        <%= f.submit "Post Reply", class: "pill-btn", style: "font-size: 12px; padding: 6px 12px;" %>
                        <button type="button" class="pill-btn" style="font-size: 12px; padding: 6px 12px;" onclick="toggleReplyForm(<%= comment.id %>)">Cancel</button>
                      </div>
                    <% end %>
                  </div>
                <% end %>

                <!-- Replies -->
                <% if comment.replies.any? %>
                  <div class="replies-section">
                    <% comment.replies.recent.each do |reply| %>
                      <div class="reply-comment">
                        <div class="comment-header">
                          <div>
                            <div class="comment-author"><%= reply.user.username || reply.user.email %></div>
                            <div class="comment-date"><%= time_ago_in_words(reply.created_at) %> ago</div>
                          </div>
                        </div>
                        <div class="comment-body"><%= reply.body %></div>
                        <% if user_signed_in? && (reply.user == current_user || can_delete_comment?(current_user, @film, reply)) %>
                          <div class="comment-actions">
                            <%= button_to "Delete", film_comment_path(@film, reply), method: :delete,
                                  data: { confirm: "Are you sure?", turbo_confirm: "Are you sure?" },
                                  class: "pill-btn", style: "font-size: 12px; padding: 4px 10px;" %>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>

            <% if @film.comments.none? %>
              <div style="text-align: center; color: var(--muted); padding: 20px;">
                No comments yet. Be the first to share your thoughts!
              </div>
            <% end %>
          </div>
        </div>
    </div>
  </div>

  <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
    <%= link_to "‚Üê Back to Films", films_path, class: "pill-btn" %>
    <% if user_signed_in? && @film.user_id == current_user.id %>
      <%= button_to "Delete Film", film_path(@film), method: :delete,
            data: { confirm: "Are you sure you want to delete this film?", turbo_confirm: "Are you sure?" },
            class: "pill-btn delete-btn",
            style: "margin-left: auto;" %>
    <% end %>
  </div>
</div>

<% if user_signed_in? && @film.user_id != current_user.id && !@film.tagged_users.include?(current_user) %>
  <div id="tagRequestModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; backdrop-filter: blur(4px);">
    <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 32px; max-width: 500px; width: 90%;">
      <h2 style="margin: 0 0 20px; font-size: 24px;">Request Tag</h2>
      <%= form_with model: TagRequest.new, url: film_tag_requests_path(@film), method: :post do |f| %>
        <div style="margin-bottom: 20px;">
          <%= f.label :role, "Select your role", style: "display: block; margin-bottom: 8px; font-weight: 600;" %>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <%= f.radio_button :role, 'rider', style: "margin: 0;" %>
              <span>Rider</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <%= f.radio_button :role, 'filmer', style: "margin: 0;" %>
              <span>Filmer</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <%= f.radio_button :role, 'company', style: "margin: 0;" %>
              <span>Company</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <%= f.radio_button :role, 'editor', style: "margin: 0;" %>
              <span>Editor</span>
            </label>
          </div>
        </div>
        <div style="margin-bottom: 24px;">
          <%= f.label :message, "Message (optional)", style: "display: block; margin-bottom: 8px; font-weight: 600;" %>
          <%= f.text_area :message, placeholder: "Add a note about your involvement...", rows: 3, style: "width: 100%; padding: 12px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; resize: vertical;" %>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" onclick="toggleTagRequestModal()" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-weight: 600;">
            Cancel
          </button>
          <%= f.submit "Submit Request", style: "padding: 10px 20px; background: var(--accent); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<script>
  function togglePlaylistDropdown() {
    const dropdown = document.getElementById('playlistDropdown');
    dropdown.classList.toggle('show');
  }

  function toggleReplyForm(commentId) {
    const replyForm = document.getElementById('reply-form-' + commentId);
    if (replyForm) {
      replyForm.classList.toggle('show');
      if (replyForm.classList.contains('show')) {
        const textarea = replyForm.querySelector('textarea');
        if (textarea) textarea.focus();
      }
    }
  }

  function toggleTagRequestModal() {
    const modal = document.getElementById('tagRequestModal');
    if (modal) {
      if (modal.style.display === 'none' || !modal.style.display) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      } else {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    }
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    const selector = document.querySelector('.playlist-selector');
    const dropdown = document.getElementById('playlistDropdown');
    if (dropdown && selector && !selector.contains(event.target)) {
      dropdown.classList.remove('show');
    }

    // Close modal when clicking outside
    const modal = document.getElementById('tagRequestModal');
    if (modal && event.target === modal) {
      toggleTagRequestModal();
    }

    // Close share modal when clicking outside
    const shareModal = document.getElementById('shareModal');
    if (shareModal && event.target === shareModal) {
      toggleShareModal();
    }
  });

  // Share modal functions
  function toggleShareModal() {
    const modal = document.getElementById('shareModal');
    modal.classList.toggle('active');
  }

  function copyShareLink() {
    const input = document.getElementById('shareLink');
    input.select();
    input.setSelectionRange(0, 99999); // For mobile

    // Copy to clipboard
    navigator.clipboard.writeText(input.value).then(() => {
      const btn = document.getElementById('copyBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      btn.classList.add('copied');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('copied');
      }, 2000);
    });
  }

  function shareToSocial(platform) {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent("<%= j @film.title %>");
    const text = encodeURIComponent("Check out <%= j @film.title %> on StreetWatch!");

    let shareUrl;

    switch(platform) {
      case 'facebook':
        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        break;
      case 'twitter':
        shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
        break;
      case 'instagram':
        // Instagram doesn't support direct web sharing, show copy link instead
        copyShareLink();
        alert('Link copied! Paste it in your Instagram bio, story, or DM.');
        return;
      case 'tiktok':
        // TikTok doesn't support direct web sharing, show copy link instead
        copyShareLink();
        alert('Link copied! Share it in your TikTok bio or description.');
        return;
    }

    if (shareUrl) {
      window.open(shareUrl, '_blank', 'width=600,height=400');
    }
  }
</script>

<!-- Share Modal -->
<div class="share-modal" id="shareModal">
  <div class="share-modal-content">
    <div class="share-modal-header">
      <div class="share-modal-title">Share <%= @film.title %></div>
      <button type="button" class="share-close" onclick="toggleShareModal()">√ó</button>
    </div>

    <div class="share-options">
      <a href="#" class="share-option" onclick="event.preventDefault(); shareToSocial('facebook');">
        <div class="share-icon" style="color: #1877F2;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </div>
        <div class="share-label">Facebook</div>
      </a>

      <a href="#" class="share-option" onclick="event.preventDefault(); shareToSocial('twitter');">
        <div class="share-icon" style="color: #1DA1F2;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
          </svg>
        </div>
        <div class="share-label">Twitter</div>
      </a>

      <a href="#" class="share-option" onclick="event.preventDefault(); shareToSocial('instagram');">
        <div class="share-icon" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="url(#instagram-gradient)">
            <defs>
              <linearGradient id="instagram-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#f09433;stop-opacity:1" />
                <stop offset="25%" style="stop-color:#e6683c;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#dc2743;stop-opacity:1" />
                <stop offset="75%" style="stop-color:#cc2366;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#bc1888;stop-opacity:1" />
              </linearGradient>
            </defs>
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
          </svg>
        </div>
        <div class="share-label">Instagram</div>
      </a>

      <a href="#" class="share-option" onclick="event.preventDefault(); shareToSocial('tiktok');">
        <div class="share-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
          </svg>
        </div>
        <div class="share-label">TikTok</div>
      </a>
    </div>

    <div class="share-link-container">
      <input type="text"
             class="share-link-input"
             id="shareLink"
             value="<%= film_url(@film) %>"
             readonly>
      <button type="button"
              class="share-copy-btn"
              id="copyBtn"
              onclick="copyShareLink()">
        Copy Link
      </button>
    </div>
  </div>
</div>
</script>

<!-- Reviews Modal -->
<div id="reviews-modal" class="modal-overlay" style="display: none;">
  <div class="modal-content reviews-modal-content">
    <div class="modal-header">
      <h2>Reviews</h2>
      <button type="button" class="modal-close" onclick="toggleReviewsModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div id="reviews-list"></div>
    </div>
  </div>
</div>

<script>
(function() {
  // Reviews Modal JavaScript - wrapped in IIFE to prevent Turbo variable conflicts
  const filmId = '<%= @film.friendly_id || @film.id %>';
  let currentUserReview = null;
  let allReviews = [];

  function toggleReviewsModal() {
    const modal = document.getElementById('reviews-modal');
    if (modal.style.display === 'none') {
      modal.style.display = 'flex';
      loadReviews();
    } else {
      modal.style.display = 'none';
    }
  }

  // Expose functions globally for onclick handlers
  window.toggleReviewsModal = toggleReviewsModal;

  function loadReviews() {
    fetch(`/films/${filmId}/film_reviews`, {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(reviews => {
      allReviews = reviews;
      <% if user_signed_in? %>
        currentUserReview = reviews.find(r => r.user_id === <%= current_user.id %>);
      <% else %>
        currentUserReview = null;
      <% end %>
      renderReviews(reviews);
    })
    .catch(error => {
      console.error('Error loading reviews:', error);
      document.getElementById('reviews-list').innerHTML = '<p style="text-align: center; color: var(--muted);">Error loading reviews</p>';
    });
  }

  function renderReviews(reviews) {
    const reviewsList = document.getElementById('reviews-list');

    let html = '';

    <% if user_signed_in? %>
      // Add review form at top if user hasn't reviewed yet
      if (!currentUserReview) {
        html += `
          <div class="review-form-container" id="review-form-container">
            <h3>Write a Review</h3>
            ${renderReviewForm()}
          </div>
        `;
      }
    <% end %>

    // Render all reviews
    if (reviews.length === 0) {
      <% if user_signed_in? %>
        html += '<div class="reviews-empty">Be the first to review this film!</div>';
      <% else %>
        html += '<div class="reviews-empty">No reviews yet. <a href="<%= new_user_session_path %>">Sign in</a> to write the first review!</div>';
      <% end %>
    } else {
      reviews.forEach(review => {
        html += `
          <div class="review-item" data-review-id="${review.id}">
            <div class="review-header">
              <div class="review-user">
                <a href="/users/${review.user_id}" class="review-username">@${escapeHtml(review.username)}</a>
                ${review.user_name ? `<span class="review-name">${escapeHtml(review.user_name)}</span>` : ''}
              </div>
              <div class="review-rating-display">
                ${renderStars(review.rating)}
              </div>
            </div>
            ${review.comment ? `<p class="review-comment">${escapeHtml(review.comment)}</p>` : ''}
            <div class="review-footer">
              <span class="review-date">${formatDate(review.created_at)}</span>
              ${review.can_edit ? `
                <div class="review-actions">
                  <button onclick="editReview(${review.id}, ${review.rating}, '${escapeHtml(review.comment || '')}')" class="review-action-btn">Edit</button>
                  <button onclick="deleteReview(${review.id})" class="review-action-btn delete">Delete</button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      });
    }

    reviewsList.innerHTML = html;
  }

  function renderReviewForm(rating = 0, comment = '', reviewId = null) {
    return `
      <form id="review-form" onsubmit="submitReview(event, ${reviewId})">
        <div class="star-rating-input">
          <span class="star-rating-label">Rating:</span>
          <div class="star-rating-stars">
            ${[1, 2, 3, 4, 5].map(i => `
              <svg class="star-input ${i <= rating ? 'active' : ''}" data-rating="${i}" onclick="setRating(${i})" width="28" height="28" viewBox="0 0 24 24" fill="${i <= rating ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            `).join('')}
          </div>
          <input type="hidden" id="rating-input" name="rating" value="${rating}" required>
        </div>
        <div class="review-comment-input">
          <label for="comment-input" class="review-comment-label">Comment (optional):</label>
          <textarea id="comment-input" name="comment" class="review-comment-textarea" maxlength="1000" rows="4" placeholder="Share your thoughts about this film...">${comment}</textarea>
          <span class="char-count"><span id="char-count">0</span>/1000</span>
        </div>
        <div class="review-form-actions">
          <button type="submit" class="pill-btn primary">Submit Review</button>
          ${reviewId ? `<button type="button" onclick="cancelEdit()" class="pill-btn">Cancel</button>` : ''}
        </div>
      </form>
    `;
  }

  let selectedRating = 0;

  function setRating(rating) {
    selectedRating = rating;
    document.getElementById('rating-input').value = rating;
    document.querySelectorAll('.star-input').forEach((star, index) => {
      if (index < rating) {
        star.classList.add('active');
        star.setAttribute('fill', 'currentColor');
      } else {
        star.classList.remove('active');
        star.setAttribute('fill', 'none');
      }
    });
  }

  function submitReview(event, reviewId = null) {
    event.preventDefault();

    const rating = document.getElementById('rating-input').value;
    const comment = document.getElementById('comment-input').value;

    if (!rating || rating < 1 || rating > 5) {
      alert('Please select a rating');
      return;
    }

    const url = reviewId
      ? `/films/${filmId}/film_reviews/${reviewId}`
      : `/films/${filmId}/film_reviews`;

    const method = reviewId ? 'PATCH' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || document.body.dataset.csrfToken
      },
      body: JSON.stringify({
        film_review: {
          rating: parseInt(rating),
          comment: comment
        }
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.errors) {
        alert(data.errors.join(', '));
      } else {
        loadReviews();
        // Reload page to update rating display
        window.location.reload();
      }
    })
    .catch(error => {
      console.error('Error submitting review:', error);
      alert('Error submitting review. Please try again.');
    });
  }

  function editReview(reviewId, rating, comment) {
    const reviewItem = document.querySelector(`[data-review-id="${reviewId}"]`);
    reviewItem.innerHTML = `
      <h3>Edit Review</h3>
      ${renderReviewForm(rating, comment, reviewId)}
    `;
    selectedRating = rating;
    updateCharCount();
  }

  function cancelEdit() {
    loadReviews();
  }

  function deleteReview(reviewId) {
    if (!confirm('Are you sure you want to delete this review?')) {
      return;
    }

    fetch(`/films/${filmId}/film_reviews/${reviewId}`, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || document.body.dataset.csrfToken
      }
    })
    .then(response => response.json())
    .then(data => {
      loadReviews();
      // Reload page to update rating display
      window.location.reload();
    })
    .catch(error => {
      console.error('Error deleting review:', error);
      alert('Error deleting review. Please try again.');
    });
  }

  function renderStars(rating) {
    let html = '';
    for (let i = 1; i <= 5; i++) {
      if (i <= Math.floor(rating)) {
        html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color: hsl(45, 100%, 51%);"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
      } else if (i - rating < 1 && i - rating > 0) {
        html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color: hsl(45, 100%, 51%);"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>';
      } else {
        html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: hsl(45, 100%, 51%);"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
      }
    }
    return html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);

    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;

    return date.toLocaleDateString();
  }

  function updateCharCount() {
    const commentInput = document.getElementById('comment-input');
    const charCount = document.getElementById('char-count');
    if (commentInput && charCount) {
      charCount.textContent = commentInput.value.length;
      commentInput.addEventListener('input', () => {
        charCount.textContent = commentInput.value.length;
      });
    }
  }

  // Update char count when form is rendered
  document.addEventListener('DOMContentLoaded', updateCharCount);

  // Close modal when clicking outside
  document.getElementById('reviews-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      toggleReviewsModal();
    }
  });
})(); // End IIFE
</script>

<script>
// Film navigation with autoplay support
(function() {
  let nextUrl = null;
  let autoplayEnabled = localStorage.getItem('filmAutoplay') === 'true';
  let ytPlayer = null;
  let vimeoPlayer = null;

  function updateAutoplayUI() {
    const toggle = document.getElementById('autoplay-toggle');
    if (toggle) {
      toggle.classList.toggle('active', autoplayEnabled);
    }
  }

  function goToNextFilm() {
    if (nextUrl && autoplayEnabled) {
      window.location.href = nextUrl;
    }
  }

  function setupYouTubePlayer() {
    const iframe = document.getElementById('youtube-player');
    if (!iframe || typeof YT === 'undefined') return;

    ytPlayer = new YT.Player('youtube-player', {
      events: {
        'onStateChange': function(event) {
          // YT.PlayerState.ENDED = 0
          if (event.data === 0) {
            goToNextFilm();
          }
        }
      }
    });
  }

  function setupVimeoPlayer() {
    const iframe = document.getElementById('vimeo-player');
    if (!iframe || typeof Vimeo === 'undefined') return;

    vimeoPlayer = new Vimeo.Player(iframe);
    vimeoPlayer.on('ended', function() {
      goToNextFilm();
    });
  }

  function setupVideoJsPlayer() {
    const videoElement = document.getElementById('film-video-player');
    if (!videoElement || typeof videojs === 'undefined') return;

    // Get the Video.js player instance
    const player = videojs.getPlayer('film-video-player');
    if (player) {
      player.on('ended', function() {
        goToNextFilm();
      });
    }
  }

  function loadFilmNavigation() {
    const navBar = document.querySelector('.film-nav-bar');
    if (!navBar || navBar.dataset.loaded) return;
    navBar.dataset.loaded = 'true';

    // Setup autoplay toggle
    const autoplayToggle = document.getElementById('autoplay-toggle');
    if (autoplayToggle) {
      updateAutoplayUI();
      autoplayToggle.addEventListener('click', function() {
        autoplayEnabled = !autoplayEnabled;
        localStorage.setItem('filmAutoplay', autoplayEnabled);
        updateAutoplayUI();
      });
    }

    // Delay navigation fetch to prioritize video loading
    setTimeout(() => {
      const filmId = navBar.dataset.filmId;
      const params = new URLSearchParams();
      if (navBar.dataset.navContext) params.set('nav_context', navBar.dataset.navContext);
      if (navBar.dataset.navId) params.set('nav_id', navBar.dataset.navId);
      if (navBar.dataset.navSort) params.set('nav_sort', navBar.dataset.navSort);
      if (navBar.dataset.navType) params.set('nav_type', navBar.dataset.navType);

      fetch(`/films/${filmId}/navigation?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
          const prevBtn = navBar.querySelector('.prev-btn');
          const nextBtn = navBar.querySelector('.next-btn');

          // Build URL with nav context preserved (use returned context for random mode)
          const buildUrl = (id) => {
            const url = new URL(`/films/${id}`, window.location.origin);
            url.searchParams.set('nav_context', data.context);
            if (data.context !== 'random') {
              if (navBar.dataset.navId) url.searchParams.set('nav_id', navBar.dataset.navId);
              if (navBar.dataset.navSort) url.searchParams.set('nav_sort', navBar.dataset.navSort);
              if (navBar.dataset.navType) url.searchParams.set('nav_type', navBar.dataset.navType);
            }
            return url.toString();
          };

          if (data.prev_id && prevBtn) {
            prevBtn.href = buildUrl(data.prev_id);
            prevBtn.style.visibility = 'visible';
          }
          if (data.next_id && nextBtn) {
            const url = buildUrl(data.next_id);
            nextBtn.href = url;
            nextBtn.style.visibility = 'visible';
            nextUrl = url; // Store for autoplay
          }

          // Setup video player APIs for autoplay
          if (document.getElementById('youtube-player')) {
            // Load YouTube API if not already loaded
            if (typeof YT === 'undefined') {
              const tag = document.createElement('script');
              tag.src = 'https://www.youtube.com/iframe_api';
              document.head.appendChild(tag);
              window.onYouTubeIframeAPIReady = setupYouTubePlayer;
            } else {
              setupYouTubePlayer();
            }
          } else if (document.getElementById('vimeo-player')) {
            // Load Vimeo API if not already loaded
            if (typeof Vimeo === 'undefined') {
              const tag = document.createElement('script');
              tag.src = 'https://player.vimeo.com/api/player.js';
              tag.onload = setupVimeoPlayer;
              document.head.appendChild(tag);
            } else {
              setupVimeoPlayer();
            }
          } else if (document.getElementById('film-video-player')) {
            // Setup Video.js player for uploaded videos
            setupVideoJsPlayer();
          }
        })
        .catch(err => console.warn('Navigation fetch failed:', err));
    }, 1000);
  }

  // Run on both Turbo navigations and full page loads
  document.addEventListener('turbo:load', loadFilmNavigation);
  document.addEventListener('DOMContentLoaded', loadFilmNavigation);
})();
</script>

<%
  # Helper method for checking delete permissions
  def can_delete_comment?(user, film, comment)
    return false unless user
    film.filmers.include?(user) || film.filmer_user == user || film.editor_user == user
  end
%>
