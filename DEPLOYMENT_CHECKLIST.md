# StreetWatch Deployment Checklist

Quick reference for deploying StreetWatch with all performance optimizations enabled.

## âœ… Pre-Deployment Checklist

### 1. Code Optimizations (Complete)

- [x] Database indexes added and migrated
- [x] Films controller optimized with caching headers
- [x] Users controller optimized with eager loading
- [x] Caching configuration added
- [x] Background jobs implemented
- [x] Lazy load JavaScript controller added

### 2. Environment Setup

- [ ] `REDIS_URL` configured (see [REDIS_SETUP.md](REDIS_SETUP.md:1))
- [ ] Background job processor configured
- [ ] Production environment variables set:
  - [ ] `RAILS_ENV=production`
  - [ ] `SECRET_KEY_BASE` (auto-generated by Railway)
  - [ ] `DATABASE_URL` (auto-configured by Railway)
  - [ ] `REDIS_URL` (from Railway Redis plugin)

### 3. Cloudflare Configuration

- [ ] Domain pointed to Cloudflare nameservers
- [ ] SSL/TLS mode set to "Full (strict)"
- [ ] Page rules configured (see [CLOUDFLARE_SETUP.md](CLOUDFLARE_SETUP.md:1))
  - [ ] Admin pages: Bypass cache
  - [ ] API endpoints: Bypass cache
  - [ ] Films pages: Cache everything
  - [ ] User pages: Cache everything
  - [ ] Assets: Maximum cache
- [ ] Speed optimizations enabled:
  - [ ] Auto Minify (JS, CSS, HTML)
  - [ ] Brotli compression
  - [ ] Early Hints

## ðŸš€ Deployment Steps

### Railway Deployment

```bash
# 1. Commit all changes
git add .
git commit -m "Add performance optimizations"

# 2. Push to Railway
git push railway main

# 3. Watch deployment logs
railway logs
```

### Post-Deployment Verification

```bash
# 1. Check app is running
curl -I https://streetwatch.com

# 2. Verify Redis connection
railway run rails console
# Then in console:
Rails.cache.write('test', 'works')
Rails.cache.read('test')

# 3. Verify background jobs
railway run rails runner "IncrementViewCountJob.perform_now(Film.first.id)"

# 4. Check Cloudflare caching
curl -I https://streetwatch.com/films
# Look for: cf-cache-status: HIT
```

## ðŸ“Š Performance Monitoring

### Week 1: Baseline Metrics

Monitor these metrics in Cloudflare Analytics:

- **Cache Hit Rate**: Target >80%
- **Bandwidth Saved**: Should increase daily
- **Origin Requests**: Should decrease
- **Page Load Time**: Target <500ms for cached pages

### Ongoing Monitoring

- **Daily**: Check Railway dashboard for errors
- **Weekly**: Review Cloudflare analytics
- **Monthly**: Review cache performance and adjust TTLs if needed

## ðŸ”§ Maintenance Tasks

### Cache Purging

**When to purge**:
- Major deployment with UI changes
- Content updates that must appear immediately
- Bug fixes affecting cached pages

**How to purge**:
```bash
# Purge everything (use sparingly)
# Cloudflare Dashboard â†’ Caching â†’ Purge Cache â†’ Purge Everything

# Purge specific URL
# Use Cloudflare API or Dashboard â†’ Purge by URL
```

### Database Maintenance

```bash
# Check for slow queries
railway run rails runner "puts ActiveRecord::Base.connection.execute('EXPLAIN ANALYZE SELECT * FROM films ORDER BY created_at DESC LIMIT 18').values"

# Analyze database
railway run rails db:analyze
```

## ðŸ“ˆ Expected Performance Gains

### Before Optimizations

```
Films Index:
â”œâ”€ Database Queries: 15-20 queries
â”œâ”€ Query Time: 150-300ms
â”œâ”€ Page Load: 800-1200ms
â””â”€ Origin Load: 100%
```

### After Optimizations

```
Films Index (Cached):
â”œâ”€ Database Queries: 5-8 queries (eager loading)
â”œâ”€ Query Time: 30-50ms (indexes)
â”œâ”€ Page Load: 200-400ms (Cloudflare cache)
â””â”€ Origin Load: 20% (CDN caching)
```

**Net Result**: 60-75% faster load times, 80% less origin load

## ðŸš¨ Troubleshooting

### Site is slow despite caching

**Check**:
1. Cloudflare cache hit rate (should be >70%)
2. Redis connection (should show in logs)
3. Background jobs running (check Railway dashboard)

### Cache not working

**Check**:
1. Page Rules order in Cloudflare
2. SSL/TLS mode is "Full (strict)"
3. Session cookies not interfering with cache

### Background jobs not processing

**Check**:
1. `bin/jobs` process is running on Railway
2. Check logs: `railway logs | grep Job`
3. Verify Solid Queue tables exist

## ðŸ“š Documentation

- **Performance Optimizations**: [PERFORMANCE_OPTIMIZATIONS.md](PERFORMANCE_OPTIMIZATIONS.md:1)
- **Redis Setup**: [REDIS_SETUP.md](REDIS_SETUP.md:1)
- **Cloudflare Configuration**: [CLOUDFLARE_SETUP.md](CLOUDFLARE_SETUP.md:1)

## ðŸ†˜ Rollback Plan

If issues occur after deployment:

```bash
# 1. Revert to previous commit
git revert HEAD
git push railway main

# 2. Or rollback specific changes
git log --oneline
git revert COMMIT_HASH
git push railway main

# 3. Emergency: Bypass Cloudflare temporarily
# Cloudflare Dashboard â†’ DNS â†’ Toggle proxy status to "DNS only" (grey cloud)
```

## âœ… Success Criteria

Deployment is successful when:

- [ ] All routes return 200 OK
- [ ] Films index page loads in <500ms (cached)
- [ ] Cloudflare cache hit rate >70%
- [ ] No errors in Railway logs
- [ ] Background jobs processing (check view counts incrementing)
- [ ] Redis connection working (verified in console)

---

**Deployed by**: _______________
**Date**: _______________
**Notes**: _______________
